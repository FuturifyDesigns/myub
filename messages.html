<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, interactive-widget=resizes-content, maximum-scale=1.0, user-scalable=no">
    <title>Messages - MyUB</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=Sora:wght@600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="myub-utils.js"></script>
    
    <!-- OneSignal SDK -->
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    
    <style>
        /* ... (keep all existing CSS styles exactly as they are) ... */
    </style>
    
    <!-- Primary Meta Tags -->
    <meta name="title" content="Messages - MyUB | University of Botswana">
    <meta name="description" content="Direct messaging with your University of Botswana classmates. Stay connected with friends and study partners.">
    <meta name="keywords" content="MyUB, University of Botswana, UB, student portal, GPA calculator, study groups, student companion, Botswana education, UB students">
    <meta name="author" content="Futurify Designs">
    <meta name="robots" content="index, follow">
    <meta name="language" content="English">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://www.myub.online/">
    <meta property="og:title" content="Messages - MyUB | University of Botswana">
    <meta property="og:description" content="Direct messaging with your University of Botswana classmates. Stay connected with friends and study partners.">
    <meta property="og:image" content="https://www.myub.online/icons/og-image.jpg">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="1200">
    <meta property="og:site_name" content="MyUB">
    <meta property="og:locale" content="en_US">
    
    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://www.myub.online/">
    <meta name="twitter:title" content="Messages - MyUB | University of Botswana">
    <meta name="twitter:description" content="Direct messaging with your University of Botswana classmates. Stay connected with friends and study partners.">
    <meta name="twitter:image" content="https://www.myub.online/icons/og-image.jpg">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="mask-icon" href="icons/favicon-32x32.png" color="#1a365d">
    <meta name="msapplication-TileColor" content="#1a365d">
    <meta name="msapplication-TileImage" content="icons/icon-144x144.png">
    
    <!-- PWA -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1a365d">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="MyUB">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="https://www.myub.online/">

    <!-- OneSignal Setup - FIXED VERSION -->
    <script>
        // OneSignal initialization - same as dashboard
        window.OneSignalDeferred = window.OneSignalDeferred || [];
        OneSignalDeferred.push(async function(OneSignal) {
            try {
                await OneSignal.init({
                    appId: "a9e2b3a3-d0d6-4924-b6ea-70bc6c1a950e",
                    allowLocalhostAsSecureOrigin: true,
                    notifyButton: {
                        enable: false
                    }
                });
                
                // Store OneSignal instance globally
                window.OneSignal = OneSignal;
                
                // Check if user is logged in and set external user ID
                if (window.currentUser && window.currentUser.id) {
                    try {
                        await OneSignal.login(currentUser.id);
                        console.log('MyUB: OneSignal initialized for user:', currentUser.id);
                        
                        // Get and save the player ID
                        const playerId = await OneSignal.User.PushSubscription.id;
                        if (playerId && window.supabaseClient) {
                            supabaseClient.from('profiles').update({ onesignal_id: playerId }).eq('id', currentUser.id).then(({ error }) => {
                                if (error) console.error('MyUB: Failed to save OneSignal ID:', error);
                                else console.log('MyUB: OneSignal ID saved to profile');
                            });
                        }
                    } catch (loginError) {
                        console.error('MyUB: OneSignal login error:', loginError);
                    }
                }
                
                // Listen for subscription change
                OneSignal.on('subscriptionChange', async function(isSubscribed) {
                    console.log("MyUB: OneSignal subscription changed:", isSubscribed);
                    if (isSubscribed && window.currentUser && window.supabaseClient) {
                        try {
                            const playerId = await OneSignal.User.PushSubscription.id;
                            if (playerId) {
                                supabaseClient.from('profiles').update({ onesignal_id: playerId }).eq('id', currentUser.id).then(({ error }) => {
                                    if (error) console.error('MyUB: Failed to save OneSignal ID:', error);
                                });
                            }
                        } catch (error) {
                            console.error('MyUB: Error getting player ID:', error);
                        }
                    }
                });
                
            } catch (initError) {
                console.error('MyUB: OneSignal initialization error:', initError);
            }
        });
    </script>

</head>
<body>
    <div class="loading" id="loadingScreen"><div class="loading-spinner"></div></div>
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">                        <a href="dashboard.html" class="sidebar-logo">
                <div class="sidebar-logo-m-wrapper">
                    <svg class="sidebar-logo-cap" viewBox="0 0 100 70">
                        <polygon points="50,8 95,25 50,42 5,25" fill="#1a365d"/>
                        <circle cx="50" cy="25" r="5" fill="#ffffff" stroke="#1a365d" stroke-width="2"/>
                        <rect x="32" y="38" width="36" height="18" rx="3" fill="#1a365d"/>
                        <g class="tassel">
                            <circle cx="78" cy="25" r="4" fill="#c41e3a"/>
                            <path d="M78 29 Q82 45 80 55" stroke="#c41e3a" stroke-width="3" fill="none"/>
                            <ellipse cx="80" cy="58" rx="5" ry="8" fill="#c41e3a"/>
                        </g>
                    </svg>
                    <span class="sidebar-logo-m">M</span>
                </div>
                <span class="sidebar-logo-yub">yUB</span>
            </a></div>
        <nav>
            <div class="nav-section"><div class="nav-section-title">Menu</div><a href="dashboard.html" class="nav-item"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>Dashboard</a><a href="gpa-calculator.html" class="nav-item"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>GPA Calculator</a><a href="schedule.html" class="nav-item"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>Schedule</a><a href="notes.html" class="nav-item"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>Notes</a></div>
            <div class="nav-section"><div class="nav-section-title">Social</div><a href="study-groups.html" class="nav-item"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>Study Groups</a><a href="messages.html" class="nav-item active"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>Messages<span class="badge" id="sidebarMsgBadge" style="display:none;">0</span></a><a href="friends.html" class="nav-item"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>Friends<span class="badge" id="sidebarFriendsBadge" style="display:none;">0</span></a></div>
            <div class="nav-section"><div class="nav-section-title">Account</div><a href="profile.html" class="nav-item"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>Profile</a><button class="nav-item" onclick="handleLogout()"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>Sign Out</button></div>
        </nav>
    </aside>
    <main class="main-content" id="mainContent" style="display: none;">
        <header class="topbar"><div class="topbar-left"><button class="menu-toggle" onclick="toggleSidebar()">‚ò∞</button><h1 class="page-title">Messages</h1></div><div class="topbar-right"><div class="notification-wrapper"><button class="icon-btn" onclick="toggleNotifications(event)"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/></svg><span class="notification-badge" id="notifBadge" style="display: none;">0</span></button><div class="notification-dropdown" id="notificationDropdown"><div class="notif-dropdown-header"><h3>Notifications</h3><button onclick="markAllNotificationsRead()">Mark all read</button></div><div class="notif-dropdown-list" id="notifList"></div><div class="notif-dropdown-footer"><a onclick="openNotificationsModal()" style="cursor:pointer;">View All Notifications</a></div></div></div><button class="new-chat-btn" onclick="openNewChatModal()" title="New Chat"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 4v16m8-8H4"/></svg></button></div></header>
        <div class="messages-container">
            <div class="conversations-panel" id="conversationsPanel"><div class="conversations-header"><h2>Messages</h2><div style="display:flex;gap:8px;align-items:center;"><div class="notification-wrapper" style="position:relative;"><button class="new-chat-btn" onclick="toggleNotifications(event)" title="Notifications" style="background:var(--gray-100);"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" style="color:var(--gray-600);"><path d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/></svg><span class="notification-badge" id="notifBadge3" style="display:none;position:absolute;top:-4px;right:-4px;background:var(--red);color:white;font-size:10px;font-weight:700;padding:2px 6px;border-radius:10px;min-width:16px;text-align:center;">0</span></button><div class="notification-dropdown" id="notificationDropdown3" style="z-index:9999;"><div class="notif-dropdown-header"><h3>Notifications</h3><button onclick="markAllNotificationsRead()">Mark all read</button></div><div class="notif-dropdown-list" id="notifList3"></div><div class="notif-dropdown-footer"><a onclick="openNotificationsModal()" style="cursor:pointer;">View All Notifications</a></div></div></div><button class="new-chat-btn" onclick="openNewChatModal()" title="New Chat"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 4v16m8-8H4"/></svg></button></div></div><div class="conversations-search"><input type="text" class="search-input" id="convSearch" placeholder="Search conversations..." oninput="filterConversations()"></div><div class="conversations-list" id="conversationsList"></div></div>
            <div class="chat-panel" id="chatPanel">
                <div class="selection-header" id="selectionHeader"><span class="selection-count" id="selectionCount">0 selected</span><div class="selection-actions"><button class="selection-btn report" onclick="reportSelectedMessages()"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>Report</button><button class="selection-btn forward" onclick="openForwardModal()"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M13 5l7 7-7 7M5 5l7 7-7 7"/></svg>Forward</button><button class="selection-btn delete" onclick="deleteSelectedMessages()"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>Delete</button><button class="selection-btn cancel" onclick="exitSelectionMode()">Cancel</button></div></div>
                <div class="chat-header" id="chatHeader" style="display: none;"><button class="chat-header-back" onclick="backToConversations()"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M15 19l-7-7 7-7"/></svg></button><div class="chat-user-info" onclick="viewUserProfile()"><div class="chat-avatar" id="chatAvatar"><span id="chatAvatarText">--</span><div class="online-dot" id="chatOnlineDot"></div></div><div class="chat-user-details"><h3 id="chatUserName">Loading...</h3><div class="chat-user-status" id="chatUserStatus">Online</div></div></div><div class="chat-header-actions"><button class="chat-action-btn" onclick="startVideoCall()" title="Video Call"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg></button><button class="chat-action-btn" onclick="startVoiceCall()" title="Voice Call"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg></button><button class="chat-action-btn" onclick="enterSelectionMode()" title="Select"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/></svg></button><div style="position: relative;"><button class="chat-action-btn" onclick="toggleChatMenu(event)"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"/></svg></button><div class="dropdown-menu" id="chatMenu"><div class="dropdown-item" onclick="viewUserProfile()"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>View Profile</div><div class="dropdown-item" onclick="clearConversation()"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>Clear Chat</div><div class="dropdown-item danger" onclick="deleteConversation()"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"/></svg>Delete Conversation</div></div></div></div></div>
                <div class="chat-blocked" id="chatBlocked" style="display: none;"><p id="blockedMessage">You cannot send messages to this user.</p></div>
                <div class="chat-messages" id="chatMessages"></div>
                <div class="reply-bar" id="replyBar"><div class="reply-bar-content"><div class="reply-bar-name" id="replyBarName">Replying to User</div><div class="reply-bar-text" id="replyBarText">Message preview...</div></div><button class="reply-bar-close" onclick="cancelReply()"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12"/></svg></button></div>
                <div class="chat-input-area" id="chatInputArea" style="display: none;"><button class="emoji-btn" onclick="toggleEmojiPicker(event)"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg><div class="emoji-picker" id="emojiPicker"></div></button><div class="chat-input-wrapper"><textarea class="chat-input" id="messageInput" placeholder="Type a message..." rows="1" oninput="autoResize(this)"></textarea></div><button class="send-btn" id="sendBtn" onclick="sendMessage()" disabled><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg></button></div>
                <div class="chat-empty" id="chatEmpty"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg><h3>Select a conversation</h3><p>Choose a conversation or start a new chat</p></div>
            </div>
        </div>
    </main>
    <div class="modal-overlay" id="forwardModal"><div class="modal"><div class="modal-header"><h3 class="modal-title">Forward Messages</h3><button class="modal-close" onclick="closeForwardModal()"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12"/></svg></button></div><div class="modal-body" id="forwardUserList"></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeForwardModal()">Cancel</button><button class="btn btn-primary" id="forwardBtn" onclick="forwardMessages()" disabled>Forward</button></div></div></div>
    <div class="modal-overlay" id="reportModal"><div class="modal"><div class="modal-header"><h3 class="modal-title">Report Messages</h3><button class="modal-close" onclick="closeReportModal()"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12"/></svg></button></div><div class="modal-body"><p style="color: var(--gray-600); margin-bottom: 16px; font-size: 14px;">Report inappropriate messages to keep MyUB safe.</p><div class="form-group"><label class="form-label">Reason</label><select class="form-select" id="reportReason"><option value="">Select a reason...</option><option value="spam">Spam</option><option value="harassment">Harassment</option><option value="hate_speech">Hate speech</option><option value="inappropriate_content">Inappropriate content</option><option value="threatening_violence">Threatening violence</option><option value="other">Other</option></select></div><div class="form-group"><label class="form-label">Additional details</label><textarea class="form-textarea" id="reportDescription" placeholder="Provide context..." rows="3"></textarea></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeReportModal()">Cancel</button><button class="btn btn-danger" onclick="submitReport()">Submit Report</button></div></div></div>
    <div class="modal-overlay" id="confirmModal"><div class="modal" style="max-width: 360px;"><div class="modal-header"><h3 class="modal-title" id="confirmTitle">Confirm</h3><button class="modal-close" onclick="closeConfirmModal()"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12"/></svg></button></div><div class="modal-body"><p id="confirmMessage" style="text-align: center; color: var(--gray-600);">Are you sure?</p></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeConfirmModal()">Cancel</button><button class="btn btn-danger" onclick="confirmAction()">Confirm</button></div></div></div>
    
    <!-- New Chat Modal -->
    <div class="modal-overlay" id="newChatModal">
        <div class="modal" style="max-width: 480px;">
            <div class="modal-header"><h3 class="modal-title">New Chat</h3><button class="modal-close" onclick="closeNewChatModal()"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12"/></svg></button></div>
            <div class="modal-body" style="padding: 0;">
                <div class="new-chat-search"><input type="text" class="search-input" id="userSearchInput" placeholder="Search users by name or program..." oninput="searchUsers()"></div>
                <div class="new-chat-results" id="userSearchResults"><div class="search-placeholder"><svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg><p>Search for users to start a conversation</p></div></div>
            </div>
        </div>
    </div>

    <!-- Profile Preview Modal -->
    <div class="modal-overlay" id="profileModal">
        <div class="modal" style="max-width: 420px;">
            <div class="modal-header"><h3 class="modal-title">Profile</h3><button class="modal-close" onclick="closeProfileModal()"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12"/></svg></button></div>
            <div class="modal-body" id="profileModalBody"></div>
            <div class="modal-footer" id="profileModalFooter"></div>
        </div>
    </div>

    <!-- User Report Modal -->
    <div class="modal-overlay" id="userReportModal">
        <div class="modal">
            <div class="modal-header"><h3 class="modal-title">Report User</h3><button class="modal-close" onclick="closeUserReportModal()"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12"/></svg></button></div>
            <div class="modal-body">
                <p style="color: var(--gray-600); margin-bottom: 16px; font-size: 14px;">Report this user for violating community guidelines.</p>
                <div class="form-group"><label class="form-label">Reason</label><select class="form-select" id="userReportReason"><option value="">Select a reason...</option><option value="spam">Spam or fake account</option><option value="harassment">Harassment or bullying</option><option value="hate_speech">Hate speech</option><option value="inappropriate_content">Inappropriate content</option><option value="impersonation">Impersonation</option><option value="threatening_violence">Threatening violence</option><option value="other">Other</option></select></div>
                <div class="form-group"><label class="form-label">Additional details</label><textarea class="form-textarea" id="userReportDescription" placeholder="Provide context..." rows="3"></textarea></div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeUserReportModal()">Cancel</button><button class="btn btn-danger" onclick="submitUserReport()">Submit Report</button></div>
        </div>
    </div>
    
    <!-- All Notifications Modal -->
    <div class="modal-overlay" id="notificationsModal" onclick="if(event.target===this)closeNotificationsModal()">
        <div class="modal" style="max-width:500px;max-height:80vh;display:flex;flex-direction:column;">
            <div class="modal-header"><h3 class="modal-title">All Notifications</h3><button class="modal-close" onclick="closeNotificationsModal()"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12"/></svg></button></div>
            <div style="display:flex;gap:10px;padding:16px 24px;border-bottom:1px solid var(--gray-200);">
                <button class="btn btn-secondary" onclick="markAllNotificationsReadModal()">Mark All Read</button>
                <button class="btn" style="background:#fee2e2;color:#dc2626;border:1px solid #fecaca;" onclick="clearAllNotifications()">Clear All</button>
            </div>
            <div class="modal-body" id="allNotifList" style="flex:1;overflow-y:auto;padding:0;"></div>
        </div>
    </div>
    
    <div class="toast" id="toast"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M5 13l4 4L19 7"/></svg><span id="toastMessage">Success!</span></div>
    <script>
        const SUPABASE_URL = 'https://weuxtwmaqmbhskjpjdyi.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndldXh0d21hcW1iaHNranBqZHlpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3NTYzMTcsImV4cCI6MjA4MDMzMjMxN30.J-0Nd0MY6-g_ltbBNHwOulqZuQfb8mKIRgx0dAaJ76o';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const EMOJIS = ['üòÄ','üòÇ','üòä','üòç','ü•∞','üòé','ü§î','üòÆ','üò¢','üò°','üëç','üëé','‚ù§Ô∏è','üî•','‚≠ê','üéâ','üíØ','üôå','üëè','üí™','ü§ù','üôè','‚ú®','üí°','üìö','‚úÖ','‚ùå','‚ö†Ô∏è','üí¨','üìù'];

        let currentUser = null, conversations = [], currentConversation = null, currentChatUser = null;
        let messages = [], notifications = [], friends = [], blockedUsers = [], blockedByUsers = [];
        let selectedMessages = new Set(), isSelectionMode = false, confirmCallback = null, forwardToUsers = new Set();
        let friendIds = [], outgoingRequestIds = [], incomingRequestIds = [];
        let selectedProfileUser = null;
        
        // Notification sound with higher volume
        const notificationSound = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2teleVlhjtXr4JlYMTlqqdTm2I1LIzWFxevnvGw8KVmW1+3iomA4M2yq2erem1AkLnayz/Dgo2I2L2qm1ebgjU4pOIK+3eTCaz0nVprU5d6RUSktiL/i58mFWDQ4daTU4NqJSyQshL7j5sSAUjI1cZ/Q3dWFSiYvgbzh5L5+Ty42bpzO2tKBRyUsgrrg4rx7TS00a5nL1s5+RiQrfbff4bh4Sis0Z5XI0sl7RSMpcbTZ3LFyRSgzYY/Cyr51QiIldLHW2a5vQicyXoy/x7pzQCEjca3T1qprPyYwW4m8xLdxPyAhbqrQz6RmPiUuWIa5wa1sPR8fa6bMzqFkPCQsVYO2wKpqOx4daKLIypxhOyMrUn+zvqZnOhwbZZ7Fx5hfOSIpT3yxvKNkOBsZYprCw5VcNyEnS3muuZ5hNhkYX5a/wJJaNiAlSHaqtppeMxgWXJK8vY9YNCAfQ3GmspVaMBcVWY65uoxWMyAdQG6jrpFWLhUUV4q1t4lTMh8cPmufrI1SLBQTVIaysoZQMRscPGebqIlOKhITV4OuqH5JLRkaNmCVo4RJKBETVYCqpHtGKxgYNF2SmYBGJhASU32no3hDKRYXMlqPlHxDJRAQUHqjnnU/JhUWMFeNkHk/Ig4PUXennXI9JBMULlOKjHY8IA0OUXWS');
        notificationSound.volume = 0.3;

        function initEmojiPicker() {
            const picker = document.getElementById('emojiPicker');
            if (!picker) return;
            let html = '<div class="emoji-grid">';
            EMOJIS.forEach(e => { html += '<div class="emoji-item" onclick="insertEmoji(\'' + e + '\')">' + e + '</div>'; });
            html += '</div>';
            picker.innerHTML = html;
        }
        
        function toggleEmojiPicker(e) {
            if (e) e.stopPropagation();
            const picker = document.getElementById('emojiPicker');
            picker.classList.toggle('show');
        }
        
        function insertEmoji(emoji) {
            const input = document.getElementById('messageInput');
            const start = input.selectionStart;
            const end = input.selectionEnd;
            const text = input.value;
            input.value = text.substring(0, start) + emoji + text.substring(end);
            input.selectionStart = input.selectionEnd = start + emoji.length;
            input.focus();
            document.getElementById('sendBtn').disabled = !input.value.trim();
        }

        let deletedConversations = {}; // Map of other_user_id -> deleted_at timestamp
        let replyToMessage = null; // Message being replied to

        async function init() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) { window.location.href = 'index.html'; return; }
            currentUser = session.user;
            
            // Check if user is banned
            const { data: profile } = await supabaseClient.from('profiles').select('is_banned').eq('id', currentUser.id).single();
            if (profile && profile.is_banned) {
                await supabaseClient.auth.signOut();
                alert('Your account has been suspended. Please contact an administrator.');
                window.location.href = 'index.html';
                return;
            }
            
            // Initialize connection manager (checks server capacity)
            if (window.MyUBUtils) {
                const canConnect = await MyUBUtils.ConnectionManager.init(supabaseClient, currentUser.id);
                if (!canConnect) {
                    document.getElementById('loadingScreen').style.display = 'none';
                    return; // User in queue
                }
                // Use consolidated subscriptions
                MyUBUtils.SubscriptionManager.init(supabaseClient, currentUser.id);
                MyUBUtils.SubscriptionManager.subscribe({
                    messages: () => { loadConversations(); loadSidebarFriendsBadge(); },
                    notifications: () => loadNotifications(),
                    friend_requests: () => { loadFriendRequests(); loadSidebarFriendsBadge(); }
                });
            }
            
            if (localStorage.getItem('myub_darkMode') === 'true') document.body.classList.add('dark-mode');
            await updateOnlineStatus(true);
            await loadDeletedConversations();
            await Promise.all([loadConversations(), loadFriends(), loadBlockedUsers(), loadNotifications(), loadFriendRequests(), loadSidebarFriendsBadge()]);
            subscribeToRealtime(); // Setup real-time subscriptions
            startHeartbeat();
            startNotificationPolling(); // Poll for notifications as fallback
            initEmojiPicker();
            
            // Initialize OneSignal after user is authenticated - FIXED
            if (window.OneSignal && currentUser && currentUser.id) {
                try {
                    await window.OneSignal.login(currentUser.id);
                    console.log('MyUB: OneSignal initialized for user:', currentUser.id);
                    
                    // Get and save the player ID
                    const playerId = await window.OneSignal.User.PushSubscription.id;
                    if (playerId) {
                        supabaseClient.from('profiles').update({ onesignal_id: playerId }).eq('id', currentUser.id).then(({ error }) => {
                            if (error) console.error('MyUB: Failed to save OneSignal ID:', error);
                            else console.log('MyUB: OneSignal ID saved to profile');
                        });
                    }
                } catch (error) {
                    console.error('MyUB: OneSignal initialization error:', error);
                }
            }
            
            const urlParams = new URLSearchParams(window.location.search);
            const userId = urlParams.get('user');
            if (userId) await openConversation(userId);
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('mainContent').style.display = 'flex';
            document.addEventListener('click', handleOutsideClick);
            document.getElementById('messageInput').addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });
        }
        
        function startNotificationPolling() {
            setInterval(async () => {
                const lastNotifId = notifications.length > 0 ? notifications[0].id : null;
                const { data: newNotifs } = await supabaseClient.from('notifications').select('*').eq('user_id', currentUser.id).order('created_at', { ascending: false }).limit(5);
                if (newNotifs && newNotifs.length > 0 && (!lastNotifId || newNotifs[0].id !== lastNotifId)) {
                    const existingIds = notifications.map(n => n.id);
                    const trulyNew = newNotifs.filter(n => !existingIds.includes(n.id));
                    if (trulyNew.length > 0) {
                        trulyNew.forEach(n => notifications.unshift(n));
                        renderNotifications();
                        playNotificationSound();
                        showToast(trulyNew[0].title || 'New notification', 'success');
                    }
                }
            }, 30000);
        }

        async function updateOnlineStatus(isOnline) { await supabaseClient.from('profiles').update({ is_online: isOnline, last_seen: new Date().toISOString() }).eq('id', currentUser.id); }
        function startHeartbeat() { setInterval(() => updateOnlineStatus(true), 30000); window.addEventListener('beforeunload', () => updateOnlineStatus(false)); }

        async function loadDeletedConversations() {
            const { data } = await supabaseClient.from('deleted_conversations').select('other_user_id, deleted_at').eq('user_id', currentUser.id);
            deletedConversations = {};
            (data || []).forEach(d => { 
                // Store as timestamp for consistent comparison
                deletedConversations[d.other_user_id] = new Date(d.deleted_at).getTime(); 
            });
        }

        async function loadConversations() {
            // Reload deleted conversations to ensure we have latest data
            await loadDeletedConversations();
            
            const { data: sentMsgs } = await supabaseClient.from('messages').select('receiver_id, content, created_at, is_read').eq('sender_id', currentUser.id).is('group_id', null).neq('is_deleted', true).order('created_at', { ascending: false });
            const { data: receivedMsgs } = await supabaseClient.from('messages').select('sender_id, content, created_at, is_read').eq('receiver_id', currentUser.id).is('group_id', null).neq('is_deleted', true).order('created_at', { ascending: false });
            const convMap = new Map();
            
            // Process sent messages - filter by deleted timestamp
            (sentMsgs || []).forEach(msg => { 
                const oderId = msg.receiver_id; 
                const deletedAt = deletedConversations[oderId];
                const msgTime = new Date(msg.created_at).getTime();
                // Skip if message was created before or at deletion time
                if (deletedAt && msgTime <= deletedAt) return;
                
                if (!convMap.has(oderId) || new Date(msg.created_at) > new Date(convMap.get(oderId).lastMessageTime)) 
                    convMap.set(oderId, { oderId, lastMessage: msg.content, lastMessageTime: msg.created_at, unreadCount: convMap.get(oderId)?.unreadCount || 0 }); 
            });
            
            // Process received messages - filter by deleted timestamp
            (receivedMsgs || []).forEach(msg => { 
                const oderId = msg.sender_id; 
                const deletedAt = deletedConversations[oderId];
                const msgTime = new Date(msg.created_at).getTime();
                // Skip if message was created before or at deletion time
                if (deletedAt && msgTime <= deletedAt) return;
                
                const existing = convMap.get(oderId); 
                const unreadCount = (existing?.unreadCount || 0) + (msg.is_read ? 0 : 1); 
                if (!existing || new Date(msg.created_at) > new Date(existing.lastMessageTime)) 
                    convMap.set(oderId, { oderId, lastMessage: msg.content, lastMessageTime: msg.created_at, unreadCount }); 
                else if (existing) existing.unreadCount = unreadCount; 
            });
            
            const userIds = Array.from(convMap.keys());
            if (userIds.length > 0) { const { data: profiles } = await supabaseClient.from('profiles').select('id, first_name, last_name, full_name, avatar_url, is_online, last_seen').in('id', userIds); conversations = Array.from(convMap.values()).map(conv => { const profile = profiles?.find(p => p.id === conv.oderId); return { ...conv, user: profile }; }).filter(c => c.user).sort((a, b) => new Date(b.lastMessageTime) - new Date(a.lastMessageTime)); }
            else conversations = [];
            renderConversations(); updateUnreadBadge();
        }

        async function loadFriends() {
            const { data: f1 } = await supabaseClient.from('friendships').select('friend_id').eq('user_id', currentUser.id);
            const { data: f2 } = await supabaseClient.from('friendships').select('user_id').eq('friend_id', currentUser.id);
            const ids = [...(f1||[]).map(f => f.friend_id), ...(f2||[]).map(f => f.user_id)];
            friendIds = ids; // Update global friendIds
            if (ids.length > 0) { const { data: profiles } = await supabaseClient.from('profiles').select('id, first_name, last_name, full_name, avatar_url, is_online').in('id', ids); friends = profiles || []; }
            else friends = [];
        }

        async function loadBlockedUsers() {
            const { data: blocked } = await supabaseClient.from('blocked_users').select('blocked_id').eq('blocker_id', currentUser.id);
            blockedUsers = (blocked || []).map(b => b.blocked_id);
            const { data: blockedBy } = await supabaseClient.from('blocked_users').select('blocker_id').eq('blocked_id', currentUser.id);
            blockedByUsers = (blockedBy || []).map(b => b.blocker_id);
        }

        async function loadFriendRequests() {
            const { data: outgoing } = await supabaseClient.from('friend_requests').select('receiver_id').eq('sender_id', currentUser.id).eq('status', 'pending');
            outgoingRequestIds = (outgoing || []).map(r => r.receiver_id);
            const { data: incoming } = await supabaseClient.from('friend_requests').select('sender_id').eq('receiver_id', currentUser.id).eq('status', 'pending');
            incomingRequestIds = (incoming || []).map(r => r.sender_id);
        }

        async function loadMessages(userId) {
            // Check if conversation was deleted - only show messages after deletion time
            const deletedAt = deletedConversations[userId];
            let query = supabaseClient.from('messages').select('*')
                .or(`and(sender_id.eq.${currentUser.id},receiver_id.eq.${userId}),and(sender_id.eq.${userId},receiver_id.eq.${currentUser.id})`)
                .is('group_id', null)
                .order('created_at', { ascending: true });
            
            // If conversation was deleted, only get messages after that time
            if (deletedAt) {
                // Convert timestamp back to ISO string for query
                const deletedAtISO = new Date(deletedAt).toISOString();
                query = query.gt('created_at', deletedAtISO);
            }
            
            const { data } = await query;
            messages = data || []; 
            renderMessages();
            await supabaseClient.from('messages').update({ is_read: true }).eq('sender_id', userId).eq('receiver_id', currentUser.id).eq('is_read', false);
            const conv = conversations.find(c => c.oderId === userId); if (conv) conv.unreadCount = 0;
            renderConversations(); updateUnreadBadge();
        }

        function renderConversations() {
            const container = document.getElementById('conversationsList');
            const searchQuery = document.getElementById('convSearch').value.toLowerCase();
            const filtered = conversations.filter(c => { if (!c.user) return false; const name = (c.user.full_name || `${c.user.first_name} ${c.user.last_name}`).toLowerCase(); return name.includes(searchQuery); });
            if (filtered.length === 0) { container.innerHTML = `<div class="conversations-empty"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg><h3>${searchQuery ? 'No conversations found' : 'No messages yet'}</h3><p>${searchQuery ? 'Try a different search' : 'Start chatting with friends!'}</p></div>`; return; }
            container.innerHTML = filtered.map(conv => { const user = conv.user; const name = user.full_name || `${user.first_name} ${user.last_name}`; const initials = getInitials(name); const isActive = currentChatUser?.id === user.id; const timeStr = formatConvTime(conv.lastMessageTime); return `<div class="conversation-item ${isActive ? 'active' : ''} ${conv.unreadCount > 0 ? 'unread' : ''}" onclick="openConversation('${user.id}')"><div class="conv-avatar">${user.avatar_url ? `<img src="${user.avatar_url}" alt="">` : initials}<div class="conv-online ${user.is_online ? '' : 'offline'}"></div></div><div class="conv-info"><div class="conv-name">${escapeHtml(name)}</div><div class="conv-preview">${escapeHtml(truncate(conv.lastMessage, 35))}</div></div><div class="conv-meta"><div class="conv-time">${timeStr}</div>${conv.unreadCount > 0 ? `<div class="conv-unread-badge">${conv.unreadCount}</div>` : ''}</div></div>`; }).join('');
        }

        function renderMessages() {
            const container = document.getElementById('chatMessages');
            if (messages.length === 0) { container.innerHTML = '<div style="text-align:center;padding:40px;color:var(--gray-400);">No messages yet. Say hello! üëã</div>'; return; }
            let html = '', lastDate = null;
            messages.forEach(msg => {
                const msgDate = new Date(msg.created_at).toDateString();
                if (msgDate !== lastDate) { html += `<div class="chat-date-divider"><span>${formatDateDivider(msg.created_at)}</span></div>`; lastDate = msgDate; }
                const isSent = msg.sender_id === currentUser.id, isSelected = selectedMessages.has(msg.id), time = formatMessageTime(msg.created_at);
                
                // Check if this message is a reply
                let replyHtml = '';
                if (msg.reply_to_id) {
                    const repliedMsg = messages.find(m => m.id === msg.reply_to_id);
                    if (repliedMsg) {
                        const repliedName = repliedMsg.sender_id === currentUser.id ? 'You' : (currentChatUser?.first_name || 'User');
                        replyHtml = `<div class="reply-preview" onclick="scrollToMessage('${msg.reply_to_id}')"><div class="reply-preview-name">${escapeHtml(repliedName)}</div><div class="reply-preview-text">${escapeHtml(truncate(repliedMsg.content, 50))}</div></div>`;
                    }
                }
                
                html += `<div class="message-row ${isSent ? 'sent' : 'received'}" data-id="${msg.id}">
                    <div class="message-select ${isSelectionMode ? 'show' : ''} ${isSelected ? 'checked' : ''}" onclick="toggleMessageSelect('${msg.id}')"></div>
                    <div class="message-wrapper">
                        ${!isSent ? `<div class="message-avatar">${currentChatUser?.avatar_url ? `<img src="${currentChatUser.avatar_url}">` : getInitials(currentChatUser?.full_name || currentChatUser?.first_name || 'U')}</div>` : ''}
                        <div class="message-bubble ${isSelected ? 'selected' : ''}" onclick="handleMessageClick(event, '${msg.id}')">
                            <div class="message-actions">
                                <button class="message-action-btn" onclick="event.stopPropagation(); setReply('${msg.id}')" title="Reply"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"/></svg></button>
                            </div>
                            ${replyHtml}
                            ${!isSent ? `<div class="message-sender">${escapeHtml(currentChatUser?.first_name || 'User')}</div>` : ''}
                            <div class="message-text">${escapeHtml(msg.content)}</div>
                            <div class="message-meta">
                                <span class="message-time">${time}</span>
                                ${isSent ? `<span class="message-status">${msg.is_read ? '‚úì‚úì' : '‚úì'}</span>` : ''}
                            </div>
                        </div>
                    </div>
                </div>`;
            });
            container.innerHTML = html; container.scrollTop = container.scrollHeight;
        }

        function filterConversations() { renderConversations(); }

        async function openConversation(userId) {
            // Reload deleted conversations to ensure we have latest data
            await loadDeletedConversations();
            
            const { data: user } = await supabaseClient.from('profiles').select('id, first_name, last_name, full_name, avatar_url, is_online, last_seen').eq('id', userId).single();
            if (!user) { showToast('User not found', 'error'); return; }
            currentChatUser = user; currentConversation = userId;
            const name = user.full_name || `${user.first_name} ${user.last_name}`;
            document.getElementById('chatUserName').textContent = name;
            const avatarEl = document.getElementById('chatAvatar');
            avatarEl.innerHTML = user.avatar_url ? `<img src="${user.avatar_url}" alt=""><div class="online-dot ${user.is_online ? '' : 'offline'}"></div>` : `<span>${getInitials(name)}</span><div class="online-dot ${user.is_online ? '' : 'offline'}"></div>`;
            const statusEl = document.getElementById('chatUserStatus');
            statusEl.textContent = user.is_online ? 'Online' : (user.last_seen ? `Last seen ${formatTimeAgo(user.last_seen)}` : 'Offline');
            statusEl.className = 'chat-user-status' + (user.is_online ? '' : ' offline');
            const isBlocked = blockedUsers.includes(userId), isBlockedBy = blockedByUsers.includes(userId);
            if (isBlocked || isBlockedBy) { document.getElementById('chatBlocked').style.display = 'block'; document.getElementById('blockedMessage').textContent = isBlocked ? 'You blocked this user.' : 'You cannot message this user.'; document.getElementById('chatInputArea').style.display = 'none'; }
            else { document.getElementById('chatBlocked').style.display = 'none'; document.getElementById('chatInputArea').style.display = 'flex'; }
            document.getElementById('chatEmpty').style.display = 'none'; document.getElementById('chatHeader').style.display = 'flex'; document.getElementById('chatMessages').style.display = 'flex';
            document.getElementById('conversationsPanel').classList.add('hidden'); document.getElementById('chatPanel').classList.add('show');
            await loadMessages(userId); renderConversations(); exitSelectionMode();
        }

        function backToConversations() { document.getElementById('conversationsPanel').classList.remove('hidden'); document.getElementById('chatPanel').classList.remove('show'); currentConversation = null; currentChatUser = null; }

        // ========== CALLING FUNCTIONS ==========
        function startVideoCall() {
            if (!currentConversation || !currentChatUser) {
                showToast('Please select a conversation first', 'error');
                return;
            }
            
            if (window.MyUBCalls && window.MyUBCalls.startCall) {
                window.MyUBCalls.startCall(currentConversation, currentChatUser.full_name, 'video');
            } else {
                showToast('Calling feature is loading...', 'info');
            }
        }
        
        function startVoiceCall() {
            if (!currentConversation || !currentChatUser) {
                showToast('Please select a conversation first', 'error');
                return;
            }
            
            if (window.MyUBCalls && window.MyUBCalls.startCall) {
                window.MyUBCalls.startCall(currentConversation, currentChatUser.full_name, 'voice');
            } else {
                showToast('Calling feature is loading...', 'info');
            }
        }

        // ========== VALIDATION ==========
        const badWords = ['fuck', 'shit', 'ass', 'bitch', 'damn', 'crap', 'piss', 'dick', 'cock', 'pussy', 'asshole', 'bastard', 'slut', 'whore', 'nigger', 'nigga', 'fag', 'faggot', 'retard', 'cunt', 'twat', 'wanker', 'bollocks', 'arse', 'motherfucker', 'fucker'];
        function containsBadWords(text) { if (!text) return false; const lower = text.toLowerCase(); return badWords.some(word => new RegExp('\\b' + word + '\\b', 'i').test(lower)); }
        
        async function sendMessage() {
            const input = document.getElementById('messageInput'), content = input.value.trim();
            if (!content || !currentConversation) return;
            if (blockedUsers.includes(currentConversation) || blockedByUsers.includes(currentConversation)) { showToast('Cannot message this user', 'error'); return; }
            
            // Validate message content
            if (content.length > 5000) { showToast('Message is too long (max 5000 characters)', 'error'); return; }
            if (containsBadWords(content)) { showToast('Message contains inappropriate language', 'error'); return; }
            
            try {
                const msgData = { sender_id: currentUser.id, receiver_id: currentConversation, content, message_type: 'text' };
                if (replyToMessage) msgData.reply_to_id = replyToMessage.id;
                
                const { data, error } = await supabaseClient.from('messages').insert(msgData).select().single();
                if (error) throw error;
                input.value = ''; input.style.height = 'auto'; document.getElementById('sendBtn').disabled = true;
                cancelReply();
                messages.push(data); renderMessages(); await loadConversations();
                
                // Send push notification via Cloudflare Worker
                try {
                    const senderProfile = await supabaseClient.from('profiles').select('full_name').eq('id', currentUser.id).single();
                    const senderName = senderProfile.data?.full_name || 'Someone';
                    const preview = content.length > 50 ? content.substring(0, 50) + "..." : content;
                    
                    // Call Cloudflare Worker to send OneSignal notification
                    const notifResponse = await fetch('https://myub-push-notifications.futurifydesigns.workers.dev', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            userId: currentConversation,
                            title: senderName,
                            body: preview,
                            data: {
                                type: 'message',
                                senderId: currentUser.id,
                                conversationId: currentUser.id,
                                url: '/messages.html?conversation=' + currentUser.id
                            }
                        })
                    });
                    
                    if (notifResponse.ok) {
                        console.log('MyUB: Push notification sent via OneSignal');
                    } else {
                        const errorData = await notifResponse.json();
                        console.error('MyUB: Push notification failed:', errorData);
                    }
                } catch (notifError) {
                    console.error('MyUB: Notification error:', notifError);
                }
                
                await supabaseClient.from('notifications').insert({ user_id: currentConversation, type: 'message', title: 'New Message', body: content.substring(0, 50) });
            } catch (e) { showToast('Failed to send', 'error'); }
        }
        
        // Reply functions
        function setReply(msgId) {
            const msg = messages.find(m => m.id === msgId);
            if (!msg) return;
            replyToMessage = msg;
            const name = msg.sender_id === currentUser.id ? 'You' : (currentChatUser?.first_name || 'User');
            document.getElementById('replyBarName').textContent = name;
            document.getElementById('replyBarText').textContent = truncate(msg.content, 60);
            document.getElementById('replyBar').classList.add('show');
            document.getElementById('messageInput').focus();
        }
        
        function cancelReply() {
            replyToMessage = null;
            document.getElementById('replyBar').classList.remove('show');
        }
        
        function scrollToMessage(msgId) {
            const msgEl = document.querySelector(`[data-id="${msgId}"]`);
            if (msgEl) {
                msgEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                msgEl.querySelector('.message-bubble').style.background = 'var(--blue-light)';
                setTimeout(() => {
                    const bubble = msgEl.querySelector('.message-bubble');
                    if (msgEl.classList.contains('sent')) bubble.style.background = 'var(--navy)';
                    else bubble.style.background = 'var(--white)';
                }, 1500);
            }
        }

        function autoResize(el) { el.style.height = 'auto'; el.style.height = Math.min(el.scrollHeight, 120) + 'px'; document.getElementById('sendBtn').disabled = !el.value.trim(); }

        function enterSelectionMode() { isSelectionMode = true; selectedMessages.clear(); document.getElementById('selectionHeader').classList.add('show'); document.getElementById('chatHeader').style.display = 'none'; updateSelectionCount(); renderMessages(); }
        function exitSelectionMode() { isSelectionMode = false; selectedMessages.clear(); document.getElementById('selectionHeader').classList.remove('show'); if (currentChatUser) document.getElementById('chatHeader').style.display = 'flex'; renderMessages(); }
        function toggleMessageSelect(msgId) { if (selectedMessages.has(msgId)) selectedMessages.delete(msgId); else selectedMessages.add(msgId); updateSelectionCount(); renderMessages(); }
        function handleMessageClick(event, msgId) { if (isSelectionMode) { event.stopPropagation(); toggleMessageSelect(msgId); } }
        function updateSelectionCount() { document.getElementById('selectionCount').textContent = `${selectedMessages.size} selected`; }

        function deleteSelectedMessages() {
            if (selectedMessages.size === 0) { showToast('No messages selected', 'error'); return; }
            document.getElementById('confirmTitle').textContent = 'Delete Messages';
            document.getElementById('confirmMessage').textContent = `Delete ${selectedMessages.size} message(s)?`;
            confirmCallback = async () => { await supabaseClient.from('messages').update({ is_deleted: true }).in('id', Array.from(selectedMessages)).eq('sender_id', currentUser.id); showToast('Messages deleted'); closeConfirmModal(); exitSelectionMode(); await loadMessages(currentConversation); };
            document.getElementById('confirmModal').classList.add('show');
        }

        function clearConversation() {
            const convToClear = currentConversation;
            if (!convToClear) return;
            
            document.getElementById('confirmTitle').textContent = 'Clear Chat';
            document.getElementById('confirmMessage').textContent = 'Clear all messages in this conversation? (Only clears for you)';
            confirmCallback = async () => { 
                // Insert or update deleted_conversations with current timestamp
                const now = new Date().toISOString();
                const nowTimestamp = new Date(now).getTime();
                
                const { error } = await supabaseClient.from('deleted_conversations')
                    .upsert({ 
                        user_id: currentUser.id, 
                        other_user_id: convToClear, 
                        deleted_at: now 
                    }, { onConflict: 'user_id,other_user_id' });
                
                if (error) {
                    console.error('Clear error:', error);
                    showToast('Failed to clear chat', 'error');
                    closeConfirmModal();
                    return;
                }
                
                // Update local state with timestamp
                deletedConversations[convToClear] = nowTimestamp;
                
                // Clear messages array
                messages = []; 
                renderMessages();
                
                // Remove from conversations list
                conversations = conversations.filter(c => c.oderId !== convToClear && c.user?.id !== convToClear);
                renderConversations();
                
                // Reset chat panel to empty state
                currentConversation = null;
                currentChatUser = null;
                document.getElementById('chatHeader').style.display = 'none';
                document.getElementById('chatMessages').style.display = 'none';
                document.getElementById('chatInputArea').style.display = 'none';
                document.getElementById('chatBlocked').style.display = 'none';
                document.getElementById('chatEmpty').style.display = 'flex';
                
                showToast('Chat cleared'); 
                closeConfirmModal(); 
                closeChatMenu(); 
            };
            document.getElementById('confirmModal').classList.add('show');
        }

        function deleteConversation() {
            const convToDelete = currentConversation;
            if (!convToDelete) return;
            
            document.getElementById('confirmTitle').textContent = 'Delete Conversation';
            document.getElementById('confirmMessage').textContent = 'Delete this conversation? (Only deletes for you)';
            confirmCallback = async () => { 
                // Insert or update deleted_conversations with current timestamp
                const now = new Date().toISOString();
                const nowTimestamp = new Date(now).getTime();
                
                const { error } = await supabaseClient.from('deleted_conversations')
                    .upsert({ 
                        user_id: currentUser.id, 
                        other_user_id: convToDelete, 
                        deleted_at: now 
                    }, { onConflict: 'user_id,other_user_id' });
                
                if (error) {
                    console.error('Delete error:', error);
                    showToast('Failed to delete conversation', 'error');
                    closeConfirmModal();
                    return;
                }
                
                // Update local state with timestamp
                deletedConversations[convToDelete] = nowTimestamp;
                messages = [];
                
                // Remove from conversations list
                conversations = conversations.filter(c => c.oderId !== convToDelete && c.user?.id !== convToDelete);
                renderConversations();
                
                // Reset chat panel
                currentConversation = null;
                currentChatUser = null;
                
                // Show empty state
                document.getElementById('chatHeader').style.display = 'none';
                document.getElementById('chatMessages').style.display = 'none';
                document.getElementById('chatInputArea').style.display = 'none';
                document.getElementById('chatBlocked').style.display = 'none';
                document.getElementById('chatEmpty').style.display = 'flex';
                
                showToast('Conversation deleted'); 
                closeConfirmModal(); 
                closeChatMenu(); 
            };
            document.getElementById('confirmModal').classList.add('show');
        }

        function openForwardModal() { if (selectedMessages.size === 0) { showToast('No messages selected', 'error'); return; } forwardToUsers.clear(); renderForwardUserList(); document.getElementById('forwardModal').classList.add('show'); }
        function closeForwardModal() { document.getElementById('forwardModal').classList.remove('show'); forwardToUsers.clear(); }
        function renderForwardUserList() {
            const container = document.getElementById('forwardUserList');
            if (friends.length === 0) { container.innerHTML = '<p style="text-align:center;color:var(--gray-500);padding:20px;">No friends to forward to</p>'; return; }
            container.innerHTML = friends.filter(f => f.id !== currentConversation).map(f => { const name = f.full_name || `${f.first_name} ${f.last_name}`; const isSelected = forwardToUsers.has(f.id); return `<div class="forward-user-item ${isSelected ? 'selected' : ''}" onclick="toggleForwardUser('${f.id}')"><div class="forward-user-avatar">${f.avatar_url ? `<img src="${f.avatar_url}">` : getInitials(name)}</div><div class="forward-user-name">${escapeHtml(name)}</div><div class="forward-check"></div></div>`; }).join('');
        }
        function toggleForwardUser(userId) { if (forwardToUsers.has(userId)) forwardToUsers.delete(userId); else forwardToUsers.add(userId); renderForwardUserList(); document.getElementById('forwardBtn').disabled = forwardToUsers.size === 0; }
        async function forwardMessages() {
            if (forwardToUsers.size === 0 || selectedMessages.size === 0) return;
            const selectedMsgs = messages.filter(m => selectedMessages.has(m.id)), inserts = [];
            forwardToUsers.forEach(userId => { selectedMsgs.forEach(msg => { inserts.push({ sender_id: currentUser.id, receiver_id: userId, content: `[Forwarded] ${msg.content}`, message_type: 'text' }); }); });
            await supabaseClient.from('messages').insert(inserts);
            showToast(`Forwarded to ${forwardToUsers.size} user(s)`, 'success'); closeForwardModal(); exitSelectionMode(); await loadConversations();
        }

        function reportSelectedMessages() { if (selectedMessages.size === 0) { showToast('No messages selected', 'error'); return; } document.getElementById('reportReason').value = ''; document.getElementById('reportDescription').value = ''; document.getElementById('reportModal').classList.add('show'); }
        function closeReportModal() { document.getElementById('reportModal').classList.remove('show'); }
        async function submitReport() {
            const reason = document.getElementById('reportReason').value, description = document.getElementById('reportDescription').value;
            if (!reason) { showToast('Please select a reason', 'error'); return; }
            const selectedMsgs = messages.filter(m => selectedMessages.has(m.id)), messageContent = selectedMsgs.map(m => m.content).join('\n---\n');
            await supabaseClient.from('user_reports').insert({ reporter_id: currentUser.id, reported_id: currentConversation, report_type: 'message', reason, description: `${description}\n\n--- Reported Messages ---\n${messageContent}` });
            showToast('Report submitted', 'success'); closeReportModal(); exitSelectionMode();
        }

        async function loadNotifications() { 
            const { data } = await supabaseClient.from('notifications').select('*').eq('user_id', currentUser.id).order('created_at', { ascending: false }).limit(10); 
            notifications = data || []; 
            renderNotifications(); 
            checkAnnouncementPopup();
        }
        
        function checkAnnouncementPopup() {
            const adminTypes = ['announcement', 'admin_warning', 'warning', 'ban', 'admin_message', 'admin_urgent', 'admin_success'];
            const unreadAdmin = notifications.filter(n => adminTypes.includes(n.type) && !n.is_read);
            if (unreadAdmin.length > 0) showAdminPopup(unreadAdmin[0]);
        }
        
        function showAdminPopup(notification) {
            if (document.querySelector('.announcement-overlay')) return;
            const timeAgo = formatTimeAgo(notification.created_at);
            const type = notification.type || 'announcement';
            let config = { label: 'üì¢ Admin Announcement', iconBg: 'linear-gradient(135deg, #f97316 0%, #ea580c 100%)', iconShadow: 'rgba(249, 115, 22, 0.4)', icon: '<path d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"/>', headerBg: 'linear-gradient(135deg, #1a365d 0%, #2c5282 100%)', labelColor: '#f97316' };
            if (type === 'admin_warning' || type === 'warning') { config = { label: '‚ö†Ô∏è Admin Warning', iconBg: 'linear-gradient(135deg, #eab308 0%, #ca8a04 100%)', iconShadow: 'rgba(234, 179, 8, 0.4)', icon: '<path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>', headerBg: 'linear-gradient(135deg, #854d0e 0%, #a16207 100%)', labelColor: '#fde047' }; }
            else if (type === 'admin_urgent' || type === 'ban') { config = { label: type === 'ban' ? 'üö´ Account Suspended' : 'üö® Urgent Notice', iconBg: 'linear-gradient(135deg, #dc2626 0%, #b91c1c 100%)', iconShadow: 'rgba(220, 38, 38, 0.4)', icon: type === 'ban' ? '<path d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"/>' : '<path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>', headerBg: 'linear-gradient(135deg, #991b1b 0%, #b91c1b 100%)', labelColor: '#fca5a5' }; }
            else if (type === 'admin_success') { config = { label: '‚úÖ Good News!', iconBg: 'linear-gradient(135deg, #22c55e 0%, #16a34a 100%)', iconShadow: 'rgba(34, 197, 94, 0.4)', icon: '<path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>', headerBg: 'linear-gradient(135deg, #166534 0%, #15803d 100%)', labelColor: '#86efac' }; }
            const overlay = document.createElement('div');
            overlay.className = 'announcement-overlay';
            overlay.innerHTML = `<div class="announcement-popup" style="background: ${config.headerBg};"><div class="announcement-header"><div class="announcement-icon" style="background: ${config.iconBg}; box-shadow: 0 4px 12px ${config.iconShadow};"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">${config.icon}</svg></div><div class="announcement-header-text"><div class="announcement-label" style="color: ${config.labelColor};">${config.label}</div><div class="announcement-title">${escapeHtml(notification.title)}</div></div></div><div class="announcement-body"><div class="announcement-message">${escapeHtml(notification.body || '')}</div><div class="announcement-time"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>${timeAgo}</div></div><div class="announcement-footer"><button class="announcement-btn" onclick="dismissAnnouncement('${notification.id}')"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M5 13l4 4L19 7"/></svg>I Understand</button></div></div>`;
            document.body.appendChild(overlay);
            playNotificationSound();
        }
        
        async function dismissAnnouncement(announcementId) {
            const notification = notifications.find(n => n.id === announcementId);
            const isBan = notification && notification.type === 'ban';
            
            await supabaseClient.from('notifications').update({ is_read: true }).eq('id', announcementId);
            const idx = notifications.findIndex(n => n.id === announcementId);
            if (idx !== -1) notifications[idx].is_read = true;
            const overlay = document.querySelector('.announcement-overlay');
            if (overlay) { overlay.style.animation = 'fadeIn 0.3s ease reverse'; setTimeout(() => overlay.remove(), 300); }
            
            if (isBan) {
                await supabaseClient.auth.signOut();
                window.location.href = 'index.html';
                return;
            }
            
            renderNotifications();
            setTimeout(checkAnnouncementPopup, 500);
        }
        function renderNotifications() {
            const unread = notifications.filter(n => !n.is_read).length;
            // Update all notification badges
            ['notifBadge', 'notifBadge3'].forEach(id => {
                const badge = document.getElementById(id);
                if (badge) {
                    if (unread > 0) { badge.textContent = unread > 9 ? '9+' : unread; badge.style.display = 'flex'; }
                    else badge.style.display = 'none';
                }
            });
            // Build notification HTML
            let html = '';
            if (notifications.length === 0) { html = '<div class="notif-empty"><p>No notifications</p></div>'; }
            else {
                html = notifications.map(n => { 
                    const type = n.type || '';
                    const iconClass = type.includes('friend') ? 'friend' : type.includes('message') ? 'message' : type.includes('warning') ? 'warning' : 'group'; 
                    const iconSvg = iconClass === 'friend' ? '<path d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/>' : iconClass === 'message' ? '<path d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>' : '<path d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/>';
                    return `<div class="notif-dropdown-item ${n.is_read ? '' : 'unread'}" onclick="handleNotifClick('${n.id}','${type}')"><div class="notif-icon ${iconClass}"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">${iconSvg}</svg></div><div class="notif-content"><h4>${escapeHtml(n.title || 'Notification')}</h4><p>${escapeHtml(n.body || '')}</p><div class="time">${formatTimeAgo(n.created_at)}</div></div></div>`; 
                }).join('');
            }
            // Update all notification lists
            ['notifList', 'notifList3'].forEach(id => {
                const list = document.getElementById(id);
                if (list) list.innerHTML = html;
            });
        }
        async function handleNotifClick(id, type) { 
            await supabaseClient.from('notifications').update({ is_read: true }).eq('id', id); 
            const n = notifications.find(x => x.id === id); 
            if (n) n.is_read = true; 
            renderNotifications(); 
            document.getElementById('notificationDropdown').classList.remove('show');
            const dd3 = document.getElementById('notificationDropdown3'); if (dd3) dd3.classList.remove('show');
            if (type === 'friend_request' || type === 'friend_accept') window.location.href = 'friends.html';
            else if (type === 'study_group') window.location.href = 'study-groups.html';
            else if (type === 'admin_warning' || type === 'announcement') window.location.href = 'dashboard.html';
            // For message notifications, stay on this page
        }
        async function markAllNotificationsRead() { await supabaseClient.from('notifications').update({ is_read: true }).eq('user_id', currentUser.id); notifications.forEach(n => n.is_read = true); renderNotifications(); }

        // Notification sound
        function playNotificationSound() {
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.frequency.value = 800;
                osc.type = 'sine';
                gain.gain.setValueAtTime(0.1, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
                osc.start(ctx.currentTime);
                osc.stop(ctx.currentTime + 0.3);
            } catch (e) { console.log('Sound error:', e); }
        }

        function subscribeToRealtime() {
            supabaseClient.channel('messages-channel').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages', filter: `receiver_id=eq.${currentUser.id}` }, async (payload) => {
                const msg = payload.new;
                const senderId = msg.sender_id;
                
                // Check if conversation was deleted - only show if message is AFTER deletion
                const deletedAt = deletedConversations[senderId];
                const msgTime = new Date(msg.created_at).getTime();
                if (deletedAt && msgTime <= deletedAt) {
                    // Message was created before we deleted, ignore it
                    return;
                }
                
                playNotificationSound();
                if (currentConversation === senderId) { 
                    messages.push(msg); 
                    renderMessages(); 
                    await supabaseClient.from('messages').update({ is_read: true }).eq('id', msg.id); 
                } else { 
                    showToast('New message received', 'success'); 
                }
                await loadConversations();
                
                // üîî TRIGGER PUSH NOTIFICATION
                try {
                    if (window.MyUBNotificationTriggers) {
                        const senderProfile = await supabaseClient
                            .from('profiles')
                            .select('full_name')
                            .eq('id', senderId)
                            .single();
                        
                        const senderName = senderProfile.data?.full_name || 'Someone';
                        
                        // Insert notification directly (bypass trigger to specify receiver)
                        const preview = msg.content.length > 50 ? msg.content.substring(0, 50) + "..." : msg.content;
                        
                        await supabaseClient
                            .from('notification_queue')
                            .insert({
                                user_id: currentUser.id,  // Receiver (current user on this page)
                                type: 'message',
                                title: senderName,
                                body: preview,
                                icon: '/icons/icon-192x192.png',
                                badge: '/icons/favicon-48x48.png',
                                tag: 'message-' + senderId,
                                data: {
                                    type: 'message',
                                    senderId: senderId,
                                    conversationId: senderId,
                                    url: '/messages.html?conversation=' + senderId
                                },
                                require_interaction: false,
                                delivered: false
                            });
                        
                        console.log('MyUB: Notification triggered for new message from', senderName);
                    }
                } catch (error) {
                    console.error('MyUB: Error triggering notification:', error);
                }
            }).subscribe();
            supabaseClient.channel('message-reads').on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'messages', filter: `sender_id=eq.${currentUser.id}` }, (payload) => { const msgIdx = messages.findIndex(m => m.id === payload.new.id); if (msgIdx !== -1) { messages[msgIdx].is_read = payload.new.is_read; renderMessages(); } }).subscribe();
            supabaseClient.channel('online-status-messages').on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'profiles' }, (payload) => {
                if (currentChatUser && currentChatUser.id === payload.new.id) { currentChatUser.is_online = payload.new.is_online; currentChatUser.last_seen = payload.new.last_seen; const statusEl = document.getElementById('chatUserStatus'); statusEl.textContent = payload.new.is_online ? 'Online' : `Last seen ${formatTimeAgo(payload.new.last_seen)}`; statusEl.className = 'chat-user-status' + (payload.new.is_online ? '' : ' offline'); }
                const conv = conversations.find(c => c.oderId === payload.new.id); if (conv && conv.user) { conv.user.is_online = payload.new.is_online; conv.user.last_seen = payload.new.last_seen; renderConversations(); }
                // Friend online toast - only on fresh logins (offline > 30 seconds)
                const friend = friends.find(f => f.id === payload.new.id);
                if (friend) {
                    const wasOffline = !friend.is_online;
                    const lastSeen = friend.last_seen ? new Date(friend.last_seen) : null;
                    const now = new Date();
                    const offlineDuration = lastSeen ? (now - lastSeen) / 1000 : 999;
                    
                    friend.is_online = payload.new.is_online;
                    friend.last_seen = payload.new.last_seen;
                    
                    if (wasOffline && payload.new.is_online && offlineDuration > 30) {
                        showFriendOnlineToast(friend.full_name || friend.first_name);
                    }
                }
            }).subscribe();
            supabaseClient.channel('notifications-messages-' + currentUser.id).on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'notifications', filter: `user_id=eq.${currentUser.id}` }, (payload) => { 
                console.log('Messages page: New notification received:', payload);
                notifications.unshift(payload.new); 
                renderNotifications(); 
                const adminTypes = ['announcement', 'admin_warning', 'warning', 'ban', 'admin_message', 'admin_urgent', 'admin_success'];
                if (adminTypes.includes(payload.new.type)) {
                    showAdminPopup(payload.new);
                } else {
                    playNotificationSound();
                    showToast(payload.new.title || 'New notification', 'success');
                }
            }).subscribe((status) => console.log('Messages notification subscription:', status));
            // Friend requests real-time for sidebar badge
            supabaseClient.channel('messages-friend-requests-' + currentUser.id).on('postgres_changes', { event: '*', schema: 'public', table: 'friend_requests', filter: `receiver_id=eq.${currentUser.id}` }, () => loadSidebarFriendsBadge()).subscribe();
        }

        function showFriendOnlineToast(friendName) {
            const existing = document.querySelector('.friend-online-toast');
            if (existing) existing.remove();
            const toast = document.createElement('div');
            toast.className = 'friend-online-toast';
            toast.innerHTML = `<div style="width:10px;height:10px;background:#22c55e;border-radius:50%;animation:pulse 1s infinite;"></div><span><strong>${friendName}</strong> is now online</span>`;
            toast.style.cssText = 'position:fixed;top:80px;right:20px;background:linear-gradient(135deg,#065f46,#047857);color:white;padding:14px 20px;border-radius:12px;display:flex;align-items:center;gap:12px;z-index:9999;animation:slideInRight 0.3s ease;box-shadow:0 4px 20px rgba(4,120,87,0.4);font-size:14px;';
            const style = document.createElement('style');
            style.textContent = '@keyframes slideInRight{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}';
            document.head.appendChild(style);
            document.body.appendChild(toast);
            playNotificationSound();
            setTimeout(() => { toast.style.animation = 'slideInRight 0.3s ease reverse'; setTimeout(() => toast.remove(), 300); }, 4000);
        }

        function updateUnreadBadge() { const totalUnread = conversations.reduce((sum, c) => sum + (c.unreadCount || 0), 0); const badge = document.getElementById('sidebarMsgBadge'); if (totalUnread > 0) { badge.textContent = totalUnread > 99 ? '99+' : totalUnread; badge.style.display = 'inline'; } else badge.style.display = 'none'; }
        
        async function loadSidebarFriendsBadge() {
            const { count: reqCount } = await supabaseClient.from('friend_requests').select('id', { count: 'exact' }).eq('receiver_id', currentUser.id).eq('status', 'pending');
            const badge = document.getElementById('sidebarFriendsBadge');
            if (badge) {
                if (reqCount > 0) { badge.textContent = reqCount > 99 ? '99+' : reqCount; badge.style.display = 'inline'; }
                else { badge.style.display = 'none'; }
            }
        }
        
        function viewUserProfile() { if (currentChatUser) { openProfileModal(currentChatUser.id); } closeChatMenu(); }
        function toggleChatMenu(event) { event.stopPropagation(); document.getElementById('chatMenu').classList.toggle('show'); }
        function closeChatMenu() { document.getElementById('chatMenu').classList.remove('show'); }
        function handleOutsideClick(e) { 
            if (!e.target.closest('.notification-wrapper')) {
                document.getElementById('notificationDropdown').classList.remove('show'); 
                const dd3 = document.getElementById('notificationDropdown3'); if (dd3) dd3.classList.remove('show');
            }
            if (!e.target.closest('.chat-header-actions')) closeChatMenu(); 
            if (!e.target.closest('.emoji-btn')) { const picker = document.getElementById('emojiPicker'); if (picker) picker.classList.remove('show'); } 
        }
        function closeConfirmModal() { document.getElementById('confirmModal').classList.remove('show'); confirmCallback = null; }
        function confirmAction() { if (confirmCallback) confirmCallback(); }
        function toggleNotifications(event) { 
            event.stopPropagation(); 
            // Find which dropdown to toggle based on which button was clicked
            const wrapper = event.target.closest('.notification-wrapper');
            const dropdown = wrapper ? wrapper.querySelector('.notification-dropdown') : document.getElementById('notificationDropdown');
            // Close all other dropdowns first
            document.querySelectorAll('.notification-dropdown').forEach(dd => { if (dd !== dropdown) dd.classList.remove('show'); });
            dropdown.classList.toggle('show'); 
        }
        function getInitials(name) { if (!name) return '??'; return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2); }
        function escapeHtml(text) { if (!text) return ''; const div = document.createElement('div'); div.textContent = text; return div.innerHTML; }
        function truncate(str, len) { if (!str) return ''; return str.length > len ? str.substring(0, len) + '...' : str; }
        function formatTimeAgo(dateStr) { const seconds = Math.floor((new Date() - new Date(dateStr)) / 1000); if (seconds < 60) return 'Just now'; if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`; if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`; if (seconds < 604800) return `${Math.floor(seconds / 86400)}d ago`; return new Date(dateStr).toLocaleDateString(); }
        function formatConvTime(dateStr) { const date = new Date(dateStr), now = new Date(), diff = now - date; if (diff < 86400000 && date.getDate() === now.getDate()) return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }); if (diff < 604800000) return date.toLocaleDateString([], { weekday: 'short' }); return date.toLocaleDateString([], { month: 'short', day: 'numeric' }); }
        function formatMessageTime(dateStr) { return new Date(dateStr).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }); }
        function formatDateDivider(dateStr) { const date = new Date(dateStr), now = new Date(), yesterday = new Date(now); yesterday.setDate(yesterday.getDate() - 1); if (date.toDateString() === now.toDateString()) return 'Today'; if (date.toDateString() === yesterday.toDateString()) return 'Yesterday'; return date.toLocaleDateString([], { weekday: 'long', month: 'long', day: 'numeric' }); }
        function showToast(msg, type = '') { const t = document.getElementById('toast'); document.getElementById('toastMessage').textContent = msg; t.className = 'toast' + (type ? ` ${type}` : ''); t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 3000); }
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); document.getElementById('sidebarOverlay').classList.toggle('show'); }
        async function handleLogout() { await updateOnlineStatus(false); await supabaseClient.auth.signOut(); window.location.href = 'index.html'; }

        // =============================================
        // NEW CHAT MODAL - User Search
        // =============================================
        let searchTimeout = null;
        let reportingUserId = null;

        function openNewChatModal() {
            document.getElementById('userSearchInput').value = '';
            document.getElementById('userSearchResults').innerHTML = '<div class="search-placeholder"><svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg><p>Search for users to start a conversation</p></div>';
            document.getElementById('newChatModal').classList.add('show');
            setTimeout(() => document.getElementById('userSearchInput').focus(), 100);
        }

        function closeNewChatModal() {
            document.getElementById('newChatModal').classList.remove('show');
        }

        async function searchUsers() {
            const query = document.getElementById('userSearchInput').value.trim();
            const container = document.getElementById('userSearchResults');
            
            if (query.length < 2) {
                container.innerHTML = '<div class="search-placeholder"><svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg><p>Type at least 2 characters to search</p></div>';
                return;
            }

            // Debounce
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(async () => {
                container.innerHTML = '<div class="search-loading">Searching...</div>';

                try {
                    const { data: users, error } = await supabaseClient
                        .from('profiles')
                        .select('id, first_name, last_name, full_name, avatar_url, program_name, is_online, last_seen')
                        .or(`full_name.ilike.%${query}%,first_name.ilike.%${query}%,last_name.ilike.%${query}%,program_name.ilike.%${query}%`)
                        .neq('id', currentUser.id)
                        .limit(20);

                    if (error) throw error;

                    // Filter out blocked users
                    const filteredUsers = (users || []).filter(u => !blockedUsers.includes(u.id) && !blockedByUsers.includes(u.id));

                    if (filteredUsers.length === 0) {
                        container.innerHTML = '<div class="search-empty">No users found</div>';
                        return;
                    }

                    container.innerHTML = filteredUsers.map(user => {
                        const name = user.full_name || `${user.first_name} ${user.last_name}`;
                        const initials = getInitials(name);
                        const statusText = user.is_online ? 'Online' : (user.last_seen ? `Last seen ${formatTimeAgo(user.last_seen)}` : 'Offline');
                        
                        return `
                            <div class="user-search-item" onclick="startConversation('${user.id}')">
                                <div class="user-search-avatar">
                                    ${user.avatar_url ? `<img src="${user.avatar_url}" alt="">` : initials}
                                    <div class="online-indicator ${user.is_online ? '' : 'offline'}"></div>
                                </div>
                                <div class="user-search-info">
                                    <div class="user-search-name">${escapeHtml(name)}</div>
                                    <div class="user-search-program">${escapeHtml(user.program_name || 'Student')}</div>
                                </div>
                                <div class="user-search-status ${user.is_online ? '' : 'offline'}">${user.is_online ? 'Online' : ''}</div>
                            </div>`;
                }).join('');
                } catch (e) {
                    console.error('Search error:', e);
                    container.innerHTML = '<div class="search-empty">Error searching users</div>';
                }
            }, 300);
        }

        async function startConversation(userId) {
            closeNewChatModal();
            await openConversation(userId);
        }

        // =============================================
        // PROFILE PREVIEW MODAL
        // =============================================
        async function openProfileModal(userId) {
            // Refresh friend data to ensure sync
            await Promise.all([loadFriends(), loadFriendRequests()]);
            
            const { data: user, error } = await supabaseClient
                .from('profiles')
                .select('id, first_name, last_name, full_name, avatar_url, program_name, year_of_study, bio, is_online, last_seen, created_at')
                .eq('id', userId)
                .single();

            if (error || !user) {
                showToast('User not found', 'error');
                return;
            }

            selectedProfileUser = user;
            const name = user.full_name || `${user.first_name} ${user.last_name}`;
            const initials = getInitials(name);
            const isBlocked = blockedUsers.includes(userId);
            const isBlockedBy = blockedByUsers.includes(userId);
            const isFriend = friendIds.includes(userId);
            const isPendingOut = outgoingRequestIds.includes(userId);
            const isPendingIn = incomingRequestIds.includes(userId);
            const memberSince = new Date(user.created_at).toLocaleDateString('en-US', { month: 'short', year: 'numeric' });

            let bodyHtml = `
                <div class="profile-modal-content">
                    <div class="profile-modal-avatar">
                        ${user.avatar_url ? `<img src="${user.avatar_url}" alt="">` : initials}
                        <div class="online-dot ${user.is_online ? '' : 'offline'}"></div>
                    </div>
                    <div class="profile-modal-name">${escapeHtml(name)}</div>
                    <div class="profile-modal-program">${escapeHtml(user.program_name || 'Student')}${user.year_of_study ? ` ‚Ä¢ Year ${user.year_of_study}` : ''}</div>
                    <div class="profile-modal-status ${user.is_online ? 'online' : 'offline'}">
                        <span>‚óè</span> ${user.is_online ? 'Online now' : (user.last_seen ? `Last seen ${formatTimeAgo(user.last_seen)}` : 'Offline')}
                    </div>
                    ${user.bio ? `<div class="profile-modal-bio">${escapeHtml(user.bio)}</div>` : ''}
                    <div class="profile-modal-meta">
                        <div class="label">Member since</div>
                        <div class="value">${memberSince}</div>
                    </div>
                </div>`;

            if (isBlockedBy) {
                bodyHtml += `<div class="profile-blocked-notice">You cannot interact with this user.</div>`;
            } else if (isBlocked) {
                bodyHtml += `<div class="profile-blocked-notice">You have blocked this user.</div>`;
            }

            document.getElementById('profileModalBody').innerHTML = bodyHtml;

            // Footer actions - match friends page layout
            let footerHtml = '<div class="profile-modal-actions">';
            
            if (isBlockedBy) {
                footerHtml += '<p style="text-align:center;color:var(--gray-500);font-size:14px;padding:16px 0;">You cannot interact with this user</p>';
            } else if (isBlocked) {
                footerHtml += `<button class="btn btn-secondary" onclick="unblockUser('${userId}', '${escapeHtml(name)}')">
                    <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"/></svg>
                    Unblock User
                </button>`;
            } else {
                // Primary action based on friendship status
                if (isFriend) {
                    // Already friends - show Message and Remove Friend
                    footerHtml += `<button class="btn btn-primary" onclick="startConversationFromProfile('${userId}')">
                        <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
                        Message
                    </button>`;
                    footerHtml += `<button class="btn btn-danger" onclick="removeFriend('${userId}', '${escapeHtml(name)}')">
                        <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M13 7a4 4 0 11-8 0 4 4 0 018 0zM9 14a6 6 0 00-6 6v1h12v-1a6 6 0 00-6-6zM21 12h-6"/></svg>
                        Remove Friend
                    </button>`;
                } else if (isPendingOut) {
                    footerHtml += `<button class="btn btn-secondary" disabled>
                        <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        Request Sent
                    </button>`;
                    footerHtml += `<button class="btn btn-secondary" onclick="startConversationFromProfile('${userId}')">
                        <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
                        Message
                    </button>`;
                } else if (isPendingIn) {
                    footerHtml += `<button class="btn btn-success" onclick="acceptFriendRequest('${userId}')">
                        <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M5 13l4 4L19 7"/></svg>
                        Accept Request
                    </button>`;
                    footerHtml += `<button class="btn btn-secondary" onclick="startConversationFromProfile('${userId}')">
                        <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
                        Message
                    </button>`;
                } else {
                    // Not friends - Add Friend primary, Message secondary
                    footerHtml += `<button class="btn btn-primary" onclick="sendFriendRequest('${userId}', '${escapeHtml(name)}')">
                        <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/></svg>
                        Add Friend
                    </button>`;
                    footerHtml += `<button class="btn btn-secondary" onclick="startConversationFromProfile('${userId}')">
                        <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
                        Message
                    </button>`;
                }
                
                // Block and Report buttons - side by side
                footerHtml += `<div class="btn-row">
                    <button class="btn btn-outline-danger" onclick="blockUser('${userId}', '${escapeHtml(name)}')">
                        <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"/></svg>
                        Block
                    </button>
                    <button class="btn btn-warning" onclick="reportUser('${userId}')">
                        <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                        Report
                    </button>
                </div>`;
            }
            
            // View Full Profile link
            footerHtml += `
                <div class="profile-modal-link-container">
                    <a href="profile.html?user=${userId}" class="profile-modal-link">
                        <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                        View Full Profile
                        <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 5l7 7-7 7"/></svg>
                    </a>
                </div>
            </div>`;
            document.getElementById('profileModalFooter').innerHTML = footerHtml;

            document.getElementById('profileModal').classList.add('show');
        }

        function closeProfileModal() {
            document.getElementById('profileModal').classList.remove('show');
            selectedProfileUser = null;
        }

        function startConversationFromProfile(userId) {
            closeProfileModal();
            openConversation(userId);
        }

        // =============================================
        // FRIEND REQUEST FUNCTIONS
        // =============================================
        async function sendFriendRequest(userId, userName) {
            // Check if already friends
            const { data: friendship } = await supabaseClient.from('friendships').select('id').or(`and(user_id.eq.${currentUser.id},friend_id.eq.${userId}),and(user_id.eq.${userId},friend_id.eq.${currentUser.id})`).maybeSingle();
            if (friendship) { showToast('Already friends!', 'error'); return; }
            
            // Check for existing pending request
            const { data: existing } = await supabaseClient.from('friend_requests').select('id, status').or(`and(sender_id.eq.${currentUser.id},receiver_id.eq.${userId}),and(sender_id.eq.${userId},receiver_id.eq.${currentUser.id})`).maybeSingle();
            
            if (existing) {
                if (existing.status === 'pending') {
                    showToast('Request already pending', 'error'); 
                    return;
                }
                await supabaseClient.from('friend_requests').delete().eq('id', existing.id);
            }
            
            await supabaseClient.from('friend_requests').insert({ sender_id: currentUser.id, receiver_id: userId });
            showToast(`Request sent to ${userName}!`, 'success');
            await loadFriendRequests();
            // Refresh modal if open
            if (selectedProfileUser && selectedProfileUser.id === userId) {
                openProfileModal(userId);
            }
        }

        async function cancelFriendRequest(userId) {
            await supabaseClient.from('friend_requests').delete().eq('sender_id', currentUser.id).eq('receiver_id', userId);
            showToast('Request cancelled');
            await loadFriendRequests();
            if (selectedProfileUser && selectedProfileUser.id === userId) {
                openProfileModal(userId);
            }
        }

        async function acceptFriendRequest(userId) {
            // Delete the request
            await supabaseClient.from('friend_requests').delete().eq('sender_id', userId).eq('receiver_id', currentUser.id);
            // Create friendship
            await supabaseClient.from('friendships').insert({ user_id: currentUser.id, friend_id: userId });
            showToast('Friend request accepted!', 'success');
            await loadFriends();
            await loadFriendRequests();
            if (selectedProfileUser && selectedProfileUser.id === userId) {
                openProfileModal(userId);
            }
        }

        // =============================================
        // REMOVE FRIEND
        // =============================================
        async function removeFriend(userId, userName) {
            document.getElementById('confirmTitle').textContent = 'Remove Friend';
            document.getElementById('confirmMessage').textContent = `Remove ${userName} from your friends?`;
            confirmCallback = async () => {
                try {
                    await supabaseClient.from('friendships').delete()
                        .or(`and(user_id.eq.${currentUser.id},friend_id.eq.${userId}),and(user_id.eq.${userId},friend_id.eq.${currentUser.id})`);
                    
                    // Update local state
                    friendIds = friendIds.filter(id => id !== userId);
                    
                    showToast(`${userName} removed from friends`, 'success');
                    closeConfirmModal();
                    closeProfileModal();
                    await loadFriends();
                } catch (e) {
                    showToast('Failed to remove friend', 'error');
                }
            };
            document.getElementById('confirmModal').classList.add('show');
        }

        // =============================================
        // BLOCK/UNBLOCK USER
        // =============================================
        async function blockUser(userId, userName) {
            document.getElementById('confirmTitle').textContent = 'Block User';
            document.getElementById('confirmMessage').textContent = `Block ${userName}? They won't be able to message you.`;
            confirmCallback = async () => {
                try {
                    await supabaseClient.from('blocked_users').insert({ blocker_id: currentUser.id, blocked_id: userId });
                    // Remove any existing friendship
                    await supabaseClient.from('friendships').delete().or(`and(user_id.eq.${currentUser.id},friend_id.eq.${userId}),and(user_id.eq.${userId},friend_id.eq.${currentUser.id})`);
                    // Cancel pending requests
                    await supabaseClient.from('friend_requests').delete().or(`and(sender_id.eq.${currentUser.id},receiver_id.eq.${userId}),and(sender_id.eq.${userId},receiver_id.eq.${currentUser.id})`);
                    
                    blockedUsers.push(userId);
                    showToast(`${userName} has been blocked`, 'success');
                    closeConfirmModal();
                    closeProfileModal();
                    await loadConversations();
                } catch (e) {
                    showToast('Failed to block user', 'error');
                }
            };
            document.getElementById('confirmModal').classList.add('show');
        }

        async function unblockUser(userId, userName) {
            try {
                await supabaseClient.from('blocked_users').delete().eq('blocker_id', currentUser.id).eq('blocked_id', userId);
                blockedUsers = blockedUsers.filter(id => id !== userId);
                showToast(`${userName} has been unblocked`, 'success');
                // Refresh the modal to show updated buttons
                if (selectedProfileUser && selectedProfileUser.id === userId) {
                    await loadFriendRequests();
                    openProfileModal(userId);
                } else {
                    closeProfileModal();
                }
            } catch (e) {
                showToast('Failed to unblock user', 'error');
            }
        }

        // =============================================
        // REPORT USER
        // =============================================
        function reportUser(userId) {
            reportingUserId = userId;
            document.getElementById('userReportReason').value = '';
            document.getElementById('userReportDescription').value = '';
            closeProfileModal();
            document.getElementById('userReportModal').classList.add('show');
        }

        function closeUserReportModal() {
            document.getElementById('userReportModal').classList.remove('show');
            reportingUserId = null;
        }

        async function submitUserReport() {
            const reason = document.getElementById('userReportReason').value;
            const description = document.getElementById('userReportDescription').value;

            if (!reason) {
                showToast('Please select a reason', 'error');
                return;
            }

            try {
                await supabaseClient.from('user_reports').insert({
                    reporter_id: currentUser.id,
                    reported_id: reportingUserId,
                    report_type: 'user',
                    reason: reason,
                    description: description
                });

                showToast('Report submitted. Our team will review it.', 'success');
                closeUserReportModal();
            } catch (e) {
                showToast('Failed to submit report', 'error');
            }
        }

        // Update viewUserProfile to use modal instead of redirect
        function viewUserProfile() {
            if (currentChatUser) {
                openProfileModal(currentChatUser.id);
            }
            closeChatMenu();
        }

        // All Notifications Modal
        async function openNotificationsModal() {
            document.getElementById('notificationDropdown').classList.remove('show');
            document.getElementById('notificationsModal').classList.add('show');
            await loadAllNotifications();
        }
        function closeNotificationsModal() { document.getElementById('notificationsModal').classList.remove('show'); }
        async function loadAllNotifications() {
            const { data } = await supabaseClient.from('notifications').select('*').eq('user_id', currentUser.id).order('created_at', { ascending: false }).limit(100);
            const allNotifs = data || [];
            const list = document.getElementById('allNotifList');
            if (allNotifs.length === 0) { list.innerHTML = '<div class="notif-empty" style="padding:40px;text-align:center;color:var(--gray-400);"><p>No notifications</p></div>'; return; }
            list.innerHTML = allNotifs.map(n => {
                const type = n.type || '';
                const iconClass = type.includes('friend') ? 'friend' : type.includes('message') ? 'message' : type.includes('warning') ? 'warning' : 'group';
                const iconSvg = iconClass === 'friend' ? '<path d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/>' : iconClass === 'message' ? '<path d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>' : '<path d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/>';
                return `<div class="notif-dropdown-item ${n.is_read ? '' : 'unread'}" onclick="handleNotifClickModal('${n.id}','${type}')"><div class="notif-icon ${iconClass}"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">${iconSvg}</svg></div><div class="notif-content"><h4>${escapeHtml(n.title || 'Notification')}</h4><p>${escapeHtml(n.body || '')}</p><div class="time">${formatTimeAgo(n.created_at)}</div></div></div>`;
            }).join('');
        }
        async function handleNotifClickModal(id, type) { await supabaseClient.from('notifications').update({ is_read: true }).eq('id', id); closeNotificationsModal(); if (type === 'friend_request' || type === 'friend_accept') window.location.href = 'friends.html'; else if (type === 'study_group') window.location.href = 'study-groups.html'; else if (type === 'admin_warning' || type === 'announcement') window.location.href = 'dashboard.html'; }
        async function markAllNotificationsReadModal() { await supabaseClient.from('notifications').update({ is_read: true }).eq('user_id', currentUser.id); notifications.forEach(n => n.is_read = true); renderNotifications(); await loadAllNotifications(); showToast('All marked as read'); }
        async function clearAllNotifications() { if (!confirm('Clear all notifications?')) return; const { error } = await supabaseClient.from('notifications').delete().eq('user_id', currentUser.id); if (error) { console.error('Delete failed:', error); showToast('Failed to clear. Check database permissions.', 'error'); return; } notifications = []; renderNotifications(); loadAllNotifications(); closeNotificationsModal(); showToast('Notifications cleared', 'success'); }

        init();
    </script>

    <!-- MyUB Calls Script -->
    <script src="myub-calls.js"></script>
    
    <!-- MyUB Heartbeat Script -->
    <script src="myub-heartbeat.js"></script>
    <script>
        // Start heartbeat when user is loaded
        if (window.currentUser && window.supabaseClient) {
            MyUBHeartbeat.start(supabaseClient, currentUser);
        }
    </script>

</body>
</html>