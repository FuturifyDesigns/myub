<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Reset Password - MyUB</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600&family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --navy: #1a365d;
            --navy-light: #2c5282;
            --navy-dark: #0f2744;
            --red: #c41e3a;
            --white: #ffffff;
            --gray-100: #edf2f7;
            --gray-200: #e2e8f0;
            --gray-400: #a0aec0;
            --gray-500: #718096;
            --gray-600: #4a5568;
            --gray-700: #2d3748;
            --gray-800: #1a202c;
            --green: #38a169;
        }

        body {
            font-family: 'Outfit', sans-serif;
            min-height: 100vh;
            background: linear-gradient(135deg, #1a365d 0%, #234e7a 50%, #2d5a87 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }

        .reset-card {
            background: rgba(255, 255, 255, 0.97);
            border-radius: 20px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 20px 50px -12px rgba(0, 0, 0, 0.5);
            overflow: hidden;
        }

        .reset-header {
            padding: 32px 24px 24px;
            text-align: center;
            background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 100%);
            color: white;
        }

        .reset-icon {
            width: 64px;
            height: 64px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px;
            font-size: 28px;
        }

        .reset-header h1 {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .reset-header p {
            font-size: 14px;
            opacity: 0.8;
        }

        .reset-body {
            padding: 24px;
        }

        .alert {
            padding: 12px 16px;
            border-radius: 10px;
            font-size: 13px;
            margin-bottom: 20px;
            display: none;
        }

        .alert.show { display: block; }
        .alert.error { background: #fed7d7; color: #c53030; border: 1px solid #fc8181; }
        .alert.success { background: #c6f6d5; color: #276749; border: 1px solid #68d391; }
        .alert.warning { background: #fefcbf; color: #975a16; border: 1px solid #f6e05e; }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 8px;
        }

        .form-group label .required {
            color: var(--red);
        }

        .pw-wrapper {
            position: relative;
        }

        .form-group input {
            width: 100%;
            padding: 12px 45px 12px 14px;
            border: 2px solid var(--gray-200);
            border-radius: 10px;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.2s;
            background: var(--white);
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--navy);
            box-shadow: 0 0 0 3px rgba(26, 54, 93, 0.1);
        }

        .form-group input.error {
            border-color: #e53e3e;
            background: #fff5f5;
        }

        .form-group input.success {
            border-color: var(--green);
            background: #f0fff4;
        }

        .pw-toggle {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            opacity: 0.6;
            transition: opacity 0.2s;
        }

        .pw-toggle:hover { opacity: 1; }

        .strength-bar {
            height: 4px;
            background: var(--gray-200);
            border-radius: 2px;
            margin-top: 10px;
            overflow: hidden;
        }

        .strength-fill {
            height: 100%;
            width: 0%;
            border-radius: 2px;
            transition: all 0.3s;
        }

        .strength-fill.weak { width: 25%; background: #e53e3e; }
        .strength-fill.fair { width: 50%; background: #ed8936; }
        .strength-fill.good { width: 75%; background: #ecc94b; }
        .strength-fill.strong { width: 100%; background: #38a169; }

        .strength-text {
            font-size: 11px;
            color: var(--gray-500);
            margin-top: 6px;
            display: flex;
            justify-content: space-between;
        }

        .requirements {
            background: var(--gray-100);
            border-radius: 10px;
            padding: 14px;
            margin-bottom: 20px;
        }

        .requirements h4 {
            font-size: 12px;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 10px;
        }

        .req-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: var(--gray-500);
            margin-bottom: 6px;
        }

        .req-item:last-child { margin-bottom: 0; }

        .req-item.met { color: var(--green); }

        .req-icon {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--gray-300);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: white;
        }

        .req-item.met .req-icon { background: var(--green); }

        .same-password-warning {
            background: #fff5f5;
            border: 1px solid #fc8181;
            border-radius: 10px;
            padding: 12px 14px;
            margin-bottom: 20px;
            display: none;
        }

        .same-password-warning.show {
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .same-password-warning .warning-icon {
            font-size: 18px;
            flex-shrink: 0;
        }

        .same-password-warning .warning-text {
            font-size: 13px;
            color: #c53030;
            line-height: 1.4;
        }

        .submit-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.3s;
        }

        .submit-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(26, 54, 93, 0.4);
        }

        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .back-link {
            display: block;
            text-align: center;
            margin-top: 20px;
            color: var(--navy);
            font-size: 14px;
            font-weight: 500;
            text-decoration: none;
        }

        .back-link:hover { text-decoration: underline; }

        /* Success Screen */
        .success-screen {
            display: none;
            text-align: center;
            padding: 40px 24px;
        }

        .success-screen.show { display: block; }

        .success-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #38a169 0%, #48bb78 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
            font-size: 40px;
            animation: successPop 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes successPop {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .success-screen h2 {
            font-size: 22px;
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: 12px;
        }

        .success-screen p {
            font-size: 14px;
            color: var(--gray-500);
            margin-bottom: 24px;
            line-height: 1.5;
        }

        .success-btn {
            display: inline-block;
            padding: 12px 32px;
            background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 100%);
            color: white;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.3s;
        }

        .success-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(26, 54, 93, 0.4);
        }

        /* Loading Screen */
        .loading-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 24px;
        }

        .loading-screen.hide { display: none; }

        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--gray-200);
            border-top-color: var(--navy);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .loading-screen p {
            font-size: 14px;
            color: var(--gray-500);
        }

        /* Error Screen */
        .error-screen {
            display: none;
            text-align: center;
            padding: 40px 24px;
        }

        .error-screen.show { display: block; }

        .error-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #e53e3e 0%, #fc8181 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
            font-size: 40px;
        }

        .error-screen h2 {
            font-size: 22px;
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: 12px;
        }

        .error-screen p {
            font-size: 14px;
            color: var(--gray-500);
            margin-bottom: 24px;
            line-height: 1.5;
        }

        /* Form screen */
        .form-screen { display: none; }
        .form-screen.show { display: block; }

        @media (max-width: 480px) {
            .reset-card { border-radius: 16px; }
            .reset-header { padding: 24px 20px 20px; }
            .reset-header h1 { font-size: 20px; }
            .reset-body { padding: 20px; }
            .submit-btn { padding: 12px; font-size: 14px; }
        }
    </style>
</head>
<body>
    <div class="reset-card">
        <!-- Loading Screen -->
        <div class="loading-screen" id="loadingScreen">
            <div class="spinner"></div>
            <p>Verifying your reset link...</p>
        </div>

        <!-- Error Screen -->
        <div class="error-screen" id="errorScreen">
            <div class="error-icon">‚ùå</div>
            <h2>Link Expired or Invalid</h2>
            <p>This password reset link has expired or is invalid. Please request a new one.</p>
            <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                <button onclick="init()" class="success-btn" style="background: linear-gradient(135deg, #718096 0%, #4a5568 100%); cursor: pointer; border: none;">Try Again</button>
                <a href="index.html" class="success-btn">Back to Login</a>
            </div>
        </div>

        <!-- Reset Form -->
        <div class="form-screen" id="formScreen">
            <div class="reset-header">
                <div class="reset-icon">üîê</div>
                <h1>Reset Your Password</h1>
                <p>Create a new secure password for your account</p>
            </div>

            <div class="reset-body">
                <div class="alert" id="alertBox"></div>

                <div class="same-password-warning" id="samePasswordWarning">
                    <span class="warning-icon">‚ö†Ô∏è</span>
                    <span class="warning-text">Your new password cannot be the same as your current password. Please choose a different password.</span>
                </div>

                <form id="resetForm" onsubmit="handleReset(event)">
                    <div class="form-group">
                        <label>New Password <span class="required">*</span></label>
                        <div class="pw-wrapper">
                            <input type="password" id="newPassword" placeholder="Enter new password" required oninput="checkPassword()">
                            <button type="button" class="pw-toggle" onclick="togglePw('newPassword', this)">üëÅ</button>
                        </div>
                        <div class="strength-bar">
                            <div class="strength-fill" id="strengthFill"></div>
                        </div>
                        <div class="strength-text">
                            <span id="strengthLabel">Password strength</span>
                        </div>
                    </div>

                    <div class="requirements">
                        <h4>Password Requirements</h4>
                        <div class="req-item" id="reqLength">
                            <span class="req-icon">‚úì</span>
                            <span>At least 8 characters</span>
                        </div>
                        <div class="req-item" id="reqUpper">
                            <span class="req-icon">‚úì</span>
                            <span>One uppercase letter</span>
                        </div>
                        <div class="req-item" id="reqLower">
                            <span class="req-icon">‚úì</span>
                            <span>One lowercase letter</span>
                        </div>
                        <div class="req-item" id="reqNumber">
                            <span class="req-icon">‚úì</span>
                            <span>One number</span>
                        </div>
                        <div class="req-item" id="reqDifferent">
                            <span class="req-icon">‚úì</span>
                            <span>Different from current password</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Confirm New Password <span class="required">*</span></label>
                        <div class="pw-wrapper">
                            <input type="password" id="confirmPassword" placeholder="Confirm new password" required oninput="checkConfirm()">
                            <button type="button" class="pw-toggle" onclick="togglePw('confirmPassword', this)">üëÅ</button>
                        </div>
                    </div>

                    <button type="submit" class="submit-btn" id="resetBtn" disabled>Reset Password</button>
                </form>

                <a href="index.html" class="back-link">‚Üê Back to Login</a>
            </div>
        </div>

        <!-- Success Screen -->
        <div class="success-screen" id="successScreen">
            <div class="success-icon">‚úì</div>
            <h2>Password Reset Successfully!</h2>
            <p>Your password has been updated. You can now sign in with your new password.</p>
            <a href="index.html" class="success-btn">Sign In Now</a>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://weuxtwmaqmbhskjpjdyi.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndldXh0d21hcW1iaHNranBqZHlpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3NTYzMTcsImV4cCI6MjA4MDMzMjMxN30.J-0Nd0MY6-g_ltbBNHwOulqZuQfb8mKIRgx0dAaJ76o';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentUserEmail = null;
        let isPasswordSame = false;
        let recoveryAccessToken = null;
        let recoveryRefreshToken = null;

        // Show/hide screens
        function showScreen(screenId) {
            document.getElementById('loadingScreen').classList.add('hide');
            document.getElementById('errorScreen').classList.remove('show');
            document.getElementById('formScreen').classList.remove('show');
            document.getElementById('successScreen').classList.remove('show');
            
            if (screenId === 'loading') {
                document.getElementById('loadingScreen').classList.remove('hide');
            } else {
                document.getElementById(screenId).classList.add('show');
            }
        }

        // Show alert
        function showAlert(message, type = 'error') {
            const alert = document.getElementById('alertBox');
            alert.textContent = message;
            alert.className = 'alert show ' + type;
        }

        function hideAlert() {
            document.getElementById('alertBox').classList.remove('show');
        }

        // Toggle password visibility
        function togglePw(inputId, btn) {
            const input = document.getElementById(inputId);
            if (input.type === 'password') {
                input.type = 'text';
                btn.textContent = 'üôà';
            } else {
                input.type = 'password';
                btn.textContent = 'üëÅ';
            }
        }

        // Check password requirements
        function checkPassword() {
            const pw = document.getElementById('newPassword').value;
            const strengthFill = document.getElementById('strengthFill');
            const strengthLabel = document.getElementById('strengthLabel');
            
            // Check requirements
            const hasLength = pw.length >= 8;
            const hasUpper = /[A-Z]/.test(pw);
            const hasLower = /[a-z]/.test(pw);
            const hasNumber = /[0-9]/.test(pw);
            
            // Update requirement indicators
            updateReq('reqLength', hasLength);
            updateReq('reqUpper', hasUpper);
            updateReq('reqLower', hasLower);
            updateReq('reqNumber', hasNumber);
            
            // Calculate strength
            let strength = 0;
            if (hasLength) strength++;
            if (hasUpper) strength++;
            if (hasLower) strength++;
            if (hasNumber) strength++;
            if (pw.length >= 12) strength++;
            if (/[!@#$%^&*(),.?":{}|<>]/.test(pw)) strength++;
            
            // Update strength bar
            strengthFill.className = 'strength-fill';
            if (pw.length === 0) {
                strengthLabel.textContent = 'Password strength';
            } else if (strength <= 2) {
                strengthFill.classList.add('weak');
                strengthLabel.textContent = 'Weak';
            } else if (strength <= 3) {
                strengthFill.classList.add('fair');
                strengthLabel.textContent = 'Fair';
            } else if (strength <= 4) {
                strengthFill.classList.add('good');
                strengthLabel.textContent = 'Good';
            } else {
                strengthFill.classList.add('strong');
                strengthLabel.textContent = 'Strong';
            }
            
            // Reset same password check - will verify on submit
            isPasswordSame = false;
            document.getElementById('samePasswordWarning').classList.remove('show');
            updateReq('reqDifferent', true);
            
            checkConfirm();
            updateSubmitButton();
        }

        function updateReq(reqId, met) {
            const req = document.getElementById(reqId);
            if (met) {
                req.classList.add('met');
            } else {
                req.classList.remove('met');
            }
        }

        // Check confirm password
        function checkConfirm() {
            const pw = document.getElementById('newPassword').value;
            const confirm = document.getElementById('confirmPassword').value;
            const confirmInput = document.getElementById('confirmPassword');
            
            if (confirm.length === 0) {
                confirmInput.classList.remove('error', 'success');
            } else if (pw === confirm) {
                confirmInput.classList.remove('error');
                confirmInput.classList.add('success');
            } else {
                confirmInput.classList.remove('success');
                confirmInput.classList.add('error');
            }
            
            updateSubmitButton();
        }

        // Update submit button state
        function updateSubmitButton() {
            const pw = document.getElementById('newPassword').value;
            const confirm = document.getElementById('confirmPassword').value;
            const btn = document.getElementById('resetBtn');
            
            const hasLength = pw.length >= 8;
            const hasUpper = /[A-Z]/.test(pw);
            const hasLower = /[a-z]/.test(pw);
            const hasNumber = /[0-9]/.test(pw);
            const passwordsMatch = pw === confirm && confirm.length > 0;
            
            btn.disabled = !(hasLength && hasUpper && hasLower && hasNumber && passwordsMatch && !isPasswordSame);
        }

        // Handle password reset
        async function handleReset(e) {
            e.preventDefault();
            hideAlert();
            
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const btn = document.getElementById('resetBtn');
            
            // Validate passwords match
            if (newPassword !== confirmPassword) {
                showAlert('Passwords do not match');
                return;
            }
            
            // Validate password requirements
            if (newPassword.length < 8) {
                showAlert('Password must be at least 8 characters');
                return;
            }
            if (!/[A-Z]/.test(newPassword)) {
                showAlert('Password must contain at least one uppercase letter');
                return;
            }
            if (!/[a-z]/.test(newPassword)) {
                showAlert('Password must contain at least one lowercase letter');
                return;
            }
            if (!/[0-9]/.test(newPassword)) {
                showAlert('Password must contain at least one number');
                return;
            }
            
            btn.disabled = true;
            btn.textContent = 'Resetting...';
            
            try {
                // First, try to verify if the new password is the same as the old one
                // We do this by attempting to sign in with the new password
                if (currentUserEmail) {
                    const { error: signInError } = await supabase.auth.signInWithPassword({
                        email: currentUserEmail,
                        password: newPassword
                    });
                    
                    if (!signInError) {
                        // Password is the same as current - reject it
                        isPasswordSame = true;
                        document.getElementById('samePasswordWarning').classList.add('show');
                        updateReq('reqDifferent', false);
                        showAlert('Your new password cannot be the same as your current password. Please choose a different password.', 'warning');
                        btn.disabled = false;
                        btn.textContent = 'Reset Password';
                        updateSubmitButton();
                        
                        // Sign out since we accidentally signed in
                        await supabase.auth.signOut();
                        
                        // Re-establish the recovery session
                        if (recoveryAccessToken && recoveryRefreshToken) {
                            await supabase.auth.setSession({
                                access_token: recoveryAccessToken,
                                refresh_token: recoveryRefreshToken
                            });
                        }
                        return;
                    }
                }
                
                // Password is different, proceed with update
                const { error } = await supabase.auth.updateUser({
                    password: newPassword
                });
                
                if (error) {
                    // Check for "same password" error from Supabase
                    if (error.message.toLowerCase().includes('same') || 
                        error.message.toLowerCase().includes('different') ||
                        error.message.toLowerCase().includes('previous') ||
                        error.message.toLowerCase().includes('reuse')) {
                        isPasswordSame = true;
                        document.getElementById('samePasswordWarning').classList.add('show');
                        updateReq('reqDifferent', false);
                        showAlert('Your new password cannot be the same as your current password.', 'warning');
                        btn.disabled = false;
                        btn.textContent = 'Reset Password';
                        updateSubmitButton();
                        return;
                    }
                    throw error;
                }
                
                // Success - sign out and show success screen
                await supabase.auth.signOut();
                showScreen('successScreen');
                
            } catch (err) {
                console.error('Reset error:', err);
                showAlert(err.message || 'Failed to reset password. Please try again.');
                btn.disabled = false;
                btn.textContent = 'Reset Password';
            }
        }

        // Initialize - check for valid session from reset link
        async function init() {
            showScreen('loading');
            
            try {
                // Check for hash params (from email link)
                const hash = window.location.hash;
                if (hash) {
                    const params = new URLSearchParams(hash.substring(1));
                    const accessToken = params.get('access_token');
                    const refreshToken = params.get('refresh_token');
                    const type = params.get('type');
                    
                    if (accessToken && refreshToken && type === 'recovery') {
                        // Store tokens for re-establishing session if needed
                        recoveryAccessToken = accessToken;
                        recoveryRefreshToken = refreshToken;
                        
                        // Set the session from the recovery link
                        const { data, error } = await supabase.auth.setSession({
                            access_token: accessToken,
                            refresh_token: refreshToken
                        });
                        
                        if (error) {
                            console.error('Session error:', error);
                            // Check if it's a network error
                            if (error.message.includes('fetch') || error.message.includes('network') || error.name === 'AuthRetryableFetchError') {
                                document.querySelector('.error-screen h2').textContent = 'Connection Error';
                                document.querySelector('.error-screen p').textContent = 'Unable to connect to the server. Please check your internet connection and try again.';
                            }
                            showScreen('errorScreen');
                            return;
                        }
                        
                        if (data.user) {
                            currentUserEmail = data.user.email;
                            showScreen('formScreen');
                            return;
                        }
                    }
                }
                
                // Check for existing session
                const { data: { session } } = await supabase.auth.getSession();
                if (session && session.user) {
                    currentUserEmail = session.user.email;
                    showScreen('formScreen');
                    return;
                }
                
                // No valid session or recovery link
                showScreen('errorScreen');
                
            } catch (err) {
                console.error('Init error:', err);
                // Check if it's a network error
                if (err.message && (err.message.includes('fetch') || err.message.includes('network') || err.message.includes('Failed to fetch'))) {
                    document.querySelector('.error-screen h2').textContent = 'Connection Error';
                    document.querySelector('.error-screen p').textContent = 'Unable to connect to the server. Please check your internet connection and try again.';
                }
                showScreen('errorScreen');
            }
        }

        // Start
        init();
    </script>
</body>
</html>
