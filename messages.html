<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, interactive-widget=resizes-content, maximum-scale=1.0, user-scalable=no">
    <title>Messages - MyUB</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=Sora:wght@600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="myub-utils.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; -webkit-touch-callout: none; }
        :root { --navy: #1a365d; --navy-light: #2c5282; --navy-dark: #0f2744; --red: #c41e3a; --white: #ffffff; --gray-50: #f8fafc; --gray-100: #f1f5f9; --gray-200: #e2e8f0; --gray-300: #cbd5e1; --gray-400: #94a3b8; --gray-500: #64748b; --gray-600: #475569; --gray-700: #334155; --gray-800: #1e293b; --green: #22c55e; --green-light: #dcfce7; --blue: #3b82f6; --blue-light: #dbeafe; --orange: #f97316; }
        html { height: auto; min-height: 100%; }
        body { font-family: 'Outfit', sans-serif; background: var(--gray-100); min-height: 100%; overflow-x: hidden; -webkit-overflow-scrolling: touch; }
        .sidebar { position: fixed; left: 0; top: 0; bottom: 0; width: 260px; background: var(--navy-dark); padding: 20px 0; z-index: 100; transition: transform 0.3s ease; overflow-y: auto; }
        .sidebar-header { padding: 0 20px 20px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px; }

        .sidebar-logo {
            display: inline-flex;
            align-items: baseline;
            text-decoration: none;
            background: white;
            padding: 30px 15px 10px 15px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .sidebar-logo-m-wrapper {
            position: relative;
            display: inline-block;
        }

        .sidebar-logo-cap {
            width: 45px;
            height: 26px;
            position: absolute;
            top: -22px;
            left: 50%;
            transform: translateX(-50%);
        }

        .sidebar-logo-m {
            font-family: 'Times New Roman', Georgia, serif;
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--navy);
            line-height: 1;
        }

        .sidebar-logo-yub {
            font-family: 'Times New Roman', Georgia, serif;
            font-size: 1.6rem;
            font-weight: 700;
            color: var(--navy);
            margin-left: -2px;
        }
        .nav-section { margin-bottom: 24px; }
        .nav-section-title { font-size: 11px; font-weight: 600; color: var(--gray-400); text-transform: uppercase; letter-spacing: 1px; padding: 0 20px; margin-bottom: 8px; }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 20px; color: var(--gray-300); text-decoration: none; font-size: 14px; font-weight: 500; transition: all 0.2s; cursor: pointer; border: none; background: none; width: 100%; text-align: left; }
        .nav-item:hover { background: rgba(255,255,255,0.05); color: var(--white); }
        .nav-item.active { background: rgba(255,255,255,0.1); color: var(--white); border-right: 3px solid var(--red); }
        .nav-item svg { width: 20px; height: 20px; flex-shrink: 0; }
        .nav-item .badge { margin-left: auto; background: var(--red); color: var(--white); font-size: 11px; font-weight: 600; padding: 2px 8px; border-radius: 10px; }
        .sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 99; }
        .main-content { margin-left: 260px; height: 100vh; display: flex; flex-direction: column; }
        .messages-container { display: flex; flex: 1; overflow: visible; position: relative; }
        .conversations-panel { width: 360px; background: var(--white); border-right: 1px solid var(--gray-200); display: flex; flex-direction: column; flex-shrink: 0; overflow: visible; }
        .conversations-header { padding: 20px; border-bottom: 1px solid var(--gray-200); display: flex; align-items: center; justify-content: space-between; position: relative; z-index: 50; }
        .conversations-header h2 { font-family: 'Sora', sans-serif; font-size: 20px; font-weight: 700; color: var(--gray-800); }
        .new-chat-btn { width: 36px; height: 36px; border: none; background: var(--navy); border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .new-chat-btn:hover { background: var(--navy-light); transform: scale(1.05); }
        .new-chat-btn svg { width: 20px; height: 20px; color: var(--white); }
        .new-chat-search { padding: 16px; border-bottom: 1px solid var(--gray-200); }
        .new-chat-results { max-height: 400px; overflow-y: auto; }
        .search-placeholder { padding: 60px 20px; text-align: center; color: var(--gray-400); }
        .search-placeholder svg { width: 48px; height: 48px; margin-bottom: 12px; opacity: 0.5; }
        .search-placeholder p { font-size: 14px; }
        .user-search-item { display: flex; align-items: center; gap: 12px; padding: 14px 16px; cursor: pointer; transition: all 0.15s; border-bottom: 1px solid var(--gray-100); }
        .user-search-item:hover { background: var(--gray-50); }
        .user-search-avatar { position: relative; width: 48px; height: 48px; border-radius: 50%; background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 100%); display: flex; align-items: center; justify-content: center; color: var(--white); font-family: 'Sora', sans-serif; font-weight: 700; font-size: 15px; flex-shrink: 0; }
        .user-search-avatar img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
        .user-search-avatar .online-indicator { position: absolute; bottom: 0; right: 0; width: 14px; height: 14px; background: var(--green); border-radius: 50%; border: 2px solid var(--white); }
        .user-search-avatar .online-indicator.offline { background: var(--gray-400); }
        .user-search-info { flex: 1; min-width: 0; }
        .user-search-name { font-size: 15px; font-weight: 600; color: var(--gray-800); margin-bottom: 2px; }
        .user-search-program { font-size: 13px; color: var(--gray-500); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .user-search-status { font-size: 12px; color: var(--green); }
        .user-search-status.offline { color: var(--gray-400); }
        .search-loading, .search-empty { padding: 40px 20px; text-align: center; color: var(--gray-400); font-size: 14px; }
        
        /* Profile Modal Styles - Matching friends.html */
        .profile-modal-content { text-align: center; }
        .profile-modal-avatar { width: 72px; height: 72px; border-radius: 50%; background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 100%); display: flex; align-items: center; justify-content: center; color: var(--white); font-family: 'Sora', sans-serif; font-weight: 700; font-size: 24px; margin: 0 auto 12px; position: relative; }
        .profile-modal-avatar img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
        .profile-modal-avatar .online-dot { position: absolute; bottom: 0; right: 0; width: 14px; height: 14px; background: var(--green); border-radius: 50%; border: 3px solid var(--white); z-index: 1; }
        .profile-modal-avatar .online-dot.offline { background: var(--gray-400); }
        .profile-modal-name { font-family: 'Sora', sans-serif; font-size: 18px; font-weight: 700; color: var(--gray-800); margin-bottom: 2px; }
        .profile-modal-program { font-size: 13px; color: var(--gray-500); margin-bottom: 4px; }
        .profile-modal-status { font-size: 12px; margin-bottom: 12px; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .profile-modal-status.online { color: var(--green); }
        .profile-modal-status.offline { color: var(--gray-400); }
        .profile-modal-bio { font-size: 13px; color: var(--gray-600); background: var(--gray-50); padding: 10px 14px; border-radius: 10px; margin-bottom: 12px; text-align: left; }
        .profile-modal-bio:empty { display: none; }
        .profile-modal-meta { display: flex; flex-direction: column; align-items: center; gap: 2px; padding: 12px 0; margin-bottom: 4px; }
        .profile-modal-meta .label { font-size: 10px; color: var(--gray-400); text-transform: uppercase; letter-spacing: 0.5px; }
        .profile-modal-meta .value { font-family: 'Sora', sans-serif; font-weight: 600; color: var(--gray-700); font-size: 14px; }
        .profile-modal-actions { display: flex; flex-direction: column; gap: 10px; }
        .profile-modal-actions .btn { display: flex; align-items: center; justify-content: center; gap: 6px; padding: 12px 16px; font-size: 13px; font-weight: 600; border-radius: 10px; cursor: pointer; transition: all 0.2s; border: none; width: 100%; }
        .profile-modal-actions .btn svg { width: 16px; height: 16px; }
        .profile-modal-actions .btn-primary { background: var(--navy); color: var(--white); }
        .profile-modal-actions .btn-primary:hover { background: var(--navy-light); }
        .profile-modal-actions .btn-success { background: var(--green); color: var(--white); }
        .profile-modal-actions .btn-success:hover { background: #059669; }
        .profile-modal-actions .btn-secondary { background: var(--gray-100); border: 2px solid var(--gray-200); color: var(--gray-700); }
        .profile-modal-actions .btn-secondary:hover { background: var(--gray-200); }
        .profile-modal-actions .btn-danger { background: var(--red); color: var(--white); }
        .profile-modal-actions .btn-danger:hover { background: #dc2626; }
        .profile-modal-actions .btn-row { display: flex; gap: 10px; }
        .profile-modal-actions .btn-row .btn { flex: 1; padding: 10px 12px; font-size: 12px; }
        .profile-modal-actions .btn-outline-danger { background: #fef2f2; border: 2px solid #fecaca; color: var(--red); }
        .profile-modal-actions .btn-outline-danger:hover { background: #fee2e2; }
        .profile-modal-actions .btn-warning { background: #fffbeb; border: 2px solid #fde68a; color: #b45309; }
        .profile-modal-actions .btn-warning:hover { background: #fef3c7; }
        .profile-modal-link-container { margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--gray-200); }
        .profile-modal-link { display: flex; align-items: center; justify-content: center; gap: 6px; padding: 10px 16px; background: var(--gray-50); border: 2px solid var(--gray-200); border-radius: 10px; color: var(--navy); font-size: 13px; font-weight: 600; text-decoration: none; transition: all 0.2s; }
        .profile-modal-link:hover { background: var(--gray-100); border-color: var(--navy); text-decoration: none; }
        .profile-modal-link svg { width: 14px; height: 14px; }
        .profile-blocked-notice { background: #fee2e2; color: var(--red); padding: 10px; border-radius: 8px; font-size: 13px; margin-bottom: 12px; text-align: center; }
        /* Ensure confirm modal appears above profile modal */
        #confirmModal { z-index: 1100; }
        #userReportModal { z-index: 1100; }
        .conversations-search { padding: 12px 16px; border-bottom: 1px solid var(--gray-200); }
        .search-input { width: 100%; padding: 10px 14px 10px 40px; border: 2px solid var(--gray-200); border-radius: 10px; font-family: 'Outfit', sans-serif; font-size: 14px; background: var(--gray-50) url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' stroke='%2394a3b8' stroke-width='2' viewBox='0 0 24 24'%3E%3Cpath d='M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z'/%3E%3C/svg%3E") no-repeat 12px center; background-size: 18px; }
        .search-input:focus { outline: none; border-color: var(--navy); background-color: var(--white); }
        .conversations-list { flex: 1; overflow-y: auto; }
        .conversation-item { display: flex; align-items: center; gap: 12px; padding: 14px 20px; cursor: pointer; transition: all 0.15s; border-bottom: 1px solid var(--gray-100); position: relative; }
        .conversation-item:hover { background: var(--gray-50); }
        .conversation-item.active { background: var(--blue-light); }
        .conversation-item.unread { background: var(--gray-50); }
        .conversation-item.unread::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background: var(--navy); }
        .conv-avatar { position: relative; width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 100%); display: flex; align-items: center; justify-content: center; color: var(--white); font-family: 'Sora', sans-serif; font-weight: 700; font-size: 16px; flex-shrink: 0; }
        .conv-avatar img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
        .conv-online { position: absolute; bottom: 0; right: 0; width: 14px; height: 14px; background: var(--green); border-radius: 50%; border: 2px solid var(--white); }
        .conv-online.offline { background: var(--gray-400); }
        .conv-info { flex: 1; min-width: 0; }
        .conv-name { font-size: 15px; font-weight: 600; color: var(--gray-800); margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .conv-preview { font-size: 13px; color: var(--gray-500); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .conversation-item.unread .conv-name { color: var(--navy); }
        .conversation-item.unread .conv-preview { color: var(--gray-700); font-weight: 500; }
        .conv-meta { text-align: right; flex-shrink: 0; }
        .conv-time { font-size: 11px; color: var(--gray-400); margin-bottom: 4px; }
        .conv-unread-badge { background: var(--navy); color: var(--white); font-size: 11px; font-weight: 700; min-width: 20px; height: 20px; border-radius: 10px; display: inline-flex; align-items: center; justify-content: center; padding: 0 6px; }
        .conversations-empty { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px; color: var(--gray-400); text-align: center; }
        .conversations-empty svg { width: 64px; height: 64px; margin-bottom: 16px; opacity: 0.5; }
        .conversations-empty h3 { font-size: 16px; font-weight: 600; color: var(--gray-600); margin-bottom: 8px; }
        .chat-panel { flex: 1; display: flex; flex-direction: column; background: var(--gray-100); min-width: 0; }
        .chat-header { padding: 12px 20px; background: var(--white); border-bottom: 1px solid var(--gray-200); display: flex; align-items: center; gap: 12px; }
        .chat-header-back { display: none; width: 36px; height: 36px; border: none; background: var(--gray-100); border-radius: 8px; cursor: pointer; align-items: center; justify-content: center; }
        .chat-header-back svg { width: 20px; height: 20px; color: var(--gray-600); }
        .chat-user-info { flex: 1; display: flex; align-items: center; gap: 12px; cursor: pointer; }
        .chat-avatar { width: 44px; height: 44px; border-radius: 50%; background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 100%); display: flex; align-items: center; justify-content: center; color: var(--white); font-family: 'Sora', sans-serif; font-weight: 700; font-size: 14px; position: relative; }
        .chat-avatar img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
        .chat-avatar .online-dot { position: absolute; bottom: 0; right: 0; width: 12px; height: 12px; background: var(--green); border-radius: 50%; border: 2px solid var(--white); }
        .chat-avatar .online-dot.offline { background: var(--gray-400); }
        .chat-user-details h3 { font-size: 16px; font-weight: 600; color: var(--gray-800); }
        .chat-user-status { font-size: 12px; color: var(--green); }
        .chat-user-status.offline { color: var(--gray-400); }
        .chat-header-actions { display: flex; gap: 8px; }
        .chat-action-btn { width: 36px; height: 36px; border: none; background: var(--gray-100); border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .chat-action-btn:hover { background: var(--gray-200); }
        .chat-action-btn svg { width: 18px; height: 18px; color: var(--gray-600); }
        .selection-header { padding: 12px 20px; background: var(--navy); display: none; align-items: center; gap: 12px; }
        .selection-header.show { display: flex; }
        .selection-count { color: var(--white); font-size: 15px; font-weight: 600; flex: 1; }
        .selection-actions { display: flex; gap: 8px; flex-wrap: wrap; }
        .selection-btn { padding: 8px 14px; border: none; border-radius: 8px; font-family: 'Outfit', sans-serif; font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; }
        .selection-btn svg { width: 16px; height: 16px; }
        .selection-btn.cancel { background: rgba(255,255,255,0.2); color: var(--white); }
        .selection-btn.forward { background: var(--white); color: var(--navy); }
        .selection-btn.delete { background: var(--red); color: var(--white); }
        .selection-btn.report { background: var(--orange); color: var(--white); }
        .chat-messages { flex: 1; overflow-y: auto; overflow-x: hidden; padding: 20px; display: flex; flex-direction: column; gap: 4px; }
        .chat-date-divider { text-align: center; margin: 16px 0; }
        .chat-date-divider span { background: var(--gray-200); color: var(--gray-600); font-size: 12px; font-weight: 500; padding: 4px 12px; border-radius: 12px; }
        .message-row { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
        .message-row.sent { justify-content: flex-end; }
        .message-row.received { justify-content: flex-start; }
        .message-select { width: 22px; height: 22px; min-width: 22px; border: 2px solid var(--gray-300); border-radius: 50%; cursor: pointer; display: none; align-items: center; justify-content: center; background: var(--white); transition: all 0.15s; flex-shrink: 0; }
        .message-select.show { display: flex; }
        .message-select.checked { background: var(--navy); border-color: var(--navy); }
        .message-select.checked::after { content: '✓'; color: var(--white); font-size: 11px; font-weight: 700; }
        .message-wrapper { display: flex; align-items: flex-end; gap: 8px; max-width: 70%; }
        .message-row.sent .message-wrapper { flex-direction: row-reverse; }
        .message-avatar { width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 100%); display: flex; align-items: center; justify-content: center; color: var(--white); font-size: 11px; font-weight: 700; flex-shrink: 0; overflow: hidden; margin-bottom: 2px; }
        .message-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .message-row.sent .message-avatar { display: none; }
        .message-bubble { padding: 10px 14px; border-radius: 18px; position: relative; cursor: pointer; transition: all 0.15s; }
        .message-row.sent .message-bubble { background: var(--navy); color: var(--white); border-bottom-right-radius: 4px; }
        .message-row.received .message-bubble { background: var(--white); color: var(--gray-800); border-bottom-left-radius: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .message-bubble:hover { transform: scale(1.01); }
        .message-bubble.selected { outline: 3px solid var(--blue); outline-offset: 2px; }
        .message-sender { font-size: 12px; font-weight: 600; color: var(--navy); margin-bottom: 4px; }
        .message-row.sent .message-sender { display: none; }
        .message-text { font-size: 14px; line-height: 1.5; word-wrap: break-word; }
        .message-meta { display: flex; align-items: center; justify-content: flex-end; gap: 4px; margin-top: 4px; }
        .message-time { font-size: 11px; opacity: 0.7; }
        .message-status { font-size: 12px; }
        .chat-input-area { padding: 16px 20px; background: var(--white); border-top: 1px solid var(--gray-200); display: flex; align-items: flex-end; gap: 12px; }
        .chat-input-wrapper { flex: 1; background: var(--gray-100); border-radius: 24px; padding: 4px 16px; display: flex; align-items: flex-end; }
        .chat-input { flex: 1; border: none; background: transparent; font-family: 'Outfit', sans-serif; font-size: 15px; padding: 10px 0; resize: none; max-height: 120px; line-height: 1.4; }
        .chat-input:focus { outline: none; }
        .chat-input::placeholder { color: var(--gray-400); }
        .send-btn { width: 48px; height: 48px; border: none; background: var(--navy); border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; flex-shrink: 0; }
        .send-btn:hover { background: var(--navy-light); transform: scale(1.05); }
        .send-btn:disabled { background: var(--gray-300); cursor: not-allowed; transform: none; }
        .send-btn svg { width: 22px; height: 22px; color: var(--white); }
        .emoji-btn { width: 44px; height: 44px; border: none; background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); border-radius: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; position: relative; transition: all 0.2s; border: 2px solid var(--gray-200); }
        .emoji-btn:hover { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-color: #fbbf24; transform: scale(1.05); }
        .emoji-btn svg { width: 22px; height: 22px; color: var(--gray-600); }
        .emoji-btn:hover svg { color: #f59e0b; }
        .emoji-picker { position: absolute; bottom: calc(100% + 10px); left: 0; background: var(--white); border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); padding: 12px; display: none; z-index: 1000; }
        .emoji-picker.show { display: block; }
        .emoji-grid { display: grid; grid-template-columns: repeat(10, 1fr); gap: 2px; }
        .emoji-item { font-size: 20px; cursor: pointer; padding: 6px; border-radius: 8px; text-align: center; transition: all 0.15s; display: flex; align-items: center; justify-content: center; line-height: 1; width: 32px; height: 32px; }
        .emoji-item:hover { background: var(--gray-100); transform: scale(1.2); }
        .chat-empty { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; background: var(--gray-100); text-align: center; padding: 40px; }
        .chat-empty svg { width: 80px; height: 80px; color: var(--gray-300); margin-bottom: 20px; }
        .chat-empty h3 { font-family: 'Sora', sans-serif; font-size: 20px; font-weight: 700; color: var(--gray-700); margin-bottom: 8px; }
        .chat-empty p { font-size: 14px; color: var(--gray-500); max-width: 300px; }
        .chat-blocked { padding: 16px 20px; background: #fee2e2; text-align: center; }
        .chat-blocked p { color: var(--red); font-size: 14px; font-weight: 500; }
        .topbar { background: var(--white); padding: 12px 20px; display: none; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--gray-200); position: sticky; top: 0; z-index: 50; }
        .topbar-left { display: flex; align-items: center; gap: 12px; }
        .menu-toggle { display: none; background: none; border: none; font-size: 24px; cursor: pointer; color: var(--gray-700); padding: 4px; }
        .page-title { font-family: 'Sora', sans-serif; font-size: 18px; font-weight: 700; color: var(--gray-800); }
        .topbar-right { display: flex; align-items: center; gap: 12px; }
        .icon-btn { position: relative; width: 40px; height: 40px; border-radius: 10px; border: none; background: var(--gray-100); cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .icon-btn svg { width: 20px; height: 20px; color: var(--gray-600); }
        .notification-badge { position: absolute; top: -4px; right: -4px; background: var(--red); color: var(--white); font-size: 10px; font-weight: 700; min-width: 18px; height: 18px; border-radius: 9px; display: flex; align-items: center; justify-content: center; border: 2px solid var(--white); }
        .notification-wrapper { position: relative; }
        .notification-dropdown { position: absolute; top: calc(100% + 8px); left: 0; width: 360px; max-height: 480px; background: var(--white); border-radius: 16px; box-shadow: 0 20px 40px rgba(0,0,0,0.15); opacity: 0; visibility: hidden; transform: translateY(-10px); transition: all 0.2s; z-index: 2000; overflow: hidden; }
        .notification-dropdown.show { opacity: 1; visibility: visible; transform: translateY(0); }
        .notif-dropdown-header { padding: 16px 20px; border-bottom: 1px solid var(--gray-200); display: flex; justify-content: space-between; align-items: center; }
        .notif-dropdown-header h3 { font-size: 16px; font-weight: 700; color: var(--gray-800); }
        .notif-dropdown-header button { background: none; border: none; color: var(--navy); font-size: 13px; font-weight: 600; cursor: pointer; }
        .notif-dropdown-list { max-height: 360px; overflow-y: auto; }
        .notif-dropdown-item { padding: 14px 20px; display: flex; gap: 12px; border-bottom: 1px solid var(--gray-100); cursor: pointer; }
        .notif-dropdown-item.unread { background: var(--blue-light); }
        .notif-icon { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .notif-icon.friend { background: var(--green); color: white; }
        .notif-icon.message { background: var(--blue); color: white; }
        .notif-icon.group { background: #8b5cf6; color: white; }
        .notif-icon.warning { background: #f97316; color: white; }
        .notif-icon svg { width: 18px; height: 18px; stroke: white; }
        .notif-content { flex: 1; min-width: 0; }
        .notif-content h4 { font-size: 14px; font-weight: 600; color: var(--gray-800); margin-bottom: 2px; }
        .notif-content p { font-size: 13px; color: var(--gray-500); }
        .notif-content .time { font-size: 11px; color: var(--gray-400); margin-top: 4px; }
        .notif-dropdown-footer { padding: 12px 20px; border-top: 1px solid var(--gray-200); text-align: center; }
        .notif-dropdown-footer a { color: var(--navy); font-size: 14px; font-weight: 600; text-decoration: none; }
        .notif-empty { padding: 40px 20px; text-align: center; color: var(--gray-400); }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.2s; padding: 20px; }
        .modal-overlay.show { opacity: 1; visibility: visible; }
        .modal { background: var(--white); border-radius: 16px; width: 100%; max-width: 380px; transform: scale(0.9); transition: transform 0.2s; max-height: 90vh; overflow-y: auto; }
        .modal-overlay.show .modal { transform: scale(1); }
        .modal-header { padding: 20px 24px; border-bottom: 1px solid var(--gray-200); display: flex; justify-content: space-between; align-items: center; }
        .modal-title { font-family: 'Sora', sans-serif; font-size: 18px; font-weight: 700; color: var(--gray-800); }
        .modal-close { width: 32px; height: 32px; border: none; background: var(--gray-100); border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .modal-close svg { width: 18px; height: 18px; color: var(--gray-600); }
        .modal-body { padding: 20px; max-height: 400px; overflow-y: auto; }
        .modal-footer { padding: 16px 24px; border-top: 1px solid var(--gray-200); display: flex; justify-content: flex-end; gap: 12px; }
        #profileModalFooter { display: block; border-top: none; padding: 0 20px 20px 20px; }
        .forward-user-item { display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 10px; cursor: pointer; }
        .forward-user-item:hover { background: var(--gray-50); }
        .forward-user-item.selected { background: var(--blue-light); }
        .forward-user-avatar { width: 44px; height: 44px; border-radius: 50%; background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 100%); display: flex; align-items: center; justify-content: center; color: var(--white); font-weight: 700; font-size: 14px; overflow: hidden; }
        .forward-user-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .forward-user-name { font-size: 15px; font-weight: 600; color: var(--gray-800); flex: 1; }
        .forward-check { width: 24px; height: 24px; border: 2px solid var(--gray-300); border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .forward-user-item.selected .forward-check { background: var(--navy); border-color: var(--navy); }
        .forward-user-item.selected .forward-check::after { content: '✓'; color: var(--white); font-size: 14px; }
        .dropdown-menu { position: absolute; top: 100%; right: 0; background: var(--white); border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); min-width: 180px; opacity: 0; visibility: hidden; transform: translateY(-8px); transition: all 0.2s; z-index: 100; overflow: hidden; }
        .dropdown-menu.show { opacity: 1; visibility: visible; transform: translateY(4px); }
        .dropdown-item { display: flex; align-items: center; gap: 10px; padding: 12px 16px; font-size: 14px; color: var(--gray-700); cursor: pointer; }
        .dropdown-item:hover { background: var(--gray-50); }
        .dropdown-item svg { width: 18px; height: 18px; color: var(--gray-500); }
        .dropdown-item.danger { color: var(--red); }
        .dropdown-item.danger svg { color: var(--red); }
        .btn { padding: 10px 18px; border-radius: 10px; font-family: 'Outfit', sans-serif; font-size: 14px; font-weight: 600; cursor: pointer; border: none; display: inline-flex; align-items: center; gap: 6px; }
        .btn-primary { background: var(--navy); color: var(--white); }
        .btn-secondary { background: var(--gray-100); color: var(--gray-700); }
        .btn-danger { background: var(--red); color: var(--white); }
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; font-size: 14px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px; }
        .form-select, .form-textarea { width: 100%; padding: 12px 14px; border: 2px solid var(--gray-200); border-radius: 10px; font-family: 'Outfit', sans-serif; font-size: 14px; }
        .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--navy); }
        .toast { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%) translateY(100px); background: var(--gray-800); color: var(--white); padding: 14px 24px; border-radius: 12px; font-size: 14px; font-weight: 500; display: flex; align-items: center; gap: 10px; z-index: 1000; opacity: 0; transition: all 0.3s ease; }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .toast.error { background: var(--red); }
        .toast.success { background: var(--green); }
        .loading { position: fixed; inset: 0; background: var(--white); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .loading-spinner { width: 40px; height: 40px; border: 3px solid var(--gray-200); border-top-color: var(--navy); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        body.dark-mode { background: var(--gray-800); }
        body.dark-mode .sidebar { background: #0a1628; }
        body.dark-mode .conversations-panel { background: var(--gray-700); border-color: var(--gray-600); }
        body.dark-mode .conversations-header h2 { color: var(--white); }
        body.dark-mode .search-input { background-color: var(--gray-600); border-color: var(--gray-600); color: var(--white); }
        body.dark-mode .conversation-item { border-color: var(--gray-600); }
        body.dark-mode .conv-name { color: var(--white); }
        body.dark-mode .chat-panel { background: var(--gray-800); }
        body.dark-mode .chat-header { background: var(--gray-700); border-color: var(--gray-600); }
        body.dark-mode .chat-user-details h3 { color: var(--white); }
        body.dark-mode .message-wrapper.received .message-bubble { background: var(--gray-700); color: var(--white); }
        body.dark-mode .chat-input-area { background: var(--gray-700); border-color: var(--gray-600); }
        body.dark-mode .chat-input-wrapper { background: var(--gray-600); }
        body.dark-mode .chat-input { color: var(--white); }
        body.dark-mode .modal { background: var(--gray-700); }
        body.dark-mode .modal-title { color: var(--white); }
        @media (max-width: 900px) { 
            .conversations-panel { width: 100%; position: absolute; left: 0; top: 0; bottom: 0; z-index: 10; } 
            .conversations-panel.hidden { display: none; } 
            .chat-panel { position: absolute; left: 0; top: 0; right: 0; bottom: 0; display: none; } 
            .chat-panel.show { display: flex; } 
            .chat-header-back { display: flex; } 
            .topbar { display: flex; }
            .menu-toggle { display: block; }
            .conversations-header { display: none; }
            .conversations-panel { top: 56px; }
        }
        @media (max-width: 768px) { 
            .sidebar { transform: translateX(-100%); } 
            .sidebar.open { transform: translateX(0); } 
            .sidebar-overlay.show { display: block; } 
            .main-content { margin-left: 0; } 
            .notification-dropdown { 
                position: fixed; 
                top: 70px; 
                left: 10px; 
                right: 10px; 
                width: auto; 
                border-radius: 16px; 
                max-height: calc(100vh - 90px); 
                z-index: 2000;
            }
        }
        @media (max-width: 480px) {
            .notification-dropdown {
                top: 60px;
                left: 5px;
                right: 5px;
                max-height: calc(100vh - 70px);
            }
            .chat-header { padding: 10px 12px; }
            .chat-header-actions { gap: 4px; }
            .chat-action-btn { width: 32px; height: 32px; }
            .chat-input-area { padding: 10px 12px; }
            .emoji-btn { width: 38px; height: 38px; }
            .send-btn { width: 42px; height: 42px; }
            .modal { margin: 10px; max-width: calc(100% - 20px) !important; }
            .modal-body { padding: 16px; }
            .modal-footer { padding: 12px 16px; }
            .profile-modal-actions .btn { padding: 14px 16px; font-size: 14px; }
            .profile-modal-actions .btn-row .btn { padding: 12px 14px; font-size: 13px; }
        }
        
        /* Admin Announcement Popup */
        .announcement-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; z-index: 10000; animation: fadeIn 0.3s ease; padding: 20px; }
        .announcement-popup { background: linear-gradient(135deg, #1a365d 0%, #2c5282 100%); border-radius: 20px; max-width: 480px; width: 100%; box-shadow: 0 25px 60px rgba(0,0,0,0.4); animation: popIn 0.4s cubic-bezier(0.175,0.885,0.32,1.275); overflow: hidden; }
        .announcement-header { background: rgba(255,255,255,0.1); padding: 20px 24px; display: flex; align-items: center; gap: 14px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .announcement-icon { width: 48px; height: 48px; background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(249,115,22,0.4); }
        .announcement-icon svg { width: 26px; height: 26px; color: white; }
        .announcement-header-text { flex: 1; }
        .announcement-label { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1.5px; color: #f97316; margin-bottom: 4px; }
        .announcement-title { font-family: 'Sora', sans-serif; font-size: 20px; font-weight: 700; color: white; }
        .announcement-body { padding: 24px; }
        .announcement-message { font-size: 15px; line-height: 1.7; color: rgba(255,255,255,0.9); }
        .announcement-time { font-size: 12px; color: rgba(255,255,255,0.5); margin-top: 16px; display: flex; align-items: center; gap: 6px; }
        .announcement-time svg { width: 14px; height: 14px; }
        .announcement-footer { padding: 16px 24px 24px; }
        .announcement-btn { width: 100%; padding: 16px 24px; background: white; color: #1a365d; border: none; border-radius: 12px; font-family: 'Outfit', sans-serif; font-size: 15px; font-weight: 700; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .announcement-btn:hover { background: #f1f5f9; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .announcement-btn svg { width: 18px; height: 18px; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes popIn { from { opacity: 0; transform: scale(0.9) translateY(20px); } to { opacity: 1; transform: scale(1) translateY(0); } }
    </style>
</head>
<body>
    <div class="loading" id="loadingScreen"><div class="loading-spinner"></div></div>
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">                        <a href="dashboard.html" class="sidebar-logo">
                <div class="sidebar-logo-m-wrapper">
                    <svg class="sidebar-logo-cap" viewBox="0 0 100 70">
                        <polygon points="50,8 95,25 50,42 5,25" fill="#1a365d"/>
                        <circle cx="50" cy="25" r="5" fill="#ffffff" stroke="#1a365d" stroke-width="2"/>
                        <rect x="32" y="38" width="36" height="18" rx="3" fill="#1a365d"/>
                        <g class="tassel">
                            <circle cx="78" cy="25" r="4" fill="#c41e3a"/>
                            <path d="M78 29 Q82 45 80 55" stroke="#c41e3a" stroke-width="3" fill="none"/>
                            <ellipse cx="80" cy="58" rx="5" ry="8" fill="#c41e3a"/>
                        </g>
                    </svg>
                    <span class="sidebar-logo-m">M</span>
                </div>
                <span class="sidebar-logo-yub">yUB</span>
            </a></div>
        <nav>
            <div class="nav-section"><div class="nav-section-title">Menu</div><a href="dashboard.html" class="nav-item"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>Dashboard</a><a href="gpa-calculator.html" class="nav-item"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>GPA Calculator</a><a href="schedule.html" class="nav-item"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>Schedule</a><a href="notes.html" class="nav-item"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>Notes</a></div>
            <div class="nav-section"><div class="nav-section-title">Social</div><a href="study-groups.html" class="nav-item"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/></svg>Study Groups</a><a href="messages.html" class="nav-item active"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>Messages<span class="badge" id="sidebarMsgBadge" style="display:none;">0</span></a><a href="friends.html" class="nav-item"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>Friends<span class="badge" id="sidebarFriendsBadge" style="display:none;">0</span></a></div>
            <div class="nav-section"><div class="nav-section-title">Account</div><a href="profile.html" class="nav-item"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>Profile</a><button class="nav-item" onclick="handleLogout()"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>Sign Out</button></div>
        </nav>
    </aside>
    <main class="main-content" id="mainContent" style="display: none;">
        <header class="topbar"><div class="topbar-left"><button class="menu-toggle" onclick="toggleSidebar()">☰</button><h1 class="page-title">Messages</h1></div><div class="topbar-right"><div class="notification-wrapper"><button class="icon-btn" onclick="toggleNotifications(event)"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/></svg><span class="notification-badge" id="notifBadge" style="display: none;">0</span></button><div class="notification-dropdown" id="notificationDropdown"><div class="notif-dropdown-header"><h3>Notifications</h3><button onclick="markAllNotificationsRead()">Mark all read</button></div><div class="notif-dropdown-list" id="notifList"></div><div class="notif-dropdown-footer"><a onclick="openNotificationsModal()" style="cursor:pointer;">View All Notifications</a></div></div></div><button class="new-chat-btn" onclick="openNewChatModal()" title="New Chat"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 4v16m8-8H4"/></svg></button></div></header>
        <div class="messages-container">
            <div class="conversations-panel" id="conversationsPanel"><div class="conversations-header"><h2>Messages</h2><div style="display:flex;gap:8px;align-items:center;"><div class="notification-wrapper" style="position:relative;"><button class="new-chat-btn" onclick="toggleNotifications(event)" title="Notifications" style="background:var(--gray-100);"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" style="color:var(--gray-600);"><path d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/></svg><span class="notification-badge" id="notifBadge3" style="display:none;position:absolute;top:-4px;right:-4px;background:var(--red);color:white;font-size:10px;font-weight:700;padding:2px 6px;border-radius:10px;min-width:16px;text-align:center;">0</span></button><div class="notification-dropdown" id="notificationDropdown3" style="z-index:9999;"><div class="notif-dropdown-header"><h3>Notifications</h3><button onclick="markAllNotificationsRead()">Mark all read</button></div><div class="notif-dropdown-list" id="notifList3"></div><div class="notif-dropdown-footer"><a onclick="openNotificationsModal()" style="cursor:pointer;">View All Notifications</a></div></div></div><button class="new-chat-btn" onclick="openNewChatModal()" title="New Chat"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 4v16m8-8H4"/></svg></button></div></div><div class="conversations-search"><input type="text" class="search-input" id="convSearch" placeholder="Search conversations..." oninput="filterConversations()"></div><div class="conversations-list" id="conversationsList"></div></div>
            <div class="chat-panel" id="chatPanel">
                <div class="selection-header" id="selectionHeader"><span class="selection-count" id="selectionCount">0 selected</span><div class="selection-actions"><button class="selection-btn report" onclick="reportSelectedMessages()"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>Report</button><button class="selection-btn forward" onclick="openForwardModal()"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M13 5l7 7-7 7M5 5l7 7-7 7"/></svg>Forward</button><button class="selection-btn delete" onclick="deleteSelectedMessages()"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>Delete</button><button class="selection-btn cancel" onclick="exitSelectionMode()">Cancel</button></div></div>
                <div class="chat-header" id="chatHeader" style="display: none;"><button class="chat-header-back" onclick="backToConversations()"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M15 19l-7-7 7-7"/></svg></button><div class="chat-user-info" onclick="viewUserProfile()"><div class="chat-avatar" id="chatAvatar"><span id="chatAvatarText">--</span><div class="online-dot" id="chatOnlineDot"></div></div><div class="chat-user-details"><h3 id="chatUserName">Loading...</h3><div class="chat-user-status" id="chatUserStatus">Online</div></div></div><div class="chat-header-actions"><button class="chat-action-btn" onclick="enterSelectionMode()" title="Select"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/></svg></button><div style="position: relative;"><button class="chat-action-btn" onclick="toggleChatMenu(event)"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"/></svg></button><div class="dropdown-menu" id="chatMenu"><div class="dropdown-item" onclick="viewUserProfile()"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>View Profile</div><div class="dropdown-item" onclick="clearConversation()"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>Clear Chat</div><div class="dropdown-item danger" onclick="deleteConversation()"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"/></svg>Delete Conversation</div></div></div></div></div>
                <div class="chat-blocked" id="chatBlocked" style="display: none;"><p id="blockedMessage">You cannot send messages to this user.</p></div>
                <div class="chat-messages" id="chatMessages"></div>
                <div class="chat-input-area" id="chatInputArea" style="display: none;"><button class="emoji-btn" onclick="toggleEmojiPicker(event)"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg><div class="emoji-picker" id="emojiPicker"></div></button><div class="chat-input-wrapper"><textarea class="chat-input" id="messageInput" placeholder="Type a message..." rows="1" oninput="autoResize(this)"></textarea></div><button class="send-btn" id="sendBtn" onclick="sendMessage()" disabled><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg></button></div>
                <div class="chat-empty" id="chatEmpty"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg><h3>Select a conversation</h3><p>Choose a conversation or start a new chat</p></div>
            </div>
        </div>
    </main>
    <div class="modal-overlay" id="forwardModal"><div class="modal"><div class="modal-header"><h3 class="modal-title">Forward Messages</h3><button class="modal-close" onclick="closeForwardModal()"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12"/></svg></button></div><div class="modal-body" id="forwardUserList"></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeForwardModal()">Cancel</button><button class="btn btn-primary" id="forwardBtn" onclick="forwardMessages()" disabled>Forward</button></div></div></div>
    <div class="modal-overlay" id="reportModal"><div class="modal"><div class="modal-header"><h3 class="modal-title">Report Messages</h3><button class="modal-close" onclick="closeReportModal()"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12"/></svg></button></div><div class="modal-body"><p style="color: var(--gray-600); margin-bottom: 16px; font-size: 14px;">Report inappropriate messages to keep MyUB safe.</p><div class="form-group"><label class="form-label">Reason</label><select class="form-select" id="reportReason"><option value="">Select a reason...</option><option value="spam">Spam</option><option value="harassment">Harassment</option><option value="hate_speech">Hate speech</option><option value="inappropriate_content">Inappropriate content</option><option value="threatening_violence">Threatening violence</option><option value="other">Other</option></select></div><div class="form-group"><label class="form-label">Additional details</label><textarea class="form-textarea" id="reportDescription" placeholder="Provide context..." rows="3"></textarea></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeReportModal()">Cancel</button><button class="btn btn-danger" onclick="submitReport()">Submit Report</button></div></div></div>
    <div class="modal-overlay" id="confirmModal"><div class="modal" style="max-width: 360px;"><div class="modal-header"><h3 class="modal-title" id="confirmTitle">Confirm</h3><button class="modal-close" onclick="closeConfirmModal()"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12"/></svg></button></div><div class="modal-body"><p id="confirmMessage" style="text-align: center; color: var(--gray-600);">Are you sure?</p></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeConfirmModal()">Cancel</button><button class="btn btn-danger" onclick="confirmAction()">Confirm</button></div></div></div>
    
    <!-- New Chat Modal -->
    <div class="modal-overlay" id="newChatModal">
        <div class="modal" style="max-width: 480px;">
            <div class="modal-header"><h3 class="modal-title">New Chat</h3><button class="modal-close" onclick="closeNewChatModal()"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12"/></svg></button></div>
            <div class="modal-body" style="padding: 0;">
                <div class="new-chat-search"><input type="text" class="search-input" id="userSearchInput" placeholder="Search users by name or program..." oninput="searchUsers()"></div>
                <div class="new-chat-results" id="userSearchResults"><div class="search-placeholder"><svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg><p>Search for users to start a conversation</p></div></div>
            </div>
        </div>
    </div>

    <!-- Profile Preview Modal -->
    <div class="modal-overlay" id="profileModal">
        <div class="modal" style="max-width: 420px;">
            <div class="modal-header"><h3 class="modal-title">Profile</h3><button class="modal-close" onclick="closeProfileModal()"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12"/></svg></button></div>
            <div class="modal-body" id="profileModalBody"></div>
            <div class="modal-footer" id="profileModalFooter"></div>
        </div>
    </div>

    <!-- User Report Modal -->
    <div class="modal-overlay" id="userReportModal">
        <div class="modal">
            <div class="modal-header"><h3 class="modal-title">Report User</h3><button class="modal-close" onclick="closeUserReportModal()"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12"/></svg></button></div>
            <div class="modal-body">
                <p style="color: var(--gray-600); margin-bottom: 16px; font-size: 14px;">Report this user for violating community guidelines.</p>
                <div class="form-group"><label class="form-label">Reason</label><select class="form-select" id="userReportReason"><option value="">Select a reason...</option><option value="spam">Spam or fake account</option><option value="harassment">Harassment or bullying</option><option value="hate_speech">Hate speech</option><option value="inappropriate_content">Inappropriate content</option><option value="impersonation">Impersonation</option><option value="threatening_violence">Threatening violence</option><option value="other">Other</option></select></div>
                <div class="form-group"><label class="form-label">Additional details</label><textarea class="form-textarea" id="userReportDescription" placeholder="Provide context..." rows="3"></textarea></div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeUserReportModal()">Cancel</button><button class="btn btn-danger" onclick="submitUserReport()">Submit Report</button></div>
        </div>
    </div>
    
    <!-- All Notifications Modal -->
    <div class="modal-overlay" id="notificationsModal" onclick="if(event.target===this)closeNotificationsModal()">
        <div class="modal" style="max-width:500px;max-height:80vh;display:flex;flex-direction:column;">
            <div class="modal-header"><h3 class="modal-title">All Notifications</h3><button class="modal-close" onclick="closeNotificationsModal()"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12"/></svg></button></div>
            <div style="display:flex;gap:10px;padding:16px 24px;border-bottom:1px solid var(--gray-200);">
                <button class="btn btn-secondary" onclick="markAllNotificationsReadModal()">Mark All Read</button>
                <button class="btn" style="background:#fee2e2;color:#dc2626;border:1px solid #fecaca;" onclick="clearAllNotifications()">Clear All</button>
            </div>
            <div class="modal-body" id="allNotifList" style="flex:1;overflow-y:auto;padding:0;"></div>
        </div>
    </div>
    
    <div class="toast" id="toast"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M5 13l4 4L19 7"/></svg><span id="toastMessage">Success!</span></div>
    <script>
        const SUPABASE_URL = 'https://weuxtwmaqmbhskjpjdyi.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndldXh0d21hcW1iaHNranBqZHlpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3NTYzMTcsImV4cCI6MjA4MDMzMjMxN30.J-0Nd0MY6-g_ltbBNHwOulqZuQfb8mKIRgx0dAaJ76o';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const EMOJIS = ['😀','😂','😊','😍','🥰','😎','🤔','😮','😢','😡','👍','👎','❤️','🔥','⭐','🎉','💯','🙌','👏','💪','🤝','🙏','✨','💡','📚','✅','❌','⚠️','💬','📝'];

        let currentUser = null, conversations = [], currentConversation = null, currentChatUser = null;
        let messages = [], notifications = [], friends = [], blockedUsers = [], blockedByUsers = [];
        let selectedMessages = new Set(), isSelectionMode = false, confirmCallback = null, forwardToUsers = new Set();
        let friendIds = [], outgoingRequestIds = [], incomingRequestIds = [];
        let selectedProfileUser = null;
        
        // Notification sound with higher volume
        const notificationSound = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2teleVlhjtXr4JlYMTlqqdTm2I1LIzWFxevnvGw8KVmW1+3iomA4M2yq2erem1AkLnayz/Dgo2I2L2qm1ebgjU4pOIK+3eTCaz0nVprU5d6RUSktiL/i58mFWDQ4daTU4NqJSyQwhL7j5sSAUjI1cZ/Q3dWFSiYvgbzh5L5+Ty42bpzO2tKBRyUsgrrg4rx7TS00a5nL1s5+RiQrfbff4bh4Sis0Z5XI0sl7RSMpebjc37V1SCo0ZJLFzsZ4QyInc7TZ3LFyRSgzYY/Cyr51QiIldLHW2a5vQicyXoy/x7pzQCEjca3T1qprPyYwW4m8xLdxPyAhbqrQz6RmPiUuWIa5wa1sPR8fa6bMzqFkPCQsVYO2wKpqOx4daKLIypxhOyMrUn+zvqZnOhwbZZ7Fx5hfOSIpT3yxvKNkOBsZYprCw5VcNyEnS3muuZ5hNhkYX5a/wJJaNiAlSHaqtppeMxgWXJK8vY9YNCAfQ3GmspVaMBcVWY65uoxWMyAdQG6jrpFWLhUUV4q1t4lTMh8cPmufrI1SLBQTVIaysoZQMRscPGebqIlOKhITV4OuqH5JLRkaNmCVo4RJKBETVYCqpHtGKxgYNF2SmYBGJhASU32no3hDKRYXMlqPlHxDJRAQUHqjnnU/JhUWMFeNkHk/Ig4PUXennXI9JBMULlOKjHY8IA0OUXWS');
        notificationSound.volume = 0.3;

        function initEmojiPicker() {
            const picker = document.getElementById('emojiPicker');
            if (!picker) return;
            let html = '<div class="emoji-grid">';
            EMOJIS.forEach(e => { html += '<div class="emoji-item" onclick="insertEmoji(\'' + e + '\')">' + e + '</div>'; });
            html += '</div>';
            picker.innerHTML = html;
        }
        
        function toggleEmojiPicker(e) {
            if (e) e.stopPropagation();
            const picker = document.getElementById('emojiPicker');
            picker.classList.toggle('show');
        }
        
        function insertEmoji(emoji) {
            const input = document.getElementById('messageInput');
            const start = input.selectionStart;
            const end = input.selectionEnd;
            const text = input.value;
            input.value = text.substring(0, start) + emoji + text.substring(end);
            input.selectionStart = input.selectionEnd = start + emoji.length;
            input.focus();
            document.getElementById('sendBtn').disabled = !input.value.trim();
        }

        let deletedConversations = {}; // Map of other_user_id -> deleted_at timestamp

        async function init() {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) { window.location.href = 'index.html'; return; }
            currentUser = session.user;
            
            // Initialize connection manager (checks server capacity)
            if (window.MyUBUtils) {
                const canConnect = await MyUBUtils.ConnectionManager.init(supabase, currentUser.id);
                if (!canConnect) {
                    document.getElementById('loadingScreen').style.display = 'none';
                    return; // User in queue
                }
                // Use consolidated subscriptions
                MyUBUtils.SubscriptionManager.init(supabase, currentUser.id);
                MyUBUtils.SubscriptionManager.subscribe({
                    messages: () => { loadConversations(); loadSidebarFriendsBadge(); },
                    notifications: () => loadNotifications(),
                    friend_requests: () => { loadFriendRequests(); loadSidebarFriendsBadge(); }
                });
            }
            
            if (localStorage.getItem('myub_darkMode') === 'true') document.body.classList.add('dark-mode');
            await updateOnlineStatus(true);
            await loadDeletedConversations();
            await Promise.all([loadConversations(), loadFriends(), loadBlockedUsers(), loadNotifications(), loadFriendRequests(), loadSidebarFriendsBadge()]);
            subscribeToRealtime(); // Setup real-time subscriptions
            startHeartbeat();
            startNotificationPolling(); // Poll for notifications as fallback
            initEmojiPicker();
            const urlParams = new URLSearchParams(window.location.search);
            const userId = urlParams.get('user');
            if (userId) await openConversation(userId);
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('mainContent').style.display = 'flex';
            document.addEventListener('click', handleOutsideClick);
            document.getElementById('messageInput').addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });
        }
        
        function startNotificationPolling() {
            setInterval(async () => {
                const lastNotifId = notifications.length > 0 ? notifications[0].id : null;
                const { data: newNotifs } = await supabase.from('notifications').select('*').eq('user_id', currentUser.id).order('created_at', { ascending: false }).limit(5);
                if (newNotifs && newNotifs.length > 0 && (!lastNotifId || newNotifs[0].id !== lastNotifId)) {
                    const existingIds = notifications.map(n => n.id);
                    const trulyNew = newNotifs.filter(n => !existingIds.includes(n.id));
                    if (trulyNew.length > 0) {
                        trulyNew.forEach(n => notifications.unshift(n));
                        renderNotifications();
                        playNotificationSound();
                        showToast(trulyNew[0].title || 'New notification', 'success');
                    }
                }
            }, 30000);
        }

        async function updateOnlineStatus(isOnline) { await supabase.from('profiles').update({ is_online: isOnline, last_seen: new Date().toISOString() }).eq('id', currentUser.id); }
        function startHeartbeat() { setInterval(() => updateOnlineStatus(true), 30000); window.addEventListener('beforeunload', () => updateOnlineStatus(false)); }

        async function loadDeletedConversations() {
            const { data } = await supabase.from('deleted_conversations').select('other_user_id, deleted_at').eq('user_id', currentUser.id);
            deletedConversations = {};
            (data || []).forEach(d => { 
                // Store as timestamp for consistent comparison
                deletedConversations[d.other_user_id] = new Date(d.deleted_at).getTime(); 
            });
        }

        async function loadConversations() {
            // Reload deleted conversations to ensure we have latest data
            await loadDeletedConversations();
            
            const { data: sentMsgs } = await supabase.from('messages').select('receiver_id, content, created_at, is_read').eq('sender_id', currentUser.id).is('group_id', null).neq('is_deleted', true).order('created_at', { ascending: false });
            const { data: receivedMsgs } = await supabase.from('messages').select('sender_id, content, created_at, is_read').eq('receiver_id', currentUser.id).is('group_id', null).neq('is_deleted', true).order('created_at', { ascending: false });
            const convMap = new Map();
            
            // Process sent messages - filter by deleted timestamp
            (sentMsgs || []).forEach(msg => { 
                const oderId = msg.receiver_id; 
                const deletedAt = deletedConversations[oderId];
                const msgTime = new Date(msg.created_at).getTime();
                // Skip if message was created before or at deletion time
                if (deletedAt && msgTime <= deletedAt) return;
                
                if (!convMap.has(oderId) || new Date(msg.created_at) > new Date(convMap.get(oderId).lastMessageTime)) 
                    convMap.set(oderId, { oderId, lastMessage: msg.content, lastMessageTime: msg.created_at, unreadCount: convMap.get(oderId)?.unreadCount || 0 }); 
            });
            
            // Process received messages - filter by deleted timestamp
            (receivedMsgs || []).forEach(msg => { 
                const oderId = msg.sender_id; 
                const deletedAt = deletedConversations[oderId];
                const msgTime = new Date(msg.created_at).getTime();
                // Skip if message was created before or at deletion time
                if (deletedAt && msgTime <= deletedAt) return;
                
                const existing = convMap.get(oderId); 
                const unreadCount = (existing?.unreadCount || 0) + (msg.is_read ? 0 : 1); 
                if (!existing || new Date(msg.created_at) > new Date(existing.lastMessageTime)) 
                    convMap.set(oderId, { oderId, lastMessage: msg.content, lastMessageTime: msg.created_at, unreadCount }); 
                else if (existing) existing.unreadCount = unreadCount; 
            });
            
            const userIds = Array.from(convMap.keys());
            if (userIds.length > 0) { const { data: profiles } = await supabase.from('profiles').select('id, first_name, last_name, full_name, avatar_url, is_online, last_seen').in('id', userIds); conversations = Array.from(convMap.values()).map(conv => { const profile = profiles?.find(p => p.id === conv.oderId); return { ...conv, user: profile }; }).filter(c => c.user).sort((a, b) => new Date(b.lastMessageTime) - new Date(a.lastMessageTime)); }
            else conversations = [];
            renderConversations(); updateUnreadBadge();
        }

        async function loadFriends() {
            const { data: f1 } = await supabase.from('friendships').select('friend_id').eq('user_id', currentUser.id);
            const { data: f2 } = await supabase.from('friendships').select('user_id').eq('friend_id', currentUser.id);
            const ids = [...(f1||[]).map(f => f.friend_id), ...(f2||[]).map(f => f.user_id)];
            friendIds = ids; // Update global friendIds
            if (ids.length > 0) { const { data: profiles } = await supabase.from('profiles').select('id, first_name, last_name, full_name, avatar_url, is_online').in('id', ids); friends = profiles || []; }
            else friends = [];
        }

        async function loadBlockedUsers() {
            const { data: blocked } = await supabase.from('blocked_users').select('blocked_id').eq('blocker_id', currentUser.id);
            blockedUsers = (blocked || []).map(b => b.blocked_id);
            const { data: blockedBy } = await supabase.from('blocked_users').select('blocker_id').eq('blocked_id', currentUser.id);
            blockedByUsers = (blockedBy || []).map(b => b.blocker_id);
        }

        async function loadFriendRequests() {
            const { data: outgoing } = await supabase.from('friend_requests').select('receiver_id').eq('sender_id', currentUser.id).eq('status', 'pending');
            outgoingRequestIds = (outgoing || []).map(r => r.receiver_id);
            const { data: incoming } = await supabase.from('friend_requests').select('sender_id').eq('receiver_id', currentUser.id).eq('status', 'pending');
            incomingRequestIds = (incoming || []).map(r => r.sender_id);
        }

        async function loadMessages(userId) {
            // Check if conversation was deleted - only show messages after deletion time
            const deletedAt = deletedConversations[userId];
            let query = supabase.from('messages').select('*')
                .or(`and(sender_id.eq.${currentUser.id},receiver_id.eq.${userId}),and(sender_id.eq.${userId},receiver_id.eq.${currentUser.id})`)
                .is('group_id', null)
                .order('created_at', { ascending: true });
            
            // If conversation was deleted, only get messages after that time
            if (deletedAt) {
                // Convert timestamp back to ISO string for query
                const deletedAtISO = new Date(deletedAt).toISOString();
                query = query.gt('created_at', deletedAtISO);
            }
            
            const { data } = await query;
            messages = data || []; 
            renderMessages();
            await supabase.from('messages').update({ is_read: true }).eq('sender_id', userId).eq('receiver_id', currentUser.id).eq('is_read', false);
            const conv = conversations.find(c => c.oderId === userId); if (conv) conv.unreadCount = 0;
            renderConversations(); updateUnreadBadge();
        }

        function renderConversations() {
            const container = document.getElementById('conversationsList');
            const searchQuery = document.getElementById('convSearch').value.toLowerCase();
            const filtered = conversations.filter(c => { if (!c.user) return false; const name = (c.user.full_name || `${c.user.first_name} ${c.user.last_name}`).toLowerCase(); return name.includes(searchQuery); });
            if (filtered.length === 0) { container.innerHTML = `<div class="conversations-empty"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg><h3>${searchQuery ? 'No conversations found' : 'No messages yet'}</h3><p>${searchQuery ? 'Try a different search' : 'Start chatting with friends!'}</p></div>`; return; }
            container.innerHTML = filtered.map(conv => { const user = conv.user; const name = user.full_name || `${user.first_name} ${user.last_name}`; const initials = getInitials(name); const isActive = currentChatUser?.id === user.id; const timeStr = formatConvTime(conv.lastMessageTime); return `<div class="conversation-item ${isActive ? 'active' : ''} ${conv.unreadCount > 0 ? 'unread' : ''}" onclick="openConversation('${user.id}')"><div class="conv-avatar">${user.avatar_url ? `<img src="${user.avatar_url}" alt="">` : initials}<div class="conv-online ${user.is_online ? '' : 'offline'}"></div></div><div class="conv-info"><div class="conv-name">${escapeHtml(name)}</div><div class="conv-preview">${escapeHtml(truncate(conv.lastMessage, 35))}</div></div><div class="conv-meta"><div class="conv-time">${timeStr}</div>${conv.unreadCount > 0 ? `<div class="conv-unread-badge">${conv.unreadCount}</div>` : ''}</div></div>`; }).join('');
        }

        function renderMessages() {
            const container = document.getElementById('chatMessages');
            if (messages.length === 0) { container.innerHTML = '<div style="text-align:center;padding:40px;color:var(--gray-400);">No messages yet. Say hello! 👋</div>'; return; }
            let html = '', lastDate = null;
            messages.forEach(msg => {
                const msgDate = new Date(msg.created_at).toDateString();
                if (msgDate !== lastDate) { html += `<div class="chat-date-divider"><span>${formatDateDivider(msg.created_at)}</span></div>`; lastDate = msgDate; }
                const isSent = msg.sender_id === currentUser.id, isSelected = selectedMessages.has(msg.id), time = formatMessageTime(msg.created_at);
                html += `<div class="message-row ${isSent ? 'sent' : 'received'}" data-id="${msg.id}">
                    <div class="message-select ${isSelectionMode ? 'show' : ''} ${isSelected ? 'checked' : ''}" onclick="toggleMessageSelect('${msg.id}')"></div>
                    <div class="message-wrapper">
                        ${!isSent ? `<div class="message-avatar">${currentChatUser?.avatar_url ? `<img src="${currentChatUser.avatar_url}">` : getInitials(currentChatUser?.full_name || currentChatUser?.first_name || 'U')}</div>` : ''}
                        <div class="message-bubble ${isSelected ? 'selected' : ''}" onclick="handleMessageClick(event, '${msg.id}')">
                            ${!isSent ? `<div class="message-sender">${escapeHtml(currentChatUser?.first_name || 'User')}</div>` : ''}
                            <div class="message-text">${escapeHtml(msg.content)}</div>
                            <div class="message-meta">
                                <span class="message-time">${time}</span>
                                ${isSent ? `<span class="message-status">${msg.is_read ? '✓✓' : '✓'}</span>` : ''}
                            </div>
                        </div>
                    </div>
                </div>`;
            });
            container.innerHTML = html; container.scrollTop = container.scrollHeight;
        }

        function filterConversations() { renderConversations(); }

        async function openConversation(userId) {
            // Reload deleted conversations to ensure we have latest data
            await loadDeletedConversations();
            
            const { data: user } = await supabase.from('profiles').select('id, first_name, last_name, full_name, avatar_url, is_online, last_seen').eq('id', userId).single();
            if (!user) { showToast('User not found', 'error'); return; }
            currentChatUser = user; currentConversation = userId;
            const name = user.full_name || `${user.first_name} ${user.last_name}`;
            document.getElementById('chatUserName').textContent = name;
            const avatarEl = document.getElementById('chatAvatar');
            avatarEl.innerHTML = user.avatar_url ? `<img src="${user.avatar_url}" alt=""><div class="online-dot ${user.is_online ? '' : 'offline'}"></div>` : `<span>${getInitials(name)}</span><div class="online-dot ${user.is_online ? '' : 'offline'}"></div>`;
            const statusEl = document.getElementById('chatUserStatus');
            statusEl.textContent = user.is_online ? 'Online' : (user.last_seen ? `Last seen ${formatTimeAgo(user.last_seen)}` : 'Offline');
            statusEl.className = 'chat-user-status' + (user.is_online ? '' : ' offline');
            const isBlocked = blockedUsers.includes(userId), isBlockedBy = blockedByUsers.includes(userId);
            if (isBlocked || isBlockedBy) { document.getElementById('chatBlocked').style.display = 'block'; document.getElementById('blockedMessage').textContent = isBlocked ? 'You blocked this user.' : 'You cannot message this user.'; document.getElementById('chatInputArea').style.display = 'none'; }
            else { document.getElementById('chatBlocked').style.display = 'none'; document.getElementById('chatInputArea').style.display = 'flex'; }
            document.getElementById('chatEmpty').style.display = 'none'; document.getElementById('chatHeader').style.display = 'flex'; document.getElementById('chatMessages').style.display = 'flex';
            document.getElementById('conversationsPanel').classList.add('hidden'); document.getElementById('chatPanel').classList.add('show');
            await loadMessages(userId); renderConversations(); exitSelectionMode();
        }

        function backToConversations() { document.getElementById('conversationsPanel').classList.remove('hidden'); document.getElementById('chatPanel').classList.remove('show'); currentConversation = null; currentChatUser = null; }

        // ========== VALIDATION ==========
        const badWords = ['fuck', 'shit', 'ass', 'bitch', 'damn', 'crap', 'piss', 'dick', 'cock', 'pussy', 'asshole', 'bastard', 'slut', 'whore', 'nigger', 'nigga', 'fag', 'faggot', 'retard', 'cunt', 'twat', 'wanker', 'bollocks', 'arse', 'motherfucker', 'fucker'];
        function containsBadWords(text) { if (!text) return false; const lower = text.toLowerCase(); return badWords.some(word => new RegExp('\\b' + word + '\\b', 'i').test(lower)); }
        
        async function sendMessage() {
            const input = document.getElementById('messageInput'), content = input.value.trim();
            if (!content || !currentConversation) return;
            if (blockedUsers.includes(currentConversation) || blockedByUsers.includes(currentConversation)) { showToast('Cannot message this user', 'error'); return; }
            
            // Validate message content
            if (content.length > 5000) { showToast('Message is too long (max 5000 characters)', 'error'); return; }
            if (containsBadWords(content)) { showToast('Message contains inappropriate language', 'error'); return; }
            
            try {
                const { data, error } = await supabase.from('messages').insert({ sender_id: currentUser.id, receiver_id: currentConversation, content, message_type: 'text' }).select().single();
                if (error) throw error;
                input.value = ''; input.style.height = 'auto'; document.getElementById('sendBtn').disabled = true;
                messages.push(data); renderMessages(); await loadConversations();
                await supabase.from('notifications').insert({ user_id: currentConversation, type: 'message', title: 'New Message', body: content.substring(0, 50) });
            } catch (e) { showToast('Failed to send', 'error'); }
        }

        function autoResize(el) { el.style.height = 'auto'; el.style.height = Math.min(el.scrollHeight, 120) + 'px'; document.getElementById('sendBtn').disabled = !el.value.trim(); }

        function enterSelectionMode() { isSelectionMode = true; selectedMessages.clear(); document.getElementById('selectionHeader').classList.add('show'); document.getElementById('chatHeader').style.display = 'none'; updateSelectionCount(); renderMessages(); }
        function exitSelectionMode() { isSelectionMode = false; selectedMessages.clear(); document.getElementById('selectionHeader').classList.remove('show'); if (currentChatUser) document.getElementById('chatHeader').style.display = 'flex'; renderMessages(); }
        function toggleMessageSelect(msgId) { if (selectedMessages.has(msgId)) selectedMessages.delete(msgId); else selectedMessages.add(msgId); updateSelectionCount(); renderMessages(); }
        function handleMessageClick(event, msgId) { if (isSelectionMode) { event.stopPropagation(); toggleMessageSelect(msgId); } }
        function updateSelectionCount() { document.getElementById('selectionCount').textContent = `${selectedMessages.size} selected`; }

        function deleteSelectedMessages() {
            if (selectedMessages.size === 0) { showToast('No messages selected', 'error'); return; }
            document.getElementById('confirmTitle').textContent = 'Delete Messages';
            document.getElementById('confirmMessage').textContent = `Delete ${selectedMessages.size} message(s)?`;
            confirmCallback = async () => { await supabase.from('messages').update({ is_deleted: true }).in('id', Array.from(selectedMessages)).eq('sender_id', currentUser.id); showToast('Messages deleted'); closeConfirmModal(); exitSelectionMode(); await loadMessages(currentConversation); };
            document.getElementById('confirmModal').classList.add('show');
        }

        function clearConversation() {
            const convToClear = currentConversation;
            if (!convToClear) return;
            
            document.getElementById('confirmTitle').textContent = 'Clear Chat';
            document.getElementById('confirmMessage').textContent = 'Clear all messages in this conversation? (Only clears for you)';
            confirmCallback = async () => { 
                // Insert or update deleted_conversations with current timestamp
                const now = new Date().toISOString();
                const nowTimestamp = new Date(now).getTime();
                
                const { error } = await supabase.from('deleted_conversations')
                    .upsert({ 
                        user_id: currentUser.id, 
                        other_user_id: convToClear, 
                        deleted_at: now 
                    }, { onConflict: 'user_id,other_user_id' });
                
                if (error) {
                    console.error('Clear error:', error);
                    showToast('Failed to clear chat', 'error');
                    closeConfirmModal();
                    return;
                }
                
                // Update local state with timestamp
                deletedConversations[convToClear] = nowTimestamp;
                
                // Clear messages array
                messages = []; 
                renderMessages();
                
                // Remove from conversations list
                conversations = conversations.filter(c => c.oderId !== convToClear && c.user?.id !== convToClear);
                renderConversations();
                
                // Reset chat panel to empty state
                currentConversation = null;
                currentChatUser = null;
                document.getElementById('chatHeader').style.display = 'none';
                document.getElementById('chatMessages').style.display = 'none';
                document.getElementById('chatInputArea').style.display = 'none';
                document.getElementById('chatBlocked').style.display = 'none';
                document.getElementById('chatEmpty').style.display = 'flex';
                
                showToast('Chat cleared'); 
                closeConfirmModal(); 
                closeChatMenu(); 
            };
            document.getElementById('confirmModal').classList.add('show');
        }

        function deleteConversation() {
            const convToDelete = currentConversation;
            if (!convToDelete) return;
            
            document.getElementById('confirmTitle').textContent = 'Delete Conversation';
            document.getElementById('confirmMessage').textContent = 'Delete this conversation? (Only deletes for you)';
            confirmCallback = async () => { 
                // Insert or update deleted_conversations with current timestamp
                const now = new Date().toISOString();
                const nowTimestamp = new Date(now).getTime();
                
                const { error } = await supabase.from('deleted_conversations')
                    .upsert({ 
                        user_id: currentUser.id, 
                        other_user_id: convToDelete, 
                        deleted_at: now 
                    }, { onConflict: 'user_id,other_user_id' });
                
                if (error) {
                    console.error('Delete error:', error);
                    showToast('Failed to delete conversation', 'error');
                    closeConfirmModal();
                    return;
                }
                
                // Update local state with timestamp
                deletedConversations[convToDelete] = nowTimestamp;
                messages = [];
                
                // Remove from conversations list
                conversations = conversations.filter(c => c.oderId !== convToDelete && c.user?.id !== convToDelete);
                renderConversations();
                
                // Reset chat panel
                currentConversation = null;
                currentChatUser = null;
                
                // Show empty state
                document.getElementById('chatHeader').style.display = 'none';
                document.getElementById('chatMessages').style.display = 'none';
                document.getElementById('chatInputArea').style.display = 'none';
                document.getElementById('chatBlocked').style.display = 'none';
                document.getElementById('chatEmpty').style.display = 'flex';
                
                showToast('Conversation deleted'); 
                closeConfirmModal(); 
                closeChatMenu(); 
            };
            document.getElementById('confirmModal').classList.add('show');
        }

        function openForwardModal() { if (selectedMessages.size === 0) { showToast('No messages selected', 'error'); return; } forwardToUsers.clear(); renderForwardUserList(); document.getElementById('forwardModal').classList.add('show'); }
        function closeForwardModal() { document.getElementById('forwardModal').classList.remove('show'); forwardToUsers.clear(); }
        function renderForwardUserList() {
            const container = document.getElementById('forwardUserList');
            if (friends.length === 0) { container.innerHTML = '<p style="text-align:center;color:var(--gray-500);padding:20px;">No friends to forward to</p>'; return; }
            container.innerHTML = friends.filter(f => f.id !== currentConversation).map(f => { const name = f.full_name || `${f.first_name} ${f.last_name}`; const isSelected = forwardToUsers.has(f.id); return `<div class="forward-user-item ${isSelected ? 'selected' : ''}" onclick="toggleForwardUser('${f.id}')"><div class="forward-user-avatar">${f.avatar_url ? `<img src="${f.avatar_url}">` : getInitials(name)}</div><div class="forward-user-name">${escapeHtml(name)}</div><div class="forward-check"></div></div>`; }).join('');
        }
        function toggleForwardUser(userId) { if (forwardToUsers.has(userId)) forwardToUsers.delete(userId); else forwardToUsers.add(userId); renderForwardUserList(); document.getElementById('forwardBtn').disabled = forwardToUsers.size === 0; }
        async function forwardMessages() {
            if (forwardToUsers.size === 0 || selectedMessages.size === 0) return;
            const selectedMsgs = messages.filter(m => selectedMessages.has(m.id)), inserts = [];
            forwardToUsers.forEach(userId => { selectedMsgs.forEach(msg => { inserts.push({ sender_id: currentUser.id, receiver_id: userId, content: `[Forwarded] ${msg.content}`, message_type: 'text' }); }); });
            await supabase.from('messages').insert(inserts);
            showToast(`Forwarded to ${forwardToUsers.size} user(s)`, 'success'); closeForwardModal(); exitSelectionMode(); await loadConversations();
        }

        function reportSelectedMessages() { if (selectedMessages.size === 0) { showToast('No messages selected', 'error'); return; } document.getElementById('reportReason').value = ''; document.getElementById('reportDescription').value = ''; document.getElementById('reportModal').classList.add('show'); }
        function closeReportModal() { document.getElementById('reportModal').classList.remove('show'); }
        async function submitReport() {
            const reason = document.getElementById('reportReason').value, description = document.getElementById('reportDescription').value;
            if (!reason) { showToast('Please select a reason', 'error'); return; }
            const selectedMsgs = messages.filter(m => selectedMessages.has(m.id)), messageContent = selectedMsgs.map(m => m.content).join('\n---\n');
            await supabase.from('user_reports').insert({ reporter_id: currentUser.id, reported_id: currentConversation, report_type: 'message', reason, description: `${description}\n\n--- Reported Messages ---\n${messageContent}` });
            showToast('Report submitted', 'success'); closeReportModal(); exitSelectionMode();
        }

        async function loadNotifications() { 
            const { data } = await supabase.from('notifications').select('*').eq('user_id', currentUser.id).order('created_at', { ascending: false }).limit(10); 
            notifications = data || []; 
            renderNotifications(); 
            checkAnnouncementPopup();
        }
        
        function checkAnnouncementPopup() {
            const adminTypes = ['announcement', 'admin_warning', 'warning', 'ban', 'admin_message', 'admin_urgent', 'admin_success'];
            const unreadAdmin = notifications.filter(n => adminTypes.includes(n.type) && !n.is_read);
            if (unreadAdmin.length > 0) showAdminPopup(unreadAdmin[0]);
        }
        
        function showAdminPopup(notification) {
            if (document.querySelector('.announcement-overlay')) return;
            const timeAgo = formatTimeAgo(notification.created_at);
            const type = notification.type || 'announcement';
            let config = { label: '📢 Admin Announcement', iconBg: 'linear-gradient(135deg, #f97316 0%, #ea580c 100%)', iconShadow: 'rgba(249, 115, 22, 0.4)', icon: '<path d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"/>', headerBg: 'linear-gradient(135deg, #1a365d 0%, #2c5282 100%)', labelColor: '#f97316' };
            if (type === 'admin_warning' || type === 'warning') { config = { label: '⚠️ Admin Warning', iconBg: 'linear-gradient(135deg, #eab308 0%, #ca8a04 100%)', iconShadow: 'rgba(234, 179, 8, 0.4)', icon: '<path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>', headerBg: 'linear-gradient(135deg, #854d0e 0%, #a16207 100%)', labelColor: '#fde047' }; }
            else if (type === 'admin_urgent' || type === 'ban') { config = { label: type === 'ban' ? '🚫 Account Suspended' : '🚨 Urgent Notice', iconBg: 'linear-gradient(135deg, #dc2626 0%, #b91c1c 100%)', iconShadow: 'rgba(220, 38, 38, 0.4)', icon: type === 'ban' ? '<path d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"/>' : '<path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>', headerBg: 'linear-gradient(135deg, #991b1b 0%, #b91c1c 100%)', labelColor: '#fca5a5' }; }
            else if (type === 'admin_success') { config = { label: '✅ Good News!', iconBg: 'linear-gradient(135deg, #22c55e 0%, #16a34a 100%)', iconShadow: 'rgba(34, 197, 94, 0.4)', icon: '<path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>', headerBg: 'linear-gradient(135deg, #166534 0%, #15803d 100%)', labelColor: '#86efac' }; }
            const overlay = document.createElement('div');
            overlay.className = 'announcement-overlay';
            overlay.innerHTML = `<div class="announcement-popup" style="background: ${config.headerBg};"><div class="announcement-header"><div class="announcement-icon" style="background: ${config.iconBg}; box-shadow: 0 4px 12px ${config.iconShadow};"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">${config.icon}</svg></div><div class="announcement-header-text"><div class="announcement-label" style="color: ${config.labelColor};">${config.label}</div><div class="announcement-title">${escapeHtml(notification.title)}</div></div></div><div class="announcement-body"><div class="announcement-message">${escapeHtml(notification.body || '')}</div><div class="announcement-time"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>${timeAgo}</div></div><div class="announcement-footer"><button class="announcement-btn" onclick="dismissAnnouncement('${notification.id}')"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M5 13l4 4L19 7"/></svg>I Understand</button></div></div>`;
            document.body.appendChild(overlay);
            playNotificationSound();
        }
        
        async function dismissAnnouncement(announcementId) {
            await supabase.from('notifications').update({ is_read: true }).eq('id', announcementId);
            const idx = notifications.findIndex(n => n.id === announcementId);
            if (idx !== -1) notifications[idx].is_read = true;
            const overlay = document.querySelector('.announcement-overlay');
            if (overlay) { overlay.style.animation = 'fadeIn 0.3s ease reverse'; setTimeout(() => overlay.remove(), 300); }
            renderNotifications();
            setTimeout(checkAnnouncementPopup, 500);
        }
        function renderNotifications() {
            const unread = notifications.filter(n => !n.is_read).length;
            // Update all notification badges
            ['notifBadge', 'notifBadge3'].forEach(id => {
                const badge = document.getElementById(id);
                if (badge) {
                    if (unread > 0) { badge.textContent = unread > 9 ? '9+' : unread; badge.style.display = 'flex'; }
                    else badge.style.display = 'none';
                }
            });
            // Build notification HTML
            let html = '';
            if (notifications.length === 0) { html = '<div class="notif-empty"><p>No notifications</p></div>'; }
            else {
                html = notifications.map(n => { 
                    const type = n.type || '';
                    const iconClass = type.includes('friend') ? 'friend' : type.includes('message') ? 'message' : type.includes('warning') ? 'warning' : 'group'; 
                    const iconSvg = iconClass === 'friend' ? '<path d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/>' : iconClass === 'message' ? '<path d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>' : '<path d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/>';
                    return `<div class="notif-dropdown-item ${n.is_read ? '' : 'unread'}" onclick="handleNotifClick('${n.id}','${type}')"><div class="notif-icon ${iconClass}"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">${iconSvg}</svg></div><div class="notif-content"><h4>${escapeHtml(n.title || 'Notification')}</h4><p>${escapeHtml(n.body || '')}</p><div class="time">${formatTimeAgo(n.created_at)}</div></div></div>`; 
                }).join('');
            }
            // Update all notification lists
            ['notifList', 'notifList3'].forEach(id => {
                const list = document.getElementById(id);
                if (list) list.innerHTML = html;
            });
        }
        async function handleNotifClick(id, type) { 
            await supabase.from('notifications').update({ is_read: true }).eq('id', id); 
            const n = notifications.find(x => x.id === id); 
            if (n) n.is_read = true; 
            renderNotifications(); 
            document.getElementById('notificationDropdown').classList.remove('show');
            const dd3 = document.getElementById('notificationDropdown3'); if (dd3) dd3.classList.remove('show');
            if (type === 'friend_request' || type === 'friend_accept') window.location.href = 'friends.html';
            else if (type === 'study_group') window.location.href = 'study-groups.html';
            else if (type === 'admin_warning' || type === 'announcement') window.location.href = 'dashboard.html';
            // For message notifications, stay on this page
        }
        async function markAllNotificationsRead() { await supabase.from('notifications').update({ is_read: true }).eq('user_id', currentUser.id); notifications.forEach(n => n.is_read = true); renderNotifications(); }

        // Notification sound
        function playNotificationSound() {
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.frequency.value = 800;
                osc.type = 'sine';
                gain.gain.setValueAtTime(0.1, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
                osc.start(ctx.currentTime);
                osc.stop(ctx.currentTime + 0.3);
            } catch (e) { console.log('Sound error:', e); }
        }

        function subscribeToRealtime() {
            supabase.channel('messages-channel').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages', filter: `receiver_id=eq.${currentUser.id}` }, async (payload) => {
                const msg = payload.new;
                const senderId = msg.sender_id;
                
                // Check if conversation was deleted - only show if message is AFTER deletion
                const deletedAt = deletedConversations[senderId];
                const msgTime = new Date(msg.created_at).getTime();
                if (deletedAt && msgTime <= deletedAt) {
                    // Message was created before we deleted, ignore it
                    return;
                }
                
                playNotificationSound();
                if (currentConversation === senderId) { 
                    messages.push(msg); 
                    renderMessages(); 
                    await supabase.from('messages').update({ is_read: true }).eq('id', msg.id); 
                } else { 
                    showToast('New message received', 'success'); 
                }
                await loadConversations();
            }).subscribe();
            supabase.channel('message-reads').on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'messages', filter: `sender_id=eq.${currentUser.id}` }, (payload) => { const msgIdx = messages.findIndex(m => m.id === payload.new.id); if (msgIdx !== -1) { messages[msgIdx].is_read = payload.new.is_read; renderMessages(); } }).subscribe();
            supabase.channel('online-status-messages').on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'profiles' }, (payload) => {
                if (currentChatUser && currentChatUser.id === payload.new.id) { currentChatUser.is_online = payload.new.is_online; currentChatUser.last_seen = payload.new.last_seen; const statusEl = document.getElementById('chatUserStatus'); statusEl.textContent = payload.new.is_online ? 'Online' : `Last seen ${formatTimeAgo(payload.new.last_seen)}`; statusEl.className = 'chat-user-status' + (payload.new.is_online ? '' : ' offline'); }
                const conv = conversations.find(c => c.oderId === payload.new.id); if (conv && conv.user) { conv.user.is_online = payload.new.is_online; conv.user.last_seen = payload.new.last_seen; renderConversations(); }
                // Friend online toast - only on fresh logins (offline > 30 seconds)
                const friend = friends.find(f => f.id === payload.new.id);
                if (friend) {
                    const wasOffline = !friend.is_online;
                    const lastSeen = friend.last_seen ? new Date(friend.last_seen) : null;
                    const now = new Date();
                    const offlineDuration = lastSeen ? (now - lastSeen) / 1000 : 999;
                    
                    friend.is_online = payload.new.is_online;
                    friend.last_seen = payload.new.last_seen;
                    
                    if (wasOffline && payload.new.is_online && offlineDuration > 30) {
                        showFriendOnlineToast(friend.full_name || friend.first_name);
                    }
                }
            }).subscribe();
            supabase.channel('notifications-messages-' + currentUser.id).on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'notifications', filter: `user_id=eq.${currentUser.id}` }, (payload) => { 
                console.log('Messages page: New notification received:', payload);
                notifications.unshift(payload.new); 
                renderNotifications(); 
                const adminTypes = ['announcement', 'admin_warning', 'warning', 'ban', 'admin_message', 'admin_urgent', 'admin_success'];
                if (adminTypes.includes(payload.new.type)) {
                    showAdminPopup(payload.new);
                } else {
                    playNotificationSound();
                    showToast(payload.new.title || 'New notification', 'success');
                }
            }).subscribe((status) => console.log('Messages notification subscription:', status));
            // Friend requests real-time for sidebar badge
            supabase.channel('messages-friend-requests-' + currentUser.id).on('postgres_changes', { event: '*', schema: 'public', table: 'friend_requests', filter: `receiver_id=eq.${currentUser.id}` }, () => loadSidebarFriendsBadge()).subscribe();
        }

        function showFriendOnlineToast(friendName) {
            const existing = document.querySelector('.friend-online-toast');
            if (existing) existing.remove();
            const toast = document.createElement('div');
            toast.className = 'friend-online-toast';
            toast.innerHTML = `<div style="width:10px;height:10px;background:#22c55e;border-radius:50%;animation:pulse 1s infinite;"></div><span><strong>${friendName}</strong> is now online</span>`;
            toast.style.cssText = 'position:fixed;top:80px;right:20px;background:linear-gradient(135deg,#065f46,#047857);color:white;padding:14px 20px;border-radius:12px;display:flex;align-items:center;gap:12px;z-index:9999;animation:slideInRight 0.3s ease;box-shadow:0 4px 20px rgba(4,120,87,0.4);font-size:14px;';
            const style = document.createElement('style');
            style.textContent = '@keyframes slideInRight{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}';
            document.head.appendChild(style);
            document.body.appendChild(toast);
            playNotificationSound();
            setTimeout(() => { toast.style.animation = 'slideInRight 0.3s ease reverse'; setTimeout(() => toast.remove(), 300); }, 4000);
        }

        function updateUnreadBadge() { const totalUnread = conversations.reduce((sum, c) => sum + (c.unreadCount || 0), 0); const badge = document.getElementById('sidebarMsgBadge'); if (totalUnread > 0) { badge.textContent = totalUnread > 99 ? '99+' : totalUnread; badge.style.display = 'inline'; } else badge.style.display = 'none'; }
        
        async function loadSidebarFriendsBadge() {
            const { count: reqCount } = await supabase.from('friend_requests').select('id', { count: 'exact' }).eq('receiver_id', currentUser.id).eq('status', 'pending');
            const badge = document.getElementById('sidebarFriendsBadge');
            if (badge) {
                if (reqCount > 0) { badge.textContent = reqCount > 99 ? '99+' : reqCount; badge.style.display = 'inline'; }
                else { badge.style.display = 'none'; }
            }
        }
        
        function viewUserProfile() { if (currentChatUser) { openProfileModal(currentChatUser.id); } closeChatMenu(); }
        function toggleChatMenu(event) { event.stopPropagation(); document.getElementById('chatMenu').classList.toggle('show'); }
        function closeChatMenu() { document.getElementById('chatMenu').classList.remove('show'); }
        function handleOutsideClick(e) { 
            if (!e.target.closest('.notification-wrapper')) {
                document.getElementById('notificationDropdown').classList.remove('show'); 
                const dd3 = document.getElementById('notificationDropdown3'); if (dd3) dd3.classList.remove('show');
            }
            if (!e.target.closest('.chat-header-actions')) closeChatMenu(); 
            if (!e.target.closest('.emoji-btn')) { const picker = document.getElementById('emojiPicker'); if (picker) picker.classList.remove('show'); } 
        }
        function closeConfirmModal() { document.getElementById('confirmModal').classList.remove('show'); confirmCallback = null; }
        function confirmAction() { if (confirmCallback) confirmCallback(); }
        function toggleNotifications(event) { 
            event.stopPropagation(); 
            // Find which dropdown to toggle based on which button was clicked
            const wrapper = event.target.closest('.notification-wrapper');
            const dropdown = wrapper ? wrapper.querySelector('.notification-dropdown') : document.getElementById('notificationDropdown');
            // Close all other dropdowns first
            document.querySelectorAll('.notification-dropdown').forEach(dd => { if (dd !== dropdown) dd.classList.remove('show'); });
            dropdown.classList.toggle('show'); 
        }
        function getInitials(name) { if (!name) return '??'; return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2); }
        function escapeHtml(text) { if (!text) return ''; const div = document.createElement('div'); div.textContent = text; return div.innerHTML; }
        function truncate(str, len) { if (!str) return ''; return str.length > len ? str.substring(0, len) + '...' : str; }
        function formatTimeAgo(dateStr) { const seconds = Math.floor((new Date() - new Date(dateStr)) / 1000); if (seconds < 60) return 'Just now'; if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`; if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`; if (seconds < 604800) return `${Math.floor(seconds / 86400)}d ago`; return new Date(dateStr).toLocaleDateString(); }
        function formatConvTime(dateStr) { const date = new Date(dateStr), now = new Date(), diff = now - date; if (diff < 86400000 && date.getDate() === now.getDate()) return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }); if (diff < 604800000) return date.toLocaleDateString([], { weekday: 'short' }); return date.toLocaleDateString([], { month: 'short', day: 'numeric' }); }
        function formatMessageTime(dateStr) { return new Date(dateStr).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }); }
        function formatDateDivider(dateStr) { const date = new Date(dateStr), now = new Date(), yesterday = new Date(now); yesterday.setDate(yesterday.getDate() - 1); if (date.toDateString() === now.toDateString()) return 'Today'; if (date.toDateString() === yesterday.toDateString()) return 'Yesterday'; return date.toLocaleDateString([], { weekday: 'long', month: 'long', day: 'numeric' }); }
        function showToast(msg, type = '') { const t = document.getElementById('toast'); document.getElementById('toastMessage').textContent = msg; t.className = 'toast' + (type ? ` ${type}` : ''); t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 3000); }
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); document.getElementById('sidebarOverlay').classList.toggle('show'); }
        async function handleLogout() { await updateOnlineStatus(false); await supabase.auth.signOut(); window.location.href = 'index.html'; }

        // =============================================
        // NEW CHAT MODAL - User Search
        // =============================================
        let searchTimeout = null;
        let reportingUserId = null;

        function openNewChatModal() {
            document.getElementById('userSearchInput').value = '';
            document.getElementById('userSearchResults').innerHTML = '<div class="search-placeholder"><svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg><p>Search for users to start a conversation</p></div>';
            document.getElementById('newChatModal').classList.add('show');
            setTimeout(() => document.getElementById('userSearchInput').focus(), 100);
        }

        function closeNewChatModal() {
            document.getElementById('newChatModal').classList.remove('show');
        }

        async function searchUsers() {
            const query = document.getElementById('userSearchInput').value.trim();
            const container = document.getElementById('userSearchResults');
            
            if (query.length < 2) {
                container.innerHTML = '<div class="search-placeholder"><svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg><p>Type at least 2 characters to search</p></div>';
                return;
            }

            // Debounce
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(async () => {
                container.innerHTML = '<div class="search-loading">Searching...</div>';

                try {
                    const { data: users, error } = await supabase
                        .from('profiles')
                        .select('id, first_name, last_name, full_name, avatar_url, program_name, is_online, last_seen')
                        .or(`full_name.ilike.%${query}%,first_name.ilike.%${query}%,last_name.ilike.%${query}%,program_name.ilike.%${query}%`)
                        .neq('id', currentUser.id)
                        .limit(20);

                    if (error) throw error;

                    // Filter out blocked users
                    const filteredUsers = (users || []).filter(u => !blockedUsers.includes(u.id) && !blockedByUsers.includes(u.id));

                    if (filteredUsers.length === 0) {
                        container.innerHTML = '<div class="search-empty">No users found</div>';
                        return;
                    }

                    container.innerHTML = filteredUsers.map(user => {
                        const name = user.full_name || `${user.first_name} ${user.last_name}`;
                        const initials = getInitials(name);
                        const statusText = user.is_online ? 'Online' : (user.last_seen ? `Last seen ${formatTimeAgo(user.last_seen)}` : 'Offline');
                        
                        return `
                            <div class="user-search-item" onclick="startConversation('${user.id}')">
                                <div class="user-search-avatar">
                                    ${user.avatar_url ? `<img src="${user.avatar_url}" alt="">` : initials}
                                    <div class="online-indicator ${user.is_online ? '' : 'offline'}"></div>
                                </div>
                                <div class="user-search-info">
                                    <div class="user-search-name">${escapeHtml(name)}</div>
                                    <div class="user-search-program">${escapeHtml(user.program_name || 'Student')}</div>
                                </div>
                                <div class="user-search-status ${user.is_online ? '' : 'offline'}">${user.is_online ? 'Online' : ''}</div>
                            </div>`;
                    }).join('');
                } catch (e) {
                    console.error('Search error:', e);
                    container.innerHTML = '<div class="search-empty">Error searching users</div>';
                }
            }, 300);
        }

        async function startConversation(userId) {
            closeNewChatModal();
            await openConversation(userId);
        }

        // =============================================
        // PROFILE PREVIEW MODAL
        // =============================================
        async function openProfileModal(userId) {
            // Refresh friend data to ensure sync
            await Promise.all([loadFriends(), loadFriendRequests()]);
            
            const { data: user, error } = await supabase
                .from('profiles')
                .select('id, first_name, last_name, full_name, avatar_url, program_name, year_of_study, bio, is_online, last_seen, created_at')
                .eq('id', userId)
                .single();

            if (error || !user) {
                showToast('User not found', 'error');
                return;
            }

            selectedProfileUser = user;
            const name = user.full_name || `${user.first_name} ${user.last_name}`;
            const initials = getInitials(name);
            const isBlocked = blockedUsers.includes(userId);
            const isBlockedBy = blockedByUsers.includes(userId);
            const isFriend = friendIds.includes(userId);
            const isPendingOut = outgoingRequestIds.includes(userId);
            const isPendingIn = incomingRequestIds.includes(userId);
            const memberSince = new Date(user.created_at).toLocaleDateString('en-US', { month: 'short', year: 'numeric' });

            let bodyHtml = `
                <div class="profile-modal-content">
                    <div class="profile-modal-avatar">
                        ${user.avatar_url ? `<img src="${user.avatar_url}" alt="">` : initials}
                        <div class="online-dot ${user.is_online ? '' : 'offline'}"></div>
                    </div>
                    <div class="profile-modal-name">${escapeHtml(name)}</div>
                    <div class="profile-modal-program">${escapeHtml(user.program_name || 'Student')}${user.year_of_study ? ` • Year ${user.year_of_study}` : ''}</div>
                    <div class="profile-modal-status ${user.is_online ? 'online' : 'offline'}">
                        <span>●</span> ${user.is_online ? 'Online now' : (user.last_seen ? `Last seen ${formatTimeAgo(user.last_seen)}` : 'Offline')}
                    </div>
                    ${user.bio ? `<div class="profile-modal-bio">${escapeHtml(user.bio)}</div>` : ''}
                    <div class="profile-modal-meta">
                        <div class="label">Member since</div>
                        <div class="value">${memberSince}</div>
                    </div>
                </div>`;

            if (isBlockedBy) {
                bodyHtml += `<div class="profile-blocked-notice">You cannot interact with this user.</div>`;
            } else if (isBlocked) {
                bodyHtml += `<div class="profile-blocked-notice">You have blocked this user.</div>`;
            }

            document.getElementById('profileModalBody').innerHTML = bodyHtml;

            // Footer actions - match friends page layout
            let footerHtml = '<div class="profile-modal-actions">';
            
            if (isBlockedBy) {
                footerHtml += '<p style="text-align:center;color:var(--gray-500);font-size:14px;padding:16px 0;">You cannot interact with this user</p>';
            } else if (isBlocked) {
                footerHtml += `<button class="btn btn-secondary" onclick="unblockUser('${userId}', '${escapeHtml(name)}')">
                    <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"/></svg>
                    Unblock User
                </button>`;
            } else {
                // Primary action based on friendship status
                if (isFriend) {
                    // Already friends - show Message and Remove Friend
                    footerHtml += `<button class="btn btn-primary" onclick="startConversationFromProfile('${userId}')">
                        <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
                        Message
                    </button>`;
                    footerHtml += `<button class="btn btn-danger" onclick="removeFriend('${userId}', '${escapeHtml(name)}')">
                        <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M13 7a4 4 0 11-8 0 4 4 0 018 0zM9 14a6 6 0 00-6 6v1h12v-1a6 6 0 00-6-6zM21 12h-6"/></svg>
                        Remove Friend
                    </button>`;
                } else if (isPendingOut) {
                    footerHtml += `<button class="btn btn-secondary" disabled>
                        <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        Request Sent
                    </button>`;
                    footerHtml += `<button class="btn btn-secondary" onclick="startConversationFromProfile('${userId}')">
                        <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
                        Message
                    </button>`;
                } else if (isPendingIn) {
                    footerHtml += `<button class="btn btn-success" onclick="acceptFriendRequest('${userId}')">
                        <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M5 13l4 4L19 7"/></svg>
                        Accept Request
                    </button>`;
                    footerHtml += `<button class="btn btn-secondary" onclick="startConversationFromProfile('${userId}')">
                        <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
                        Message
                    </button>`;
                } else {
                    // Not friends - Add Friend primary, Message secondary
                    footerHtml += `<button class="btn btn-primary" onclick="sendFriendRequest('${userId}', '${escapeHtml(name)}')">
                        <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/></svg>
                        Add Friend
                    </button>`;
                    footerHtml += `<button class="btn btn-secondary" onclick="startConversationFromProfile('${userId}')">
                        <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
                        Message
                    </button>`;
                }
                
                // Block and Report buttons - side by side
                footerHtml += `<div class="btn-row">
                    <button class="btn btn-outline-danger" onclick="blockUser('${userId}', '${escapeHtml(name)}')">
                        <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"/></svg>
                        Block
                    </button>
                    <button class="btn btn-warning" onclick="reportUser('${userId}')">
                        <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                        Report
                    </button>
                </div>`;
            }
            
            // View Full Profile link
            footerHtml += `
                <div class="profile-modal-link-container">
                    <a href="profile.html?user=${userId}" class="profile-modal-link">
                        <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                        View Full Profile
                        <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 5l7 7-7 7"/></svg>
                    </a>
                </div>
            </div>`;
            document.getElementById('profileModalFooter').innerHTML = footerHtml;

            document.getElementById('profileModal').classList.add('show');
        }

        function closeProfileModal() {
            document.getElementById('profileModal').classList.remove('show');
            selectedProfileUser = null;
        }

        function startConversationFromProfile(userId) {
            closeProfileModal();
            openConversation(userId);
        }

        // =============================================
        // FRIEND REQUEST FUNCTIONS
        // =============================================
        async function sendFriendRequest(userId, userName) {
            // Check if already friends
            const { data: friendship } = await supabase.from('friendships').select('id').or(`and(user_id.eq.${currentUser.id},friend_id.eq.${userId}),and(user_id.eq.${userId},friend_id.eq.${currentUser.id})`).maybeSingle();
            if (friendship) { showToast('Already friends!', 'error'); return; }
            
            // Check for existing pending request
            const { data: existing } = await supabase.from('friend_requests').select('id, status').or(`and(sender_id.eq.${currentUser.id},receiver_id.eq.${userId}),and(sender_id.eq.${userId},receiver_id.eq.${currentUser.id})`).maybeSingle();
            
            if (existing) {
                if (existing.status === 'pending') {
                    showToast('Request already pending', 'error'); 
                    return;
                }
                await supabase.from('friend_requests').delete().eq('id', existing.id);
            }
            
            await supabase.from('friend_requests').insert({ sender_id: currentUser.id, receiver_id: userId });
            showToast(`Request sent to ${userName}!`, 'success');
            await loadFriendRequests();
            // Refresh modal if open
            if (selectedProfileUser && selectedProfileUser.id === userId) {
                openProfileModal(userId);
            }
        }

        async function cancelFriendRequest(userId) {
            await supabase.from('friend_requests').delete().eq('sender_id', currentUser.id).eq('receiver_id', userId);
            showToast('Request cancelled');
            await loadFriendRequests();
            if (selectedProfileUser && selectedProfileUser.id === userId) {
                openProfileModal(userId);
            }
        }

        async function acceptFriendRequest(userId) {
            // Delete the request
            await supabase.from('friend_requests').delete().eq('sender_id', userId).eq('receiver_id', currentUser.id);
            // Create friendship
            await supabase.from('friendships').insert({ user_id: currentUser.id, friend_id: userId });
            showToast('Friend request accepted!', 'success');
            await loadFriends();
            await loadFriendRequests();
            if (selectedProfileUser && selectedProfileUser.id === userId) {
                openProfileModal(userId);
            }
        }

        // =============================================
        // REMOVE FRIEND
        // =============================================
        async function removeFriend(userId, userName) {
            document.getElementById('confirmTitle').textContent = 'Remove Friend';
            document.getElementById('confirmMessage').textContent = `Remove ${userName} from your friends?`;
            confirmCallback = async () => {
                try {
                    await supabase.from('friendships').delete()
                        .or(`and(user_id.eq.${currentUser.id},friend_id.eq.${userId}),and(user_id.eq.${userId},friend_id.eq.${currentUser.id})`);
                    
                    // Update local state
                    friendIds = friendIds.filter(id => id !== userId);
                    
                    showToast(`${userName} removed from friends`, 'success');
                    closeConfirmModal();
                    closeProfileModal();
                    await loadFriends();
                } catch (e) {
                    showToast('Failed to remove friend', 'error');
                }
            };
            document.getElementById('confirmModal').classList.add('show');
        }

        // =============================================
        // BLOCK/UNBLOCK USER
        // =============================================
        async function blockUser(userId, userName) {
            document.getElementById('confirmTitle').textContent = 'Block User';
            document.getElementById('confirmMessage').textContent = `Block ${userName}? They won't be able to message you.`;
            confirmCallback = async () => {
                try {
                    await supabase.from('blocked_users').insert({ blocker_id: currentUser.id, blocked_id: userId });
                    // Remove any existing friendship
                    await supabase.from('friendships').delete().or(`and(user_id.eq.${currentUser.id},friend_id.eq.${userId}),and(user_id.eq.${userId},friend_id.eq.${currentUser.id})`);
                    // Cancel pending requests
                    await supabase.from('friend_requests').delete().or(`and(sender_id.eq.${currentUser.id},receiver_id.eq.${userId}),and(sender_id.eq.${userId},receiver_id.eq.${currentUser.id})`);
                    
                    blockedUsers.push(userId);
                    showToast(`${userName} has been blocked`, 'success');
                    closeConfirmModal();
                    closeProfileModal();
                    await loadConversations();
                } catch (e) {
                    showToast('Failed to block user', 'error');
                }
            };
            document.getElementById('confirmModal').classList.add('show');
        }

        async function unblockUser(userId, userName) {
            try {
                await supabase.from('blocked_users').delete().eq('blocker_id', currentUser.id).eq('blocked_id', userId);
                blockedUsers = blockedUsers.filter(id => id !== userId);
                showToast(`${userName} has been unblocked`, 'success');
                // Refresh the modal to show updated buttons
                if (selectedProfileUser && selectedProfileUser.id === userId) {
                    await loadFriendRequests();
                    openProfileModal(userId);
                } else {
                    closeProfileModal();
                }
            } catch (e) {
                showToast('Failed to unblock user', 'error');
            }
        }

        // =============================================
        // REPORT USER
        // =============================================
        function reportUser(userId) {
            reportingUserId = userId;
            document.getElementById('userReportReason').value = '';
            document.getElementById('userReportDescription').value = '';
            closeProfileModal();
            document.getElementById('userReportModal').classList.add('show');
        }

        function closeUserReportModal() {
            document.getElementById('userReportModal').classList.remove('show');
            reportingUserId = null;
        }

        async function submitUserReport() {
            const reason = document.getElementById('userReportReason').value;
            const description = document.getElementById('userReportDescription').value;

            if (!reason) {
                showToast('Please select a reason', 'error');
                return;
            }

            try {
                await supabase.from('user_reports').insert({
                    reporter_id: currentUser.id,
                    reported_id: reportingUserId,
                    report_type: 'user',
                    reason: reason,
                    description: description
                });

                showToast('Report submitted. Our team will review it.', 'success');
                closeUserReportModal();
            } catch (e) {
                showToast('Failed to submit report', 'error');
            }
        }

        // Update viewUserProfile to use modal instead of redirect
        function viewUserProfile() {
            if (currentChatUser) {
                openProfileModal(currentChatUser.id);
            }
            closeChatMenu();
        }

        // All Notifications Modal
        async function openNotificationsModal() {
            document.getElementById('notificationDropdown').classList.remove('show');
            document.getElementById('notificationsModal').classList.add('show');
            await loadAllNotifications();
        }
        function closeNotificationsModal() { document.getElementById('notificationsModal').classList.remove('show'); }
        async function loadAllNotifications() {
            const { data } = await supabase.from('notifications').select('*').eq('user_id', currentUser.id).order('created_at', { ascending: false }).limit(100);
            const allNotifs = data || [];
            const list = document.getElementById('allNotifList');
            if (allNotifs.length === 0) { list.innerHTML = '<div class="notif-empty" style="padding:40px;text-align:center;color:var(--gray-400);"><p>No notifications</p></div>'; return; }
            list.innerHTML = allNotifs.map(n => {
                const type = n.type || '';
                const iconClass = type.includes('friend') ? 'friend' : type.includes('message') ? 'message' : type.includes('warning') ? 'warning' : 'group';
                const iconSvg = iconClass === 'friend' ? '<path d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/>' : iconClass === 'message' ? '<path d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>' : '<path d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/>';
                return `<div class="notif-dropdown-item ${n.is_read ? '' : 'unread'}" onclick="handleNotifClickModal('${n.id}','${type}')"><div class="notif-icon ${iconClass}"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">${iconSvg}</svg></div><div class="notif-content"><h4>${escapeHtml(n.title || 'Notification')}</h4><p>${escapeHtml(n.body || '')}</p><div class="time">${formatTimeAgo(n.created_at)}</div></div></div>`;
            }).join('');
        }
        async function handleNotifClickModal(id, type) { await supabase.from('notifications').update({ is_read: true }).eq('id', id); closeNotificationsModal(); if (type === 'friend_request' || type === 'friend_accept') window.location.href = 'friends.html'; else if (type === 'study_group') window.location.href = 'study-groups.html'; else if (type === 'admin_warning' || type === 'announcement') window.location.href = 'dashboard.html'; }
        async function markAllNotificationsReadModal() { await supabase.from('notifications').update({ is_read: true }).eq('user_id', currentUser.id); notifications.forEach(n => n.is_read = true); renderNotifications(); await loadAllNotifications(); showToast('All marked as read'); }
        async function clearAllNotifications() { if (!confirm('Clear all notifications?')) return; const { error } = await supabase.from('notifications').delete().eq('user_id', currentUser.id); if (error) { console.error('Delete failed:', error); showToast('Failed to clear. Check database permissions.', 'error'); return; } notifications = []; renderNotifications(); loadAllNotifications(); closeNotificationsModal(); showToast('Notifications cleared', 'success'); }

        init();
    </script>
</body>
</html>
