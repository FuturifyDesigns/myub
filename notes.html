<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, interactive-widget=resizes-content, maximum-scale=1.0, user-scalable=no">
    <title>Notes - MyUB</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=Sora:wght@600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="myub-utils.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        :root { --navy: #1a365d; --navy-light: #2c5282; --navy-dark: #0f2744; --red: #c41e3a; --white: #ffffff; --gray-50: #f8fafc; --gray-100: #f1f5f9; --gray-200: #e2e8f0; --gray-300: #cbd5e1; --gray-400: #94a3b8; --gray-500: #64748b; --gray-600: #475569; --gray-700: #334155; --gray-800: #1e293b; --green: #22c55e; --blue: #3b82f6; --orange: #f97316; --yellow: #eab308; --purple: #8b5cf6; --pink: #ec4899; }
        html { height: auto; min-height: 100%; }
        body { font-family: 'Outfit', sans-serif; background: var(--gray-100); min-height: 100%; overflow-x: hidden; -webkit-overflow-scrolling: touch; }
        .sidebar { position: fixed; left: 0; top: 0; bottom: 0; width: 260px; background: var(--navy-dark); padding: 20px 0; z-index: 100; transition: transform 0.3s ease; overflow-y: auto; }
        .sidebar-header { padding: 0 20px 20px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px; }

        .sidebar-logo {
            display: inline-flex;
            align-items: baseline;
            text-decoration: none;
            background: white;
            padding: 30px 15px 10px 15px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .sidebar-logo-m-wrapper {
            position: relative;
            display: inline-block;
        }

        .sidebar-logo-cap {
            width: 45px;
            height: 26px;
            position: absolute;
            top: -22px;
            left: 50%;
            transform: translateX(-50%);
        }

        .sidebar-logo-m {
            font-family: 'Times New Roman', Georgia, serif;
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--navy);
            line-height: 1;
        }

        .sidebar-logo-yub {
            font-family: 'Times New Roman', Georgia, serif;
            font-size: 1.6rem;
            font-weight: 700;
            color: var(--navy);
            margin-left: -2px;
        }
        .nav-section { margin-bottom: 24px; }
        .nav-section-title { font-size: 11px; font-weight: 600; color: var(--gray-400); text-transform: uppercase; letter-spacing: 1px; padding: 0 20px; margin-bottom: 8px; }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 20px; color: var(--gray-300); text-decoration: none; font-size: 14px; font-weight: 500; transition: all 0.2s; cursor: pointer; border: none; background: none; width: 100%; text-align: left; }
        .nav-item:hover { background: rgba(255,255,255,0.05); color: var(--white); }
        .nav-item.active { background: rgba(255,255,255,0.1); color: var(--white); border-right: 3px solid var(--red); }
        .nav-item svg { width: 20px; height: 20px; flex-shrink: 0; }
        .nav-item .badge { margin-left: auto; background: var(--red); color: var(--white); font-size: 11px; font-weight: 600; padding: 2px 8px; border-radius: 10px; }
        .sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 99; }
        .main-content { margin-left: 260px; min-height: 100vh; }
        .topbar { background: var(--white); padding: 16px 24px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--gray-200); position: sticky; top: 0; z-index: 50; }
        .topbar-left { display: flex; align-items: center; gap: 16px; }
        .menu-toggle { display: none; background: none; border: none; cursor: pointer; color: var(--gray-600); width: 40px; height: 40px; border-radius: 10px; align-items: center; justify-content: center; }
        .menu-toggle:hover { background: var(--gray-100); }
        .menu-toggle svg { width: 24px; height: 24px; }
        .page-title { font-family: 'Sora', sans-serif; font-size: 20px; font-weight: 700; color: var(--gray-800); }
        .topbar-right { display: flex; align-items: center; gap: 12px; }
        .notif-wrapper { position: relative; }
        .notif-btn { width: 40px; height: 40px; border: none; background: var(--gray-100); border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; position: relative; transition: all 0.2s; }
        .notif-btn:hover { background: var(--gray-200); }
        .notif-btn svg { width: 20px; height: 20px; color: var(--gray-600); }
        .notif-btn .badge { position: absolute; top: -2px; right: -2px; background: var(--red); color: var(--white); font-size: 10px; font-weight: 700; min-width: 18px; height: 18px; border-radius: 9px; display: none; align-items: center; justify-content: center; border: 2px solid var(--white); }
        .notif-dropdown { position: absolute; top: calc(100% + 8px); right: 0; width: 360px; max-height: 480px; background: var(--white); border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.2); display: none; z-index: 2000; overflow: hidden; }
        .notif-dropdown.show { display: block; }
        .notif-header { padding: 16px 20px; border-bottom: 1px solid var(--gray-200); display: flex; align-items: center; justify-content: space-between; }
        .notif-header h3 { font-size: 16px; font-weight: 600; color: var(--gray-800); }
        .notif-header button { background: none; border: none; color: var(--navy); font-size: 13px; font-weight: 500; cursor: pointer; }
        .notif-list { max-height: 400px; overflow-y: auto; }
        .notif-dropdown-item { display: flex; gap: 12px; padding: 14px 20px; border-bottom: 1px solid var(--gray-100); cursor: pointer; transition: background 0.15s; }
        .notif-dropdown-item:hover { background: var(--gray-50); }
        .notif-dropdown-item.unread { background: #f0f9ff; }
        .notif-dropdown-item .notif-icon { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .notif-dropdown-item .notif-icon.friend { background: var(--green); color: white; }
        .notif-dropdown-item .notif-icon.message { background: var(--blue); color: white; }
        .notif-dropdown-item .notif-icon.group { background: var(--purple); color: white; }
        .notif-icon.warning { background: var(--orange); color: white; }
        .notif-dropdown-item .notif-icon svg { width: 18px; height: 18px; }
        .notif-dropdown-item .notif-content { flex: 1; min-width: 0; }
        .notif-dropdown-item .notif-content h4 { font-size: 14px; font-weight: 600; color: var(--gray-800); margin-bottom: 2px; }
        .notif-dropdown-item .notif-content p { font-size: 13px; color: var(--gray-500); margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .notif-dropdown-item .notif-content .time { font-size: 12px; color: var(--gray-400); }
        .notif-empty { padding: 40px 20px; text-align: center; color: var(--gray-400); }
        .notif-empty svg { width: 48px; height: 48px; margin-bottom: 12px; opacity: 0.5; }
        .notif-empty p { font-size: 14px; }
        .notif-footer { padding: 12px 20px; border-top: 1px solid var(--gray-200); text-align: center; }
        .notif-footer a { color: var(--navy); font-size: 14px; font-weight: 600; text-decoration: none; cursor: pointer; }
        .notif-footer a:hover { text-decoration: underline; }
        .btn-secondary { padding: 8px 16px; background: var(--gray-100); color: var(--gray-700); border: 1px solid var(--gray-200); border-radius: 8px; font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.2s; }
        .btn-secondary:hover { background: var(--gray-200); }
        .btn-danger { padding: 8px 16px; background: #fee2e2; color: #dc2626; border: 1px solid #fecaca; border-radius: 8px; font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.2s; }
        .btn-danger:hover { background: #fecaca; }
        .btn-primary { padding: 10px 20px; background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 100%); color: var(--white); border: none; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(26,54,93,0.3); }
        .btn-primary svg { width: 18px; height: 18px; }
        .content-area { padding: 24px; }
        .toolbar { display: flex; align-items: center; gap: 12px; margin-bottom: 24px; flex-wrap: wrap; }
        .search-box { flex: 1; min-width: 200px; max-width: 400px; position: relative; }
        .search-box input { width: 100%; padding: 12px 16px 12px 44px; border: 1px solid var(--gray-200); border-radius: 12px; font-size: 14px; background: var(--white); transition: all 0.2s; font-family: inherit; }
        .search-box input:focus { outline: none; border-color: var(--navy); box-shadow: 0 0 0 3px rgba(26,54,93,0.1); }
        .search-box svg { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); width: 20px; height: 20px; color: var(--gray-400); }
        .filter-btn { padding: 10px 16px; border: 1px solid var(--gray-200); background: var(--white); border-radius: 10px; font-size: 13px; font-weight: 500; color: var(--gray-600); cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 6px; }
        .filter-btn:hover { border-color: var(--gray-300); background: var(--gray-50); }
        .filter-btn.active { border-color: var(--navy); background: var(--navy); color: var(--white); }
        .filter-btn svg { width: 16px; height: 16px; }
        .view-toggle { display: flex; border: 1px solid var(--gray-200); border-radius: 10px; overflow: hidden; background: var(--white); }
        .view-btn { width: 40px; height: 40px; border: none; background: transparent; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .view-btn:hover { background: var(--gray-50); }
        .view-btn.active { background: var(--navy); }
        .view-btn.active svg { color: var(--white); }
        .view-btn svg { width: 18px; height: 18px; color: var(--gray-500); }
        .notes-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .notes-list { display: none; flex-direction: column; gap: 12px; }
        .notes-list.active { display: flex; }
        .notes-grid.active { display: grid; }
        .notes-grid:not(.active) { display: none; }
        .note-card { background: var(--white); border-radius: 16px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); cursor: pointer; transition: all 0.2s; position: relative; border-left: 4px solid transparent; }
        .note-card:hover { transform: translateY(-4px); box-shadow: 0 12px 32px rgba(0,0,0,0.12); }
        .note-card.color-blue { border-left-color: var(--blue); }
        .note-card.color-green { border-left-color: var(--green); }
        .note-card.color-yellow { border-left-color: var(--yellow); }
        .note-card.color-orange { border-left-color: var(--orange); }
        .note-card.color-red { border-left-color: var(--red); }
        .note-card.color-purple { border-left-color: var(--purple); }
        .note-card.color-pink { border-left-color: var(--pink); }
        .note-header { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 12px; }
        .note-title { font-size: 16px; font-weight: 600; color: var(--gray-800); flex: 1; line-height: 1.4; }
        .note-actions { display: flex; gap: 4px; opacity: 0; transition: opacity 0.2s; }
        .note-card:hover .note-actions { opacity: 1; }
        .note-action-btn { width: 28px; height: 28px; border: none; background: var(--gray-100); border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.15s; }
        .note-action-btn:hover { background: var(--gray-200); }
        .note-action-btn.pinned { background: var(--yellow); color: var(--white); }
        .note-action-btn svg { width: 14px; height: 14px; }
        .note-preview { font-size: 14px; color: var(--gray-500); line-height: 1.6; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; margin-bottom: 16px; }
        .note-meta { display: flex; align-items: center; justify-content: space-between; font-size: 12px; color: var(--gray-400); }
        .note-list-item { display: flex; align-items: center; gap: 16px; background: var(--white); border-radius: 12px; padding: 16px 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); cursor: pointer; transition: all 0.2s; border-left: 4px solid transparent; }
        .note-list-item:hover { transform: translateX(4px); box-shadow: 0 4px 16px rgba(0,0,0,0.1); }
        .note-list-item.color-blue { border-left-color: var(--blue); }
        .note-list-item.color-green { border-left-color: var(--green); }
        .note-list-item.color-yellow { border-left-color: var(--yellow); }
        .note-list-item.color-orange { border-left-color: var(--orange); }
        .note-list-item.color-red { border-left-color: var(--red); }
        .note-list-item.color-purple { border-left-color: var(--purple); }
        .note-list-item.color-pink { border-left-color: var(--pink); }
        .note-list-content { flex: 1; min-width: 0; }
        .note-list-title { font-size: 15px; font-weight: 600; color: var(--gray-800); margin-bottom: 4px; }
        .note-list-preview { font-size: 13px; color: var(--gray-500); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .note-list-meta { display: flex; align-items: center; gap: 12px; flex-shrink: 0; }
        .note-list-meta .pinned { color: var(--yellow); }
        .empty-state { text-align: center; padding: 80px 20px; }
        .empty-state svg { width: 80px; height: 80px; color: var(--gray-300); margin-bottom: 20px; }
        .empty-state h3 { font-size: 20px; font-weight: 600; color: var(--gray-700); margin-bottom: 8px; }
        .empty-state p { font-size: 14px; color: var(--gray-500); }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: none; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(4px); }
        .modal-overlay.show { display: flex; }
        .modal { background: var(--white); border-radius: 20px; width: 100%; max-width: 800px; max-height: 90vh; display: flex; flex-direction: column; box-shadow: 0 25px 80px rgba(0,0,0,0.3); }
        .modal-header { padding: 20px 24px; border-bottom: 1px solid var(--gray-200); display: flex; align-items: center; justify-content: space-between; }
        .modal-header h2 { font-size: 18px; font-weight: 600; color: var(--gray-800); }
        .modal-close { width: 36px; height: 36px; border: none; background: var(--gray-100); border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .modal-close:hover { background: var(--gray-200); }
        .modal-close svg { width: 20px; height: 20px; color: var(--gray-500); }
        .modal-body { flex: 1; overflow-y: auto; padding: 24px; }
        .modal-footer { padding: 16px 24px; border-top: 1px solid var(--gray-200); display: flex; align-items: center; justify-content: space-between; gap: 12px; }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-size: 13px; font-weight: 600; color: var(--gray-600); margin-bottom: 8px; }
        .form-input { width: 100%; padding: 12px 16px; border: 1px solid var(--gray-200); border-radius: 10px; font-size: 14px; font-family: inherit; transition: all 0.2s; }
        .form-input:focus { outline: none; border-color: var(--navy); box-shadow: 0 0 0 3px rgba(26,54,93,0.1); }
        .form-row { display: flex; gap: 16px; }
        .form-row .form-group { flex: 1; }
        .editor-toolbar { display: flex; flex-wrap: wrap; gap: 4px; padding: 12px; background: var(--gray-50); border: 1px solid var(--gray-200); border-radius: 10px 10px 0 0; border-bottom: none; }
        .toolbar-group { display: flex; gap: 2px; padding-right: 8px; border-right: 1px solid var(--gray-200); margin-right: 8px; }
        .toolbar-group:last-child { border-right: none; margin-right: 0; padding-right: 0; }
        .toolbar-btn { width: 32px; height: 32px; border: none; background: transparent; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.15s; color: var(--gray-600); font-size: 14px; font-weight: 600; }
        .toolbar-btn:hover { background: var(--gray-200); color: var(--gray-800); }
        .toolbar-btn.active { background: var(--navy); color: var(--white); }
        .toolbar-btn svg { width: 16px; height: 16px; }
        .toolbar-select { padding: 6px 10px; border: 1px solid var(--gray-200); border-radius: 6px; font-size: 12px; background: var(--white); cursor: pointer; font-family: inherit; }
        .toolbar-select:focus { outline: none; border-color: var(--navy); }
        .editor-content { min-height: 300px; padding: 16px; border: 1px solid var(--gray-200); border-radius: 0 0 10px 10px; outline: none; font-size: 15px; line-height: 1.7; overflow-y: auto; }
        .editor-content:focus { border-color: var(--navy); }
        .editor-content:empty:before { content: attr(data-placeholder); color: var(--gray-400); pointer-events: none; }
        .highlight-wrapper { position: relative; }
        .highlight-picker { display: none; position: absolute; top: 100%; left: 0; margin-top: 4px; background: var(--white); border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); padding: 8px; z-index: 10; flex-wrap: wrap; gap: 4px; width: 140px; }
        .highlight-picker.show { display: flex; }
        .highlight-color { width: 24px; height: 24px; border-radius: 4px; cursor: pointer; border: 2px solid transparent; transition: all 0.15s; }
        .highlight-color:hover { transform: scale(1.1); border-color: var(--gray-400); }
        .color-picker { display: flex; gap: 8px; flex-wrap: wrap; }
        .color-option { width: 32px; height: 32px; border-radius: 50%; cursor: pointer; border: 3px solid transparent; transition: all 0.2s; }
        .color-option:hover { transform: scale(1.1); }
        .color-option.active { border-color: var(--gray-800); }
        .color-option.default { background: var(--gray-200); }
        .color-option.blue { background: var(--blue); }
        .color-option.green { background: var(--green); }
        .color-option.yellow { background: var(--yellow); }
        .color-option.orange { background: var(--orange); }
        .color-option.red { background: var(--red); }
        .color-option.purple { background: var(--purple); }
        .color-option.pink { background: var(--pink); }
        .word-count { font-size: 12px; color: var(--gray-400); }
        .btn { padding: 10px 20px; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; border: none; font-family: inherit; }
        .btn-secondary { background: var(--gray-100); color: var(--gray-700); }
        .btn-secondary:hover { background: var(--gray-200); }
        .btn-danger { background: #fee2e2; color: #dc2626; }
        .btn-danger:hover { background: #fecaca; }
        .btn-save { background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 100%); color: var(--white); }
        .btn-save:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(26,54,93,0.3); }
        .btn svg { width: 16px; height: 16px; }
        .confirm-modal { max-width: 400px; text-align: center; }
        .confirm-modal .modal-body { padding: 32px 24px; }
        .confirm-icon { width: 64px; height: 64px; border-radius: 50%; background: #fee2e2; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; }
        .confirm-icon svg { width: 32px; height: 32px; color: #dc2626; }
        .confirm-modal h3 { font-size: 18px; font-weight: 600; color: var(--gray-800); margin-bottom: 8px; }
        .confirm-modal p { font-size: 14px; color: var(--gray-500); margin-bottom: 24px; }
        .confirm-actions { display: flex; gap: 12px; justify-content: center; }
        .toast { position: fixed; bottom: 24px; right: 24px; padding: 14px 20px; background: var(--gray-800); color: var(--white); border-radius: 12px; font-size: 14px; font-weight: 500; z-index: 2000; display: flex; align-items: center; gap: 10px; transform: translateY(100px); opacity: 0; transition: all 0.3s; }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.success { background: var(--green); }
        .toast.error { background: var(--red); }
        .loading-screen { position: fixed; inset: 0; background: var(--white); z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .spinner { width: 40px; height: 40px; border: 3px solid var(--gray-200); border-top-color: var(--navy); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        body.dark-mode { background: #0f172a; }
        body.dark-mode .sidebar { background: #020617; }
        body.dark-mode .topbar { background: #1e293b; border-color: #334155; }
        body.dark-mode .page-title { color: var(--white); }
        body.dark-mode .search-box input, body.dark-mode .filter-btn, body.dark-mode .view-toggle, body.dark-mode .notif-btn { background: #1e293b; border-color: #334155; color: var(--gray-300); }
        body.dark-mode .note-card, body.dark-mode .note-list-item { background: #1e293b; }
        body.dark-mode .note-title, body.dark-mode .note-list-title { color: var(--white); }
        body.dark-mode .modal { background: #1e293b; }
        body.dark-mode .modal-header, body.dark-mode .modal-footer { border-color: #334155; }
        body.dark-mode .modal-header h2 { color: var(--white); }
        body.dark-mode .form-input, body.dark-mode .toolbar-select { background: #0f172a; border-color: #334155; color: var(--white); }
        body.dark-mode .editor-content { background: #0f172a; border-color: #334155; color: var(--white); }
        body.dark-mode .editor-toolbar { background: #1e293b; border-color: #334155; }
        body.dark-mode .notif-dropdown { background: #1e293b; }
        body.dark-mode .notif-header { border-color: #334155; }
        body.dark-mode .notif-header h3 { color: var(--white); }
        body.dark-mode .notif-dropdown-item { border-color: #334155; }
        body.dark-mode .notif-dropdown-item .notif-content h4 { color: var(--white); }
        body.dark-mode .notif-dropdown-item.unread { background: #1e3a5f; }
        @media (max-width: 900px) { .sidebar { transform: translateX(-100%); } .sidebar.open { transform: translateX(0); } .sidebar-overlay.show { display: block; } .main-content { margin-left: 0; } .menu-toggle { display: flex; } }
        @media (max-width: 600px) { .topbar { padding: 12px 16px; } .content-area { padding: 16px; } .notes-grid { grid-template-columns: 1fr; } .modal { max-height: 100vh; border-radius: 0; } .form-row { flex-direction: column; } .notif-dropdown { position: fixed; top: 70px; left: 10px; right: 10px; width: auto; z-index: 2000; max-height: calc(100vh - 90px); } }
        
        /* Admin Announcement Popup */
        .announcement-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; z-index: 10000; animation: fadeIn 0.3s ease; padding: 20px; }
        .announcement-popup { background: linear-gradient(135deg, #1a365d 0%, #2c5282 100%); border-radius: 20px; max-width: 480px; width: 100%; box-shadow: 0 25px 60px rgba(0,0,0,0.4); animation: popIn 0.4s cubic-bezier(0.175,0.885,0.32,1.275); overflow: hidden; }
        .announcement-header { background: rgba(255,255,255,0.1); padding: 20px 24px; display: flex; align-items: center; gap: 14px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .announcement-icon { width: 48px; height: 48px; background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(249,115,22,0.4); }
        .announcement-icon svg { width: 26px; height: 26px; color: white; }
        .announcement-header-text { flex: 1; }
        .announcement-label { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1.5px; color: #f97316; margin-bottom: 4px; }
        .announcement-title { font-family: 'Sora', sans-serif; font-size: 20px; font-weight: 700; color: white; }
        .announcement-body { padding: 24px; }
        .announcement-message { font-size: 15px; line-height: 1.7; color: rgba(255,255,255,0.9); }
        .announcement-time { font-size: 12px; color: rgba(255,255,255,0.5); margin-top: 16px; display: flex; align-items: center; gap: 6px; }
        .announcement-time svg { width: 14px; height: 14px; }
        .announcement-footer { padding: 16px 24px 24px; }
        .announcement-btn { width: 100%; padding: 16px 24px; background: white; color: #1a365d; border: none; border-radius: 12px; font-family: 'Outfit', sans-serif; font-size: 15px; font-weight: 700; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .announcement-btn:hover { background: #f1f5f9; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .announcement-btn svg { width: 18px; height: 18px; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes popIn { from { opacity: 0; transform: scale(0.9) translateY(20px); } to { opacity: 1; transform: scale(1) translateY(0); } }
    </style>
</head>
<body>
    <div class="loading-screen" id="loadingScreen"><div class="spinner"></div></div>
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">                        <a href="dashboard.html" class="sidebar-logo">
                <div class="sidebar-logo-m-wrapper">
                    <svg class="sidebar-logo-cap" viewBox="0 0 100 70">
                        <polygon points="50,8 95,25 50,42 5,25" fill="#1a365d"/>
                        <circle cx="50" cy="25" r="5" fill="#ffffff" stroke="#1a365d" stroke-width="2"/>
                        <rect x="32" y="38" width="36" height="18" rx="3" fill="#1a365d"/>
                        <g class="tassel">
                            <circle cx="78" cy="25" r="4" fill="#c41e3a"/>
                            <path d="M78 29 Q82 45 80 55" stroke="#c41e3a" stroke-width="3" fill="none"/>
                            <ellipse cx="80" cy="58" rx="5" ry="8" fill="#c41e3a"/>
                        </g>
                    </svg>
                    <span class="sidebar-logo-m">M</span>
                </div>
                <span class="sidebar-logo-yub">yUB</span>
            </a></div>
        <nav>
            <div class="nav-section"><div class="nav-section-title">Main Menu</div>
                <a href="dashboard.html" class="nav-item"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>Dashboard</a>
                <a href="gpa-calculator.html" class="nav-item"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>GPA Calculator</a>
                <a href="notes.html" class="nav-item active"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>Notes</a>
                <a href="schedule.html" class="nav-item"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>Schedule</a>
            </div>
            <div class="nav-section"><div class="nav-section-title">Social</div>
                <a href="messages.html" class="nav-item"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>Messages<span class="badge" id="sidebarMsgBadge" style="display:none;">0</span></a>
                <a href="friends.html" class="nav-item"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>Friends<span class="badge" id="sidebarFriendsBadge" style="display:none;">0</span></a>
                <a href="study-groups.html" class="nav-item"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>Study Groups</a>
            </div>
            <div class="nav-section"><div class="nav-section-title">Account</div>
                <a href="profile.html" class="nav-item"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>Profile</a>
                <button class="nav-item" onclick="logout()"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>Sign Out</button>
            </div>
        </nav>
    </aside>
    <main class="main-content">
        <div class="topbar">
            <div class="topbar-left">
                <button class="menu-toggle" onclick="toggleSidebar()"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M4 6h16M4 12h16M4 18h16"/></svg></button>
                <h1 class="page-title">My Notes</h1>
            </div>
            <div class="topbar-right">
                <div class="notif-wrapper">
                    <button class="notif-btn" onclick="toggleNotifications(event)"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/></svg><span class="badge" id="notifBadge">0</span></button>
                    <div class="notif-dropdown" id="notifDropdown"><div class="notif-header"><h3>Notifications</h3><button onclick="markAllRead()">Mark all read</button></div><div class="notif-list" id="notifList"></div><div class="notif-footer"><a onclick="openNotificationsModal()">View All Notifications</a></div></div>
                </div>
                <button class="btn-primary" onclick="openNoteModal()"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 4v16m8-8H4"/></svg>New Note</button>
            </div>
        </div>
        <div class="content-area">
            <div class="toolbar">
                <div class="search-box"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg><input type="text" id="searchInput" placeholder="Search notes..." oninput="filterNotes()"></div>
                <button class="filter-btn" id="pinnedFilter" onclick="toggleFilter('pinned')"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/></svg>Pinned</button>
                <div class="view-toggle">
                    <button class="view-btn active" id="gridViewBtn" onclick="setView('grid')"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/></svg></button>
                    <button class="view-btn" id="listViewBtn" onclick="setView('list')"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M4 6h16M4 10h16M4 14h16M4 18h16"/></svg></button>
                </div>
            </div>
            <div class="notes-grid active" id="notesGrid"></div>
            <div class="notes-list" id="notesList"></div>
            <div class="empty-state" id="emptyState" style="display:none;"><svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z"/></svg><h3>No notes yet</h3><p>Click "New Note" to create your first note</p></div>
        </div>
    </main>

    <div class="modal-overlay" id="noteModal">
        <div class="modal">
            <div class="modal-header"><h2 id="modalTitle">New Note</h2><button class="modal-close" onclick="closeNoteModal()"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12"/></svg></button></div>
            <div class="modal-body">
                <div class="form-group"><label class="form-label">Title</label><input type="text" class="form-input" id="noteTitle" placeholder="Note title..."></div>
                <div class="form-group"><label class="form-label">Color</label>
                    <div class="color-picker">
                        <div class="color-option default active" data-color="default" onclick="selectColor('default')"></div>
                        <div class="color-option blue" data-color="blue" onclick="selectColor('blue')"></div>
                        <div class="color-option green" data-color="green" onclick="selectColor('green')"></div>
                        <div class="color-option yellow" data-color="yellow" onclick="selectColor('yellow')"></div>
                        <div class="color-option orange" data-color="orange" onclick="selectColor('orange')"></div>
                        <div class="color-option red" data-color="red" onclick="selectColor('red')"></div>
                        <div class="color-option purple" data-color="purple" onclick="selectColor('purple')"></div>
                        <div class="color-option pink" data-color="pink" onclick="selectColor('pink')"></div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Content</label>
                    <div class="editor-toolbar">
                        <div class="toolbar-group">
                            <select class="toolbar-select" id="fontFamily" onchange="execCmd('fontName', this.value)"><option value="Outfit, sans-serif">Outfit</option><option value="Arial, sans-serif">Arial</option><option value="Times New Roman, serif">Times</option><option value="Georgia, serif">Georgia</option><option value="Courier New, monospace">Courier</option></select>
                            <select class="toolbar-select" id="fontSize" onchange="execCmd('fontSize', this.value)"><option value="3">Normal</option><option value="1">Small</option><option value="5">Large</option><option value="7">X-Large</option></select>
                        </div>
                        <div class="toolbar-group">
                            <button type="button" class="toolbar-btn" onclick="execCmd('bold')" title="Bold"><b>B</b></button>
                            <button type="button" class="toolbar-btn" onclick="execCmd('italic')" title="Italic"><i>I</i></button>
                            <button type="button" class="toolbar-btn" onclick="execCmd('underline')" title="Underline"><u>U</u></button>
                            <button type="button" class="toolbar-btn" onclick="execCmd('strikeThrough')" title="Strikethrough"><s>S</s></button>
                        </div>
                        <div class="toolbar-group highlight-wrapper">
                            <button type="button" class="toolbar-btn" id="highlightBtn" onclick="toggleHighlightPicker(event)" title="Highlight"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9.53 16.122a3 3 0 00-5.78 1.128 2.25 2.25 0 01-2.4 2.245 4.5 4.5 0 008.4-2.245c0-.399-.078-.78-.22-1.128zm0 0a15.998 15.998 0 003.388-1.62m-5.043-.025a15.994 15.994 0 011.622-3.39m3.42 3.42a15.995 15.995 0 004.764-4.648l3.876-5.814a1.151 1.151 0 00-1.597-1.597L14.146 6.32a15.996 15.996 0 00-4.649 4.764m3.42 3.42a6.776 6.776 0 00-3.42-3.42"/></svg></button>
                            <div class="highlight-picker" id="highlightPicker">
                                <div class="highlight-color" style="background:#fef08a;" onclick="applyHighlight('#fef08a')" title="Yellow"></div>
                                <div class="highlight-color" style="background:#bbf7d0;" onclick="applyHighlight('#bbf7d0')" title="Green"></div>
                                <div class="highlight-color" style="background:#bfdbfe;" onclick="applyHighlight('#bfdbfe')" title="Blue"></div>
                                <div class="highlight-color" style="background:#fecaca;" onclick="applyHighlight('#fecaca')" title="Red"></div>
                                <div class="highlight-color" style="background:#e9d5ff;" onclick="applyHighlight('#e9d5ff')" title="Purple"></div>
                                <div class="highlight-color" style="background:#fed7aa;" onclick="applyHighlight('#fed7aa')" title="Orange"></div>
                                <div class="highlight-color" style="background:#fbcfe8;" onclick="applyHighlight('#fbcfe8')" title="Pink"></div>
                                <div class="highlight-color" style="background:#fff;border:1px solid #ccc;" onclick="removeHighlight()" title="Remove">âœ•</div>
                            </div>
                        </div>
                        <div class="toolbar-group">
                            <button type="button" class="toolbar-btn" onclick="execCmd('justifyLeft')" title="Align Left"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M3 12h12M3 18h18"/></svg></button>
                            <button type="button" class="toolbar-btn" onclick="execCmd('justifyCenter')" title="Center"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M6 12h12M3 18h18"/></svg></button>
                            <button type="button" class="toolbar-btn" onclick="execCmd('justifyRight')" title="Align Right"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M9 12h12M3 18h18"/></svg></button>
                            <button type="button" class="toolbar-btn" onclick="execCmd('justifyFull')" title="Justify"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M3 12h18M3 18h18"/></svg></button>
                        </div>
                        <div class="toolbar-group">
                            <button type="button" class="toolbar-btn" onclick="execCmd('insertUnorderedList')" title="Bullet List"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01"/></svg></button>
                            <button type="button" class="toolbar-btn" onclick="execCmd('insertOrderedList')" title="Numbered List"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 6h11M10 12h11M10 18h11M4 6h1v4M4 10h2M6 18H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg></button>
                        </div>
                    </div>
                    <div class="editor-content" id="noteContent" contenteditable="true" data-placeholder="Start writing your note..."></div>
                </div>
            </div>
            <div class="modal-footer"><div class="word-count" id="wordCount">0 words</div><div style="display:flex;gap:12px;"><button class="btn btn-secondary" onclick="closeNoteModal()">Cancel</button><button class="btn btn-save" onclick="saveNote()"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M5 13l4 4L19 7"/></svg>Save Note</button></div></div>
        </div>
    </div>

    <div class="modal-overlay" id="confirmModal">
        <div class="modal confirm-modal">
            <div class="modal-body"><div class="confirm-icon"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></div><h3>Delete Note?</h3><p>This action cannot be undone.</p><div class="confirm-actions"><button class="btn btn-secondary" onclick="closeConfirmModal()">Cancel</button><button class="btn btn-danger" onclick="confirmDelete()">Delete</button></div></div>
        </div>
    </div>

    <!-- All Notifications Modal -->
    <div class="modal-overlay" id="notificationsModal" onclick="if(event.target===this)closeNotificationsModal()">
        <div class="modal" style="max-width:500px;max-height:80vh;display:flex;flex-direction:column;">
            <div class="modal-header">
                <h3>All Notifications</h3>
                <button class="close-btn" onclick="closeNotificationsModal()"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12"/></svg></button>
            </div>
            <div class="modal-actions" style="display:flex;gap:10px;padding:0 24px 16px;border-bottom:1px solid var(--gray-200);">
                <button class="btn-secondary" onclick="markAllNotificationsReadModal()">Mark All Read</button>
                <button class="btn-danger" onclick="clearAllNotifications()">Clear All</button>
            </div>
            <div class="modal-body" id="allNotifList" style="flex:1;overflow-y:auto;padding:0;"></div>
        </div>
    </div>

    <div class="toast" id="toast"></div>
    <script>
        const SUPABASE_URL = 'https://weuxtwmaqmbhskjpjdyi.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndldXh0d21hcW1iaHNranBqZHlpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3NTYzMTcsImV4cCI6MjA4MDMzMjMxN30.J-0Nd0MY6-g_ltbBNHwOulqZuQfb8mKIRgx0dAaJ76o';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentUser = null, notes = [], notifications = [], currentNoteId = null, selectedColor = 'default', currentView = 'grid', currentFilter = null, deleteNoteId = null, savedSelection = null;

        async function init() {
            try {
                const { data: { session } } = await supabase.auth.getSession();
                if (!session) { window.location.href = 'index.html'; return; }
                currentUser = session.user;
            
            // Check if user is banned
            const { data: banProfile } = await supabase.from('profiles').select('is_banned').eq('id', currentUser.id).single();
            if (banProfile && banProfile.is_banned) {
                await supabase.auth.signOut();
                alert('Your account has been suspended. Please contact an administrator.');
                window.location.href = 'index.html';
                return;
            }
                
                // Initialize connection manager
                if (window.MyUBUtils) {
                    const canConnect = await MyUBUtils.ConnectionManager.init(supabase, currentUser.id);
                    if (!canConnect) {
                        document.getElementById('loadingScreen').style.display = 'none';
                        return;
                    }
                    MyUBUtils.SubscriptionManager.init(supabase, currentUser.id);
                    MyUBUtils.SubscriptionManager.subscribe({
                        messages: () => loadSidebarBadges(),
                        notifications: () => loadNotifications(),
                        friend_requests: () => loadSidebarBadges()
                    });
                }
                
                await updateOnlineStatus(true);
                await Promise.all([loadNotes(), loadNotifications(), loadSidebarBadges()]);
                setupRealtime(); // Setup real-time subscriptions
                startNotificationPolling(); // Poll for notifications as fallback
                setupEditor();
                if (localStorage.getItem('myub_darkMode') === 'true') document.body.classList.add('dark-mode');
                document.getElementById('loadingScreen').style.display = 'none';
            } catch (e) { console.error('Init error:', e); document.getElementById('loadingScreen').style.display = 'none'; }
        }
        
        function startNotificationPolling() {
            setInterval(async () => {
                const lastNotifId = notifications.length > 0 ? notifications[0].id : null;
                const { data: newNotifs } = await supabase.from('notifications').select('*').eq('user_id', currentUser.id).order('created_at', { ascending: false }).limit(5);
                if (newNotifs && newNotifs.length > 0 && (!lastNotifId || newNotifs[0].id !== lastNotifId)) {
                    const existingIds = notifications.map(n => n.id);
                    const trulyNew = newNotifs.filter(n => !existingIds.includes(n.id));
                    if (trulyNew.length > 0) {
                        trulyNew.forEach(n => notifications.unshift(n));
                        renderNotifications();
                        // Check for admin notifications
                        const adminTypes = ['announcement', 'admin_warning', 'warning', 'ban', 'admin_message', 'admin_urgent', 'admin_success'];
                        const adminNotif = trulyNew.find(n => adminTypes.includes(n.type));
                        if (adminNotif) {
                            showAdminPopup(adminNotif);
                        } else {
                            playNotificationSound();
                            showToast(trulyNew[0].title || 'New notification', 'success');
                        }
                    }
                }
            }, 30000);
        }

        async function updateOnlineStatus(isOnline) { try { await supabase.from('profiles').update({ is_online: isOnline, last_seen: new Date().toISOString() }).eq('id', currentUser.id); } catch (e) {} }

        async function loadNotes() {
            try {
                const { data, error } = await supabase.from('notes').select('*').eq('user_id', currentUser.id).order('is_pinned', { ascending: false }).order('updated_at', { ascending: false });
                if (error) throw error;
                notes = data || [];
                renderNotes();
            } catch (e) { console.error('Load notes error:', e); }
        }

        function renderNotes() {
            let filtered = notes.slice();
            const query = document.getElementById('searchInput').value.toLowerCase();
            if (query) filtered = filtered.filter(n => (n.title && n.title.toLowerCase().includes(query)) || (n.content && n.content.toLowerCase().includes(query)));
            if (currentFilter === 'pinned') filtered = filtered.filter(n => n.is_pinned);

            if (filtered.length === 0) { document.getElementById('emptyState').style.display = 'block'; document.getElementById('notesGrid').innerHTML = ''; document.getElementById('notesList').innerHTML = ''; return; }
            document.getElementById('emptyState').style.display = 'none';

            let gridHtml = '';
            filtered.forEach(note => {
                const preview = note.content ? stripHtml(note.content).substring(0, 150) : 'No content';
                const timeAgo = formatTimeAgo(note.updated_at);
                const colorClass = note.color && note.color !== 'default' ? 'color-' + note.color : '';
                gridHtml += '<div class="note-card ' + colorClass + '" onclick="openNoteModal(\'' + note.id + '\')">' +
                    '<div class="note-header"><div class="note-title">' + escapeHtml(note.title || 'Untitled') + '</div>' +
                    '<div class="note-actions">' +
                    '<button class="note-action-btn ' + (note.is_pinned ? 'pinned' : '') + '" onclick="event.stopPropagation();togglePin(\'' + note.id + '\')" title="Pin"><svg fill="' + (note.is_pinned ? 'currentColor' : 'none') + '" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/></svg></button>' +
                    '<button class="note-action-btn" onclick="event.stopPropagation();openDeleteConfirm(\'' + note.id + '\')" title="Delete"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button>' +
                    '</div></div>' +
                    '<div class="note-preview">' + escapeHtml(preview) + '</div>' +
                    '<div class="note-meta"><span></span><span>' + timeAgo + '</span></div></div>';
            });
            document.getElementById('notesGrid').innerHTML = gridHtml;

            let listHtml = '';
            filtered.forEach(note => {
                const preview = note.content ? stripHtml(note.content).substring(0, 80) : 'No content';
                const timeAgo = formatTimeAgo(note.updated_at);
                const colorClass = note.color && note.color !== 'default' ? 'color-' + note.color : '';
                listHtml += '<div class="note-list-item ' + colorClass + '" onclick="openNoteModal(\'' + note.id + '\')">' +
                    '<div class="note-list-content"><div class="note-list-title">' + escapeHtml(note.title || 'Untitled') + '</div><div class="note-list-preview">' + escapeHtml(preview) + '</div></div>' +
                    '<div class="note-list-meta">' +
                    (note.is_pinned ? '<svg class="pinned" fill="currentColor" viewBox="0 0 24 24" width="14" height="14"><path d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/></svg>' : '') +
                    '<span style="font-size:12px;color:var(--gray-400);">' + timeAgo + '</span></div></div>';
            });
            document.getElementById('notesList').innerHTML = listHtml;
        }

        function filterNotes() { renderNotes(); }
        function toggleFilter(filter) { if (currentFilter === filter) { currentFilter = null; document.getElementById(filter + 'Filter').classList.remove('active'); } else { if (currentFilter) document.getElementById(currentFilter + 'Filter').classList.remove('active'); currentFilter = filter; document.getElementById(filter + 'Filter').classList.add('active'); } renderNotes(); }
        function setView(view) { currentView = view; document.getElementById('gridViewBtn').classList.toggle('active', view === 'grid'); document.getElementById('listViewBtn').classList.toggle('active', view === 'list'); document.getElementById('notesGrid').classList.toggle('active', view === 'grid'); document.getElementById('notesList').classList.toggle('active', view === 'list'); }

        function openNoteModal(noteId) {
            currentNoteId = noteId || null;
            const title = document.getElementById('noteTitle'), content = document.getElementById('noteContent');
            if (noteId) { document.getElementById('modalTitle').textContent = 'Edit Note'; const note = notes.find(n => n.id === noteId); if (note) { title.value = note.title || ''; content.innerHTML = note.content || ''; selectColor(note.color || 'default'); } }
            else { document.getElementById('modalTitle').textContent = 'New Note'; title.value = ''; content.innerHTML = ''; selectColor('default'); }
            updateWordCount();
            document.getElementById('noteModal').classList.add('show');
            title.focus();
        }
        function closeNoteModal() { document.getElementById('noteModal').classList.remove('show'); currentNoteId = null; }
        function selectColor(color) { selectedColor = color; document.querySelectorAll('.color-option').forEach(o => o.classList.toggle('active', o.dataset.color === color)); }

        // ========== VALIDATION ==========
        const badWords = ['fuck', 'shit', 'ass', 'bitch', 'damn', 'crap', 'piss', 'dick', 'cock', 'pussy', 'asshole', 'bastard', 'slut', 'whore', 'nigger', 'nigga', 'fag', 'faggot', 'retard', 'cunt', 'twat', 'wanker', 'bollocks', 'arse', 'motherfucker', 'fucker'];
        function containsBadWords(text) { if (!text) return false; const lower = text.toLowerCase(); return badWords.some(word => new RegExp('\\b' + word + '\\b', 'i').test(lower)); }
        
        async function saveNote() {
            const title = document.getElementById('noteTitle').value.trim();
            const content = document.getElementById('noteContent').innerHTML;
            const textContent = stripHtml(content).trim();
            
            if (!title && !textContent) { showToast('Please add a title or content', 'error'); return; }
            
            // Validate title
            if (title && title.length > 200) { showToast('Title must be less than 200 characters', 'error'); return; }
            if (containsBadWords(title)) { showToast('Title contains inappropriate language', 'error'); return; }
            
            // Validate content
            if (textContent && textContent.length > 50000) { showToast('Content is too long', 'error'); return; }
            if (containsBadWords(textContent)) { showToast('Content contains inappropriate language', 'error'); return; }
            
            try {
                const noteData = { title: title || 'Untitled', content: content, color: selectedColor, updated_at: new Date().toISOString() };
                if (currentNoteId) { const { error } = await supabase.from('notes').update(noteData).eq('id', currentNoteId); if (error) throw error; showToast('Note updated!', 'success'); }
                else { noteData.user_id = currentUser.id; const { error } = await supabase.from('notes').insert(noteData); if (error) throw error; showToast('Note created!', 'success'); }
                closeNoteModal(); await loadNotes();
            } catch (e) { console.error('Save error:', e); showToast('Failed to save: ' + (e.message || e), 'error'); }
        }

        async function togglePin(noteId) { const note = notes.find(n => n.id === noteId); if (!note) return; try { await supabase.from('notes').update({ is_pinned: !note.is_pinned, updated_at: new Date().toISOString() }).eq('id', noteId); showToast(note.is_pinned ? 'Unpinned' : 'Pinned', 'success'); await loadNotes(); } catch (e) { showToast('Failed', 'error'); } }
        function openDeleteConfirm(noteId) { deleteNoteId = noteId; document.getElementById('confirmModal').classList.add('show'); }
        function closeConfirmModal() { document.getElementById('confirmModal').classList.remove('show'); deleteNoteId = null; }
        async function confirmDelete() { if (!deleteNoteId) return; try { await supabase.from('notes').delete().eq('id', deleteNoteId); showToast('Deleted', 'success'); closeConfirmModal(); await loadNotes(); } catch (e) { showToast('Failed', 'error'); } }

        // Rich Text Editor - Fixed highlight
        function execCmd(cmd, value) { document.execCommand(cmd, false, value || null); document.getElementById('noteContent').focus(); }
        
        function saveSelection() {
            const sel = window.getSelection();
            if (sel.rangeCount > 0) { savedSelection = sel.getRangeAt(0).cloneRange(); }
        }
        
        function restoreSelection() {
            if (savedSelection) {
                const sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(savedSelection);
            }
        }
        
        function toggleHighlightPicker(e) {
            e.stopPropagation();
            saveSelection();
            document.getElementById('highlightPicker').classList.toggle('show');
        }
        
        function applyHighlight(color) {
            restoreSelection();
            document.execCommand('hiliteColor', false, color);
            document.getElementById('highlightPicker').classList.remove('show');
            document.getElementById('noteContent').focus();
        }
        
        function removeHighlight() {
            restoreSelection();
            document.execCommand('hiliteColor', false, 'transparent');
            document.getElementById('highlightPicker').classList.remove('show');
            document.getElementById('noteContent').focus();
        }
        
        function setupEditor() {
            const editor = document.getElementById('noteContent');
            editor.addEventListener('input', updateWordCount);
            editor.addEventListener('mouseup', saveSelection);
            editor.addEventListener('keyup', saveSelection);
            editor.addEventListener('keydown', e => { if (e.key === 'Tab') { e.preventDefault(); document.execCommand('insertText', false, '    '); } });
            document.addEventListener('click', e => { const picker = document.getElementById('highlightPicker'), btn = document.getElementById('highlightBtn'); if (!picker.contains(e.target) && !btn.contains(e.target)) picker.classList.remove('show'); });
        }
        function updateWordCount() { const text = document.getElementById('noteContent').innerText || ''; const words = text.trim().split(/\s+/).filter(w => w.length > 0).length; document.getElementById('wordCount').textContent = words + ' word' + (words !== 1 ? 's' : ''); }

        // Notifications with consistent styling
        async function loadNotifications() { try { const { data } = await supabase.from('notifications').select('*').eq('user_id', currentUser.id).order('created_at', { ascending: false }).limit(20); notifications = data || []; renderNotifications(); checkAnnouncementPopup(); } catch (e) {} }
        
        function checkAnnouncementPopup() {
            const adminTypes = ['announcement', 'admin_warning', 'warning', 'ban', 'admin_message'];
            const unreadAdmin = notifications.filter(n => adminTypes.includes(n.type) && !n.is_read);
            if (unreadAdmin.length > 0) showAdminPopup(unreadAdmin[0]);
        }
        
        function showAdminPopup(notification) {
            if (document.querySelector('.announcement-overlay')) return;
            const timeAgo = formatTimeAgo(notification.created_at);
            const type = notification.type || 'announcement';
            let config = { label: 'ðŸ“¢ Admin Announcement', iconBg: 'linear-gradient(135deg, #f97316 0%, #ea580c 100%)', iconShadow: 'rgba(249, 115, 22, 0.4)', icon: '<path d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"/>', headerBg: 'linear-gradient(135deg, #1a365d 0%, #2c5282 100%)', labelColor: '#f97316' };
            if (type === 'admin_warning' || type === 'warning') { config = { label: 'âš ï¸ Admin Warning', iconBg: 'linear-gradient(135deg, #eab308 0%, #ca8a04 100%)', iconShadow: 'rgba(234, 179, 8, 0.4)', icon: '<path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>', headerBg: 'linear-gradient(135deg, #854d0e 0%, #a16207 100%)', labelColor: '#fde047' }; }
            else if (type === 'ban') { config = { label: 'ðŸš« Account Suspended', iconBg: 'linear-gradient(135deg, #dc2626 0%, #b91c1c 100%)', iconShadow: 'rgba(220, 38, 38, 0.4)', icon: '<path d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"/>', headerBg: 'linear-gradient(135deg, #991b1b 0%, #b91c1c 100%)', labelColor: '#fca5a5' }; }
            const overlay = document.createElement('div');
            overlay.className = 'announcement-overlay';
            overlay.innerHTML = `<div class="announcement-popup" style="background: ${config.headerBg};"><div class="announcement-header"><div class="announcement-icon" style="background: ${config.iconBg}; box-shadow: 0 4px 12px ${config.iconShadow};"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">${config.icon}</svg></div><div class="announcement-header-text"><div class="announcement-label" style="color: ${config.labelColor};">${config.label}</div><div class="announcement-title">${escapeHtml(notification.title)}</div></div></div><div class="announcement-body"><div class="announcement-message">${escapeHtml(notificatiodisplayBody)}</div><div class="announcement-time"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>${timeAgo}</div></div><div class="announcement-footer"><button class="announcement-btn" onclick="dismissAnnouncement('${notification.id}')"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M5 13l4 4L19 7"/></svg>I Understand</button></div></div>`;
            document.body.appendChild(overlay);
            playNotificationSound();
        }
        
        function showGroupNotificationPopup(notification) {
            const existing = document.querySelector('.group-notif-popup');
            if (existing) existing.remove();
            const type = notification.type;
            const title = notification.title || '';
            let config = { icon: 'ðŸ‘¥', bgColor: 'linear-gradient(135deg, #1e40af 0%, #3b82f6 100%)' };
            const isJoinRequest = title.includes('Join Request');
            const isAccepted = title.includes('Accepted') || title.includes('Added to Group');
            const isDeclined = title.includes('Declined');
            const isMemberJoined = title.includes('New Member');
            
            if (isJoinRequest) { config = { icon: 'ðŸ””', bgColor: 'linear-gradient(135deg, #d97706 0%, #f59e0b 100%)' }; }
            else if (type === 'group_added' || type === 'group_request_accepted') { config = { icon: 'ðŸŽ‰', bgColor: 'linear-gradient(135deg, #16a34a 0%, #22c55e 100%)' }; }
            else if (type === 'group_request_declined') { config = { icon: 'ðŸ˜”', bgColor: 'linear-gradient(135deg, #dc2626 0%, #ef4444 100%)' }; }
            else if (type === 'group_member_joined') { config = { icon: 'ðŸ‘‹', bgColor: 'linear-gradient(135deg, #7c3aed 0%, #8b5cf6 100%)' }; }
            const bodyText = notification.body || notification.message || '';
            const displayBody = bodyText.replace(/\s*\[REF:[^\]]+\]/, '').replace(/\s*\[GROUP:[^\]]+\]/, '');
            const popup = document.createElement('div');
            popup.className = 'group-notif-popup';
            popup.style.cssText = `position:fixed;top:20px;right:20px;background:${config.bgColor};color:#fff;padding:16px 20px;border-radius:16px;box-shadow:0 8px 32px rgba(0,0,0,0.25);z-index:10000;max-width:350px;animation:slideInRight 0.4s cubic-bezier(0.34,1.56,0.64,1);`;
            let html = `<div style="display:flex;align-items:flex-start;gap:12px;"><div style="font-size:28px;line-height:1;">${config.icon}</div><div style="flex:1;min-width:0;"><div style="font-weight:600;font-size:15px;margin-bottom:4px;">${escapeHtml(notification.title)}</div><div style="font-size:13px;opacity:0.9;line-height:1.4;">${escapeHtml(displayBody)}</div>`;
            if (isJoinRequest) {
                html += `<div style="display:flex;gap:8px;margin-top:12px;"><button onclick="window.location.href='study-groups.html?notif=${notification.id}'" style="flex:1;padding:8px 12px;background:#22c55e;color:#fff;border:none;border-radius:8px;font-weight:600;font-size:13px;cursor:pointer;">View Request</button><button onclick="this.closest('.group-notif-popup').remove()" style="flex:1;padding:8px 12px;background:rgba(255,255,255,0.2);color:#fff;border:none;border-radius:8px;font-weight:600;font-size:13px;cursor:pointer;">Dismiss</button></div>`;
            }
            html += `</div><button onclick="this.parentElement.parentElement.remove()" style="background:rgba(255,255,255,0.2);border:none;color:#fff;width:24px;height:24px;border-radius:50%;cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;">Ã—</button></div>`;
            popup.innerHTML = html;
            document.body.appendChild(popup);
            if (!isJoinRequest) { setTimeout(() => { if (popup.parentElement) { popup.style.animation = 'slideInRight 0.3s ease reverse'; setTimeout(() => popup.remove(), 300); } }, 8000); }
        }
        
        async function dismissAnnouncement(announcementId) {
            const notification = (typeof notificationsList !== 'undefined' ? notificationsList : notifications).find(n => n.id === announcementId);
            const isBan = notification && notification.type === 'ban';
            await supabase.from('notifications').update({ is_read: true }).eq('id', announcementId);
            const idx = notifications.findIndex(n => n.id === announcementId);
            if (idx !== -1) notifications[idx].is_read = true;
            const overlay = document.querySelector('.announcement-overlay');
            if (overlay) { overlay.style.animation = 'fadeIn 0.3s ease reverse'; setTimeout(() => overlay.remove(), 300); }
            if (isBan) { await supabase.auth.signOut(); window.location.href = 'index.html'; return; }
            renderNotifications();
            setTimeout(checkAnnouncementPopup, 500);
        }
        function renderNotifications() {
            const list = document.getElementById('notifList'), badge = document.getElementById('notifBadge');
            const unread = notifications.filter(n => !n.is_read).length;
            if (unread > 0) { badge.textContent = unread > 9 ? '9+' : unread; badge.style.display = 'flex'; } else { badge.style.display = 'none'; }
            if (notifications.length === 0) { list.innerHTML = '<div class="notif-empty"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/></svg><p>No notifications</p></div>'; return; }
            list.innerHTML = notifications.map(n => {
                const type = n.type || '';
                const iconClass = type.includes('friend') ? 'friend' : type.includes('message') ? 'message' : type.includes('warning') ? 'warning' : 'group';
                const iconSvg = iconClass === 'friend' ? '<path d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/>' : iconClass === 'message' ? '<path d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>' : '<path d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/>';
                const displayBody = (n.body||'').replace(/\s*\[REF:[^\]]+\]/, '').replace(/\s*\[GROUP:[^\]]+\]/, '');
                return '<div class="notif-dropdown-item ' + (n.is_read ? '' : 'unread') + '" onclick="handleNotifClick(\'' + n.id + '\',\'' + type + '\')"><div class="notif-icon ' + iconClass + '"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">' + iconSvg + '</svg></div><div class="notif-content"><h4>' + escapeHtml(n.title || 'Notification') + '</h4><p>' + escapeHtml(displayBody) + '</p><div class="time">' + formatTimeAgo(n.created_at) + '</div></div></div>';
            }).join('');
        }
        async function handleNotifClick(id, type) { await supabase.from('notifications').update({ is_read: true }).eq('id', id); const n = notifications.find(x => x.id === id); if (n) n.is_read = true; renderNotifications(); document.getElementById('notifDropdown').classList.remove('show'); if (type.includes('friend')) window.location.href = 'friends.html'; else if (type.includes('message')) window.location.href = 'messages.html'; else if (type.includes('group')) window.location.href = 'study-groups.html?notif=' + id; }
        async function markAllRead() { await supabase.from('notifications').update({ is_read: true }).eq('user_id', currentUser.id); notifications.forEach(n => n.is_read = true); renderNotifications(); showToast('Marked all as read'); }
        function toggleNotifications(e) { e.stopPropagation(); document.getElementById('notifDropdown').classList.toggle('show'); }

        async function loadSidebarBadges() {
            try { const { count: msgCount } = await supabase.from('messages').select('*', { count: 'exact', head: true }).eq('receiver_id', currentUser.id).eq('is_read', false); const msgBadge = document.getElementById('sidebarMsgBadge'); if (msgCount > 0) { msgBadge.style.display = 'inline'; msgBadge.textContent = msgCount > 9 ? '9+' : msgCount; } else msgBadge.style.display = 'none'; } catch (e) {}
            try { const { count: frCount } = await supabase.from('friend_requests').select('*', { count: 'exact', head: true }).eq('receiver_id', currentUser.id).eq('status', 'pending'); const frBadge = document.getElementById('sidebarFriendsBadge'); if (frCount > 0) { frBadge.style.display = 'inline'; frBadge.textContent = frCount > 9 ? '9+' : frCount; } else frBadge.style.display = 'none'; } catch (e) {}
        }

        function setupRealtime() {
            supabase.channel('notes_changes_' + currentUser.id).on('postgres_changes', { event: '*', schema: 'public', table: 'notes', filter: 'user_id=eq.' + currentUser.id }, () => loadNotes()).subscribe();
            supabase.channel('notifications_changes_' + currentUser.id).on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'notifications', filter: 'user_id=eq.' + currentUser.id }, async (p) => { 
                console.log('Notes: New notification received:', p);
                notifications.unshift(p.new); 
                const isBan = p.new.type === 'ban';
                if (isBan) { await supabase.auth.signOut(); window.location.href = 'index.html'; return; }
                renderNotifications();
                const adminTypes = ['announcement', 'admin_warning', 'warning', 'ban', 'admin_message', 'admin_urgent', 'admin_success'];
                const groupNotifTypes = ['group_join_request', 'group_added', 'group_request_accepted', 'group_request_declined', 'group_member_joined'];
                if (adminTypes.includes(p.new.type)) {
                    showAdminPopup(p.new);
                } else if (p.new.type === 'group') {
                    showGroupNotificationPopup(p.new);
                    playNotificationSound();
                } else {
                    playNotificationSound(); 
                    showToast(p.new.title || 'New notification', 'success');
                }
            }).subscribe((status) => console.log('Notes notification subscription:', status));
            supabase.channel('messages_badge_' + currentUser.id).on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages', filter: 'receiver_id=eq.' + currentUser.id }, () => loadSidebarBadges()).subscribe();
            supabase.channel('friend_requests_badge_' + currentUser.id).on('postgres_changes', { event: '*', schema: 'public', table: 'friend_requests' }, () => loadSidebarBadges()).subscribe();
            
            // Friend online status - show toast when friends come online
            supabase.channel('friends_online_status_' + currentUser.id).on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'profiles' }, async (p) => {
                if (p.new.is_online && !p.old?.is_online) {
                    // Check if this person is a friend
                    const { data: friendship } = await supabase.from('friendships').select('*').or(`user_id.eq.${currentUser.id},friend_id.eq.${currentUser.id}`).or(`user_id.eq.${p.new.id},friend_id.eq.${p.new.id}`).maybeSingle();
                    if (friendship) {
                        const name = p.new.full_name || p.new.first_name || 'A friend';
                        showFriendOnlineToast(name);
                    }
                }
            }).subscribe();
        }
        function playNotificationSound() { try { const ctx = new (window.AudioContext || window.webkitAudioContext)(); const osc = ctx.createOscillator(); const gain = ctx.createGain(); osc.connect(gain); gain.connect(ctx.destination); osc.frequency.value = 800; osc.type = 'sine'; gain.gain.setValueAtTime(0.1, ctx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3); osc.start(ctx.currentTime); osc.stop(ctx.currentTime + 0.3); } catch (e) {} }
        
        function showFriendOnlineToast(friendName) {
            const existing = document.querySelector('.friend-online-toast');
            if (existing) existing.remove();
            const toast = document.createElement('div');
            toast.className = 'friend-online-toast';
            toast.innerHTML = '<div style="width:10px;height:10px;background:#22c55e;border-radius:50%;animation:pulse 1s infinite;"></div><span><strong>' + escapeHtml(friendName) + '</strong> is now online</span>';
            toast.style.cssText = 'position:fixed;top:80px;right:20px;background:linear-gradient(135deg,#065f46,#047857);color:white;padding:14px 20px;border-radius:12px;display:flex;align-items:center;gap:12px;z-index:9999;animation:slideInRight 0.3s ease;box-shadow:0 4px 20px rgba(4,120,87,0.4);font-size:14px;';
            if (!document.getElementById('friendToastStyles')) {
                const style = document.createElement('style');
                style.id = 'friendToastStyles';
                style.textContent = '@keyframes slideInRight{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}';
                document.head.appendChild(style);
            }
            document.body.appendChild(toast);
            playNotificationSound();
            setTimeout(() => { toast.style.animation = 'slideInRight 0.3s ease reverse'; setTimeout(() => toast.remove(), 300); }, 4000);
        }

        function escapeHtml(t) { if (!t) return ''; const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }
        function stripHtml(h) { const t = document.createElement('div'); t.innerHTML = h; return t.textContent || t.innerText || ''; }
        function formatTimeAgo(d) { if (!d) return ''; const diff = Math.floor((new Date() - new Date(d)) / 1000); if (diff < 60) return 'Just now'; if (diff < 3600) return Math.floor(diff / 60) + 'm ago'; if (diff < 86400) return Math.floor(diff / 3600) + 'h ago'; if (diff < 604800) return Math.floor(diff / 86400) + 'd ago'; return new Date(d).toLocaleDateString(); }
        function showToast(msg, type) { const t = document.getElementById('toast'); t.textContent = msg; t.className = 'toast ' + (type || '') + ' show'; setTimeout(() => t.classList.remove('show'), 3000); }
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); document.getElementById('sidebarOverlay').classList.toggle('show'); }
        function closeSidebar() { document.getElementById('sidebar').classList.remove('open'); document.getElementById('sidebarOverlay').classList.remove('show'); }
        async function logout() { await updateOnlineStatus(false); await supabase.auth.signOut(); window.location.href = 'index.html'; }

        // All Notifications Modal
        async function openNotificationsModal() {
            document.getElementById('notifDropdown').classList.remove('show');
            document.getElementById('notificationsModal').classList.add('show');
            await loadAllNotifications();
        }
        function closeNotificationsModal() { document.getElementById('notificationsModal').classList.remove('show'); }
        
        async function loadAllNotifications() {
            const { data } = await supabase.from('notifications').select('*').eq('user_id', currentUser.id).order('created_at', { ascending: false }).limit(100);
            const allNotifs = data || [];
            const list = document.getElementById('allNotifList');
            if (allNotifs.length === 0) {
                list.innerHTML = '<div class="notif-empty"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/></svg><p>No notifications</p></div>';
                return;
            }
            list.innerHTML = allNotifs.map(n => {
                const type = n.type || '';
                const iconClass = type.includes('friend') ? 'friend' : type.includes('message') ? 'message' : type.includes('warning') ? 'warning' : 'group';
                const iconSvg = iconClass === 'friend' ? '<path d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/>' : iconClass === 'message' ? '<path d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>' : '<path d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/>';
                return '<div class="notif-dropdown-item ' + (n.is_read ? '' : 'unread') + '" onclick="handleNotifClickModal(\'' + n.id + '\',\'' + type + '\')"><div class="notif-icon ' + iconClass + '"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">' + iconSvg + '</svg></div><div class="notif-content"><h4>' + escapeHtml(n.title || 'Notification') + '</h4><p>' + escapeHtml(displayBody) + '</p><div class="time">' + formatTimeAgo(n.created_at) + '</div></div></div>';
            }).join('');
        }
        
        async function handleNotifClickModal(id, type) {
            await supabase.from('notifications').update({ is_read: true }).eq('id', id);
            closeNotificationsModal();
            if (type.includes('friend')) window.location.href = 'friends.html';
            else if (type.includes('message')) window.location.href = 'messages.html';
            else if (type.includes('group')) window.location.href = 'study-groups.html';
        }
        
        async function markAllNotificationsReadModal() {
            await supabase.from('notifications').update({ is_read: true }).eq('user_id', currentUser.id);
            notifications.forEach(n => n.is_read = true);
            renderNotifications();
            await loadAllNotifications();
            showToast('All notifications marked as read', 'success');
        }
        
        async function clearAllNotifications() {
            if (!confirm('Are you sure you want to clear all notifications? This cannot be undone.')) return;
            const { error } = await supabase.from('notifications').delete().eq('user_id', currentUser.id); 
            if (error) { console.error('Delete failed:', error); showToast('Failed to clear. Check database permissions.', 'error'); return; }
            notifications = [];
            renderNotifications();
            loadAllNotifications();
            closeNotificationsModal();
            showToast('All notifications cleared', 'success');
        }

        document.addEventListener('click', e => { const dd = document.getElementById('notifDropdown'), btn = document.querySelector('.notif-btn'); if (!dd.contains(e.target) && !btn.contains(e.target)) dd.classList.remove('show'); });
        document.addEventListener('DOMContentLoaded', init);
        window.addEventListener('beforeunload', () => updateOnlineStatus(false));
    </script>
</body>
</html>
